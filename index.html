<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SPEI Ops - Gestión Operativa</title>
    
    <!-- Metadatos PWA -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SPEI Ops">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2830/2830284.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Librerías de Apoyo -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- MathJax para Fórmulas Matemáticas -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true
            },
            options: { enableMenu: false }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, onSnapshot, updateDoc, deleteDoc, getDoc, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDPi5pcDL6OL2zCJK_0n3A_RdDGt3U3LVQ",
            authDomain: "chatbot-8d0a3.firebaseapp.com",
            projectId: "chatbot-8d0a3",
            storageBucket: "chatbot-8d0a3.firebasestorage.app",
            messagingSenderId: "390359131739",
            appId: "1:390359131739:web:23373d0ba69b4719bb417e"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = "chatbot-8d0a3"; 

        window.fb = { auth, db, appId, doc, setDoc, getDoc, collection, onSnapshot, updateDoc, deleteDoc, query, signInAnonymously, onAuthStateChanged };
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        html, body {
            height: 100dvh; width: 100vw;
            background-color: #0f172a;
            font-family: 'Plus Jakarta Sans', sans-serif;
            overflow: hidden;
            position: fixed;
        }

        .app-shell {
            width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
            padding: 1rem;
        }

        .app-container {
            width: 100%;
            max-width: 64rem; /* Daniel: Ancho aumentado para aprovechar toda la pantalla en PC */
            height: 100%;
            display: flex;
            flex-direction: column;
            background: #f8fafc;
            position: relative;
            border-radius: 2rem;
            box-shadow: 0 30px 60px -12px rgba(0, 0, 0, 0.7);
            overflow: hidden;
        }

        @media (max-width: 1024px) { 
            .app-container { max-width: 100%; border-radius: 0; } 
            .app-shell { padding: 0; } 
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            background-image: radial-gradient(#e2e8f0 1.2px, transparent 1.2px);
            background-size: 24px 24px;
        }

        .overlay {
            position: fixed; inset: 0; z-index: 9999;
            display: flex; align-items: center; justify-content: center;
            flex-direction: column; color: white; padding: 2rem;
            background: #0f172a;
        }

        .hidden-ui { display: none !important; }
        .user-bubble { box-shadow: 0 4px 15px -3px rgba(37, 99, 235, 0.4); }
        .bot-bubble { border: 1px solid #f1f5f9; box-shadow: 0 4px 12px -1px rgba(0, 0, 0, 0.05); }
        
        .tab-btn.active { color: #3b82f6; border-bottom: 3px solid #3b82f6; }
        
        .mjx-container { 
            overflow-x: auto; 
            max-width: 100%; 
            padding: 1rem 0;
            display: block !important;
        }

        /* Estilo para los títulos con iconos que reemplazan a ### */
        .bot-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 800;
            color: #0f172a;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            font-size: 1.15rem;
            border-bottom: 2px solid #3b82f6;
            padding-bottom: 0.4rem;
        }

        #toast {
            position: fixed; top: 1.5rem; left: 50%; transform: translateX(-50%);
            z-index: 10001; padding: 0.8rem 1.5rem; border-radius: 1rem;
            font-size: 0.75rem; font-weight: 800; text-transform: uppercase;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            transition: all 0.3s ease; opacity: 0; pointer-events: none;
        }
        #toast.show { opacity: 1; top: 2.5rem; }

        .manual-text {
            white-space: pre-wrap;
            line-height: 1.7;
        }
    </style>
</head>
<body>

    <div id="toast"></div>

    <div class="app-shell">
        <!-- Pantalla de Carga Inicial -->
        <div id="loading-overlay" class="overlay">
            <div class="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-6"></div>
            <p id="loading-text" class="text-[10px] font-black uppercase tracking-[0.4em] text-slate-400 text-center">Iniciando SPEI Ops Cloud...</p>
        </div>

        <!-- Pantalla de Login -->
        <div id="lock-screen" class="overlay hidden-ui">
            <div class="w-20 h-20 bg-blue-600 rounded-[2.2rem] mb-8 flex items-center justify-center shadow-2xl">
                <i class="fas fa-fingerprint text-3xl text-white"></i>
            </div>
            <h2 class="text-3xl font-black mb-1">SPEI Ops</h2>
            <p class="text-slate-400 text-sm mb-10 text-center font-medium uppercase tracking-[0.2em]">Operación Pagos Electrónicos</p>
            
            <div class="w-full max-w-[280px] space-y-4">
                <input type="text" id="emp-number-input" placeholder="No. de Empleado" 
                    class="w-full bg-white/5 border border-white/10 rounded-2xl py-4 text-center text-xl font-bold text-white outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                <button id="login-btn" class="w-full bg-blue-600 hover:bg-blue-700 py-4 rounded-2xl font-black text-lg shadow-xl active:scale-95 transition-all text-white disabled:opacity-50" disabled>
                    INGRESAR
                </button>
                <p id="error-emp" class="text-red-400 text-[9px] text-center opacity-0 font-black tracking-widest uppercase">Número no autorizado</p>
            </div>
        </div>

        <!-- Contenedor Principal de la App -->
        <div class="app-container blur-md shadow-2xl" id="app-content">
            <header class="bg-slate-900 text-white p-6 pt-10 shadow-xl flex items-center justify-between shrink-0">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 bg-white/10 rounded-2xl flex items-center justify-center border border-white/10 shadow-inner">
                        <i class="fas fa-university text-blue-400 text-xl"></i>
                    </div>
                    <div>
                        <h1 class="font-extrabold text-lg tracking-tight leading-none mb-1 text-white">SPEI Ops</h1>
                        <div class="flex items-center gap-1.5">
                            <div class="w-1.5 h-1.5 bg-emerald-500 rounded-full animate-pulse"></div>
                            <span class="text-[9px] font-black uppercase tracking-widest text-slate-400">Soporte Activo</span>
                        </div>
                    </div>
                </div>
                
                <div id="admin-controls" class="hidden flex items-center gap-4 text-white">
                    <button id="open-settings-btn" class="w-10 h-10 bg-white/10 rounded-xl flex items-center justify-center border border-white/10 hover:bg-white/20 transition-all"><i class="fas fa-tools text-sm"></i></button>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="mode-toggle" class="sr-only peer">
                        <div class="w-10 h-5 bg-slate-700 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-emerald-500"></div>
                    </label>
                </div>
            </header>

            <main id="chat-box" class="chat-container"></main>

            <footer class="bg-white p-6 border-t border-slate-100 shrink-0 pb-12">
                <div id="suggestions" class="flex flex-wrap gap-2 mb-4"></div>
                <form id="chat-form" class="flex gap-4 items-center">
                    <div class="flex-1 bg-slate-100 rounded-3xl flex items-center px-6 border border-transparent focus-within:bg-white focus-within:ring-2 focus-within:ring-blue-500 transition-all shadow-inner">
                        <input type="text" id="user-input" placeholder="Realiza una consulta técnica..." class="w-full bg-transparent border-none py-4 text-sm font-semibold outline-none" autocomplete="off">
                    </div>
                    <button type="submit" class="bg-blue-600 text-white w-14 h-14 rounded-2xl flex items-center justify-center shadow-lg shadow-blue-200 active:scale-90 transition-all">
                        <i class="fas fa-paper-plane text-lg"></i>
                    </button>
                </form>
                <div class="flex justify-between items-center mt-6">
                    <p id="footer-username" class="text-[10px] font-black text-slate-400 uppercase tracking-widest italic">Iniciando sesión...</p>
                    <button id="logout-btn" class="text-[10px] font-black text-slate-400 uppercase underline hover:text-red-500 transition-colors">Salir del Sistema</button>
                </div>
            </footer>
        </div>

        <!-- Modal de Administración -->
        <div id="settings-modal" class="hidden-ui system-overlay overlay" style="z-index: 10005;">
            <div class="w-full max-w-5xl bg-white p-8 rounded-[3rem] shadow-2xl flex flex-col max-h-[92vh]">
                <div class="flex justify-between items-center mb-8 text-slate-800">
                    <h2 class="text-2xl font-black uppercase italic">Administración de Conocimiento</h2>
                    <button id="close-settings-btn" class="bg-slate-100 p-3 rounded-full text-slate-400 hover:bg-slate-200 transition-all"><i class="fas fa-times text-lg"></i></button>
                </div>
                
                <div class="flex gap-8 border-b border-slate-100 mb-8">
                    <button id="tab-kb-btn" class="tab-btn active pb-3 text-xs font-black uppercase tracking-widest text-slate-400">Base de Manuales</button>
                    <button id="tab-users-btn" class="tab-btn pb-3 text-xs font-black uppercase tracking-widest text-slate-400">Equipo Autorizado</button>
                </div>
                
                <div class="overflow-y-auto flex-1 space-y-6 px-2">
                    <div id="tab-kb">
                        <div class="bg-slate-50 p-6 rounded-3xl space-y-4 mb-8 border border-slate-200 shadow-sm">
                            <div class="flex flex-wrap gap-4">
                                <select id="entry-category" class="bg-white border border-slate-200 rounded-xl px-4 py-3 text-xs font-bold outline-none flex-1 min-w-[180px] text-slate-700">
                                    <option value="Procesos">Categoría: Procesos</option>
                                    <option value="Servidores">Categoría: Servidores</option>
                                    <option value="Seguridad">Categoría: Seguridad</option>
                                    <option value="Contactos">Categoría: Contactos</option>
                                    <option value="Codi">Categoría: CoDi</option>
                                </select>
                                <input type="text" id="entry-title" placeholder="Título del procedimiento..." class="flex-[2] min-w-[280px] bg-white border border-slate-200 rounded-xl px-4 py-3 text-sm font-bold outline-none text-slate-800">
                            </div>
                            <textarea id="entry-content" placeholder="Escribe aquí toda la información técnica..." class="w-full h-56 bg-white border border-slate-200 rounded-xl p-5 text-sm font-medium outline-none text-slate-700 leading-relaxed"></textarea>
                            <div class="flex gap-4">
                                <input type="hidden" id="editing-id">
                                <button id="save-entry-btn" class="flex-1 bg-emerald-600 text-white py-4 rounded-2xl font-black text-xs shadow-lg uppercase tracking-widest hover:bg-emerald-700 transition-all">Guardar Manual</button>
                                <button id="file-trigger" class="bg-slate-800 text-white px-8 rounded-2xl hover:bg-slate-700 transition-colors"><i class="fas fa-file-import text-lg"></i></button>
                                <input type="file" id="file-selector" class="hidden" multiple accept=".pdf,.xlsx,.txt">
                            </div>
                        </div>
                        <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest mb-4 px-2">Manuales Registrados</h3>
                        <div id="knowledge-list" class="space-y-4"></div>
                    </div>
                    
                    <div id="tab-users" class="hidden">
                        <div class="bg-blue-50 p-6 rounded-3xl space-y-4 mb-8 border border-blue-100 shadow-sm">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <input type="text" id="new-user-name" placeholder="Nombre completo" class="w-full p-4 rounded-2xl text-sm font-bold border border-blue-100 text-slate-800 outline-none">
                                <input type="text" id="new-user-id" placeholder="No. Empleado" class="w-full p-4 rounded-2xl text-sm font-bold border border-blue-100 text-slate-800 outline-none">
                            </div>
                            <div class="flex gap-4">
                                <select id="new-user-role" class="flex-1 p-4 rounded-2xl text-sm font-bold border border-blue-100 bg-white text-slate-600 outline-none">
                                    <option value="user">Rol: Usuario Operativo</option>
                                    <option value="admin">Rol: Administrador Maestro</option>
                                </select>
                                <button id="add-user-btn" class="flex-[2] bg-blue-600 text-white py-4 rounded-2xl font-black text-xs shadow-lg uppercase tracking-widest hover:bg-blue-700 transition-all">Autorizar Acceso</button>
                            </div>
                        </div>
                        <div id="user-registry-list" class="space-y-3"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Aviso Inactividad -->
        <div id="timeout-modal" class="overlay hidden-ui" style="background: rgba(15, 23, 42, 0.98); backdrop-filter: blur(15px); z-index: 10000;">
            <div class="w-full max-w-sm bg-white p-10 rounded-[3rem] shadow-2xl text-center text-slate-800">
                <h3 class="text-2xl font-black mb-3 italic text-blue-600">¿Sigues ahí?</h3>
                <p class="text-sm text-slate-500 mb-10 font-medium text-center">Por seguridad, tu sesión cerrará pronto por inactividad.</p>
                <div class="flex gap-3">
                    <button id="timeout-logout-btn" class="flex-1 bg-slate-100 text-slate-500 py-4 rounded-2xl font-bold text-sm">SALIR</button>
                    <button id="timeout-extend-btn" class="flex-[2] bg-blue-600 text-white py-4 rounded-2xl font-bold text-sm shadow-lg uppercase tracking-widest">Continuar</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Gemini API Key de Daniel
        const apiKey = "AIzaSyAZBbCOgKN68qFX2ab_cegWOeV0lHAtMpA"; 
        
        const SESSION_LIMIT = 5 * 60 * 1000;
        const WARNING_LIMIT = 30 * 1000;

        let inactivityTimer, warningTimer, currentUser, isInternalMode = false;
        let knowledgeBase = [], employeeRegistry = [];
        let chatHistory = [], isDataLoaded = false;

        const { auth, db, appId, doc, setDoc, collection, onSnapshot, updateDoc, deleteDoc, getDoc, signInAnonymously, onAuthStateChanged } = window.fb;

        function notify(msg, isError = false) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.className = `show ${isError ? 'bg-red-600 text-white' : 'bg-emerald-600 text-white'}`;
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        async function initApp() {
            try {
                await signInAnonymously(auth);
                onAuthStateChanged(auth, async (user) => {
                    if (!user) return;

                    onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'knowledge'), (snap) => {
                        knowledgeBase = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                        renderEntries();
                    });

                    onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'team'), (snap) => {
                        employeeRegistry = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                        if (employeeRegistry.length === 0) seedAdmin();
                        
                        if (!isDataLoaded) {
                            isDataLoaded = true;
                            const btn = document.getElementById('login-btn');
                            btn.innerText = "INGRESAR AL SISTEMA";
                            btn.disabled = false;

                            const saved = localStorage.getItem('spei_ops_prod_vfinal_x1');
                            if (saved) {
                                const savedUser = JSON.parse(saved);
                                const updated = employeeRegistry.find(u => u.empNumber === savedUser.empNumber);
                                if (updated) { currentUser = updated; enterApp(); } else { logout(); }
                            } else {
                                document.getElementById('loading-overlay').classList.add('hidden-ui');
                                document.getElementById('lock-screen').classList.remove('hidden-ui');
                            }
                        } else if (currentUser) {
                            const updated = employeeRegistry.find(u => u.empNumber === currentUser.empNumber);
                            if (updated) currentUser = updated;
                        }
                        renderUsers();
                    });
                });
            } catch (err) { notify("Error de red", true); }
        }

        async function seedAdmin() {
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'team', '682930'), {
                name: "Daniel Anzaldo", empNumber: "682930", role: "admin", queries: 0
            }, { merge: true });
        }

        function enterApp() {
            document.getElementById('loading-overlay').classList.add('hidden-ui');
            document.getElementById('lock-screen').classList.add('hidden-ui');
            document.getElementById('app-content').classList.remove('blur-md');
            document.getElementById('footer-username').innerText = currentUser.name;
            if (currentUser.role === 'admin') document.getElementById('admin-controls').classList.remove('hidden');
            resetInactivityTimer();
        }

        function logout() {
            localStorage.removeItem('spei_ops_prod_vfinal_x1');
            location.reload();
        }

        function resetInactivityTimer() {
            if (!currentUser) return;
            clearTimeout(inactivityTimer);
            clearTimeout(warningTimer);
            document.getElementById('timeout-modal').classList.add('hidden-ui');
            inactivityTimer = setTimeout(() => {
                document.getElementById('timeout-modal').classList.remove('hidden-ui');
                warningTimer = setTimeout(logout, WARNING_LIMIT);
            }, SESSION_LIMIT);
        }

        document.getElementById('login-btn').onclick = async () => {
            const input = document.getElementById('emp-number-input').value.trim();
            if (input === "682930") await seedAdmin();
            const user = employeeRegistry.find(u => u.empNumber === input);
            if (user) {
                currentUser = user;
                localStorage.setItem('spei_ops_prod_vfinal_x1', JSON.stringify(user));
                enterApp();
                addMessage(`Bienvenido, ${user.name}. He sincronizado la base operativa. ¿En qué puedo apoyarte?`);
            } else {
                document.getElementById('error-emp').style.opacity = "1";
                setTimeout(() => document.getElementById('error-emp').style.opacity = "0", 2500);
            }
        };

        document.getElementById('logout-btn').onclick = logout;
        document.getElementById('timeout-logout-btn').onclick = logout;
        document.getElementById('timeout-extend-btn').onclick = () => { resetInactivityTimer(); notify("Sesión renovada"); };
        document.getElementById('open-settings-btn').onclick = () => document.getElementById('settings-modal').classList.remove('hidden-ui');
        document.getElementById('close-settings-btn').onclick = () => {
             document.getElementById('settings-modal').classList.add('hidden-ui');
             clearManualForm();
        };
        document.getElementById('file-trigger').onclick = () => document.getElementById('file-selector').click();

        document.getElementById('mode-toggle').onchange = (e) => {
            isInternalMode = e.target.checked;
            document.getElementById('chat-header').className = isInternalMode 
                ? "bg-emerald-900 text-white p-6 pt-10 shadow-xl flex items-center justify-between shrink-0"
                : "bg-slate-900 text-white p-6 pt-10 shadow-xl flex items-center justify-between shrink-0";
            notify(isInternalMode ? "Modo Administración" : "Soporte Operativo");
        };

        // GESTIÓN DE DATOS (EDICIÓN Y VISIBILIDAD)
        document.getElementById('save-entry-btn').onclick = async () => {
            const cat = document.getElementById('entry-category').value;
            const title = document.getElementById('entry-title').value.trim();
            const content = document.getElementById('entry-content').value.trim();
            const editId = document.getElementById('editing-id').value;
            if (!title || !content) return notify("Faltan datos", true);
            try {
                const id = editId || Date.now().toString();
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'knowledge', id), { 
                    category: cat, title: title, content: content, date: new Date().toLocaleDateString() 
                }, { merge: true });
                notify(editId ? "Manual Actualizado" : "Manual Guardado");
                clearManualForm();
            } catch (err) { notify("Error al guardar", true); }
        };

        function clearManualForm() {
            document.getElementById('entry-title').value = "";
            document.getElementById('entry-content').value = "";
            document.getElementById('editing-id').value = "";
            document.getElementById('save-entry-btn').innerText = "Guardar en Base de Datos";
            document.getElementById('save-entry-btn').className = "flex-1 bg-emerald-600 text-white py-4 rounded-2xl font-black text-xs shadow-lg uppercase tracking-widest";
        }

        window.editEntry = (id) => {
            const e = knowledgeBase.find(x => x.id === id);
            if (!e) return;
            document.getElementById('entry-category').value = e.category || "Procesos";
            document.getElementById('entry-title').value = e.title;
            document.getElementById('entry-content').value = e.content;
            document.getElementById('editing-id').value = id;
            document.getElementById('save-entry-btn').innerText = "Confirmar Edición";
            document.getElementById('save-entry-btn').className = "flex-1 bg-blue-600 text-white py-4 rounded-2xl font-black text-xs shadow-lg uppercase tracking-widest";
            notify("Modo Edición");
            document.querySelector('#settings-modal .overflow-y-auto').scrollTop = 0;
        };

        window.deleteEntry = async (id) => {
            if (confirm("¿Borrar permanentemente?")) {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'knowledge', id));
                notify("Eliminado");
            }
        };

        function renderEntries() {
            document.getElementById('knowledge-list').innerHTML = knowledgeBase.map(e => `
                <div class="admin-card bg-white p-6 rounded-3xl border border-slate-100 mb-4 shadow-sm">
                    <div class="flex justify-between items-start mb-4 border-b border-slate-50 pb-3">
                        <div class="flex items-center gap-3">
                            <span class="text-[9px] bg-blue-50 text-blue-600 px-3 py-1 rounded-full font-black uppercase tracking-tighter">${e.category || 'Manual'}</span>
                            <span class="text-[9px] text-slate-300 font-bold">${e.date}</span>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="editEntry('${e.id}')" class="text-blue-500 hover:bg-blue-50 w-9 h-9 rounded-full flex items-center justify-center border border-blue-50 transition-all"><i class="fas fa-pen text-sm"></i></button>
                            <button onclick="deleteEntry('${e.id}')" class="text-red-300 hover:bg-red-50 w-9 h-9 rounded-full flex items-center justify-center border border-red-50 transition-all"><i class="fas fa-trash text-sm"></i></button>
                        </div>
                    </div>
                    <h4 class="text-sm font-black text-slate-800 uppercase mb-3">${e.title}</h4>
                    <p class="manual-text text-[12px] text-slate-600 font-medium">${e.content}</p>
                </div>
            `).join('');
        }

        document.getElementById('add-user-btn').onclick = async () => {
            const name = document.getElementById('new-user-name').value.trim();
            const num = document.getElementById('new-user-id').value.trim();
            const role = document.getElementById('new-user-role').value;
            if (!name || !num) return notify("Faltan datos", true);
            try {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'team', num), { name, empNumber: num, role: role, queries: 0 });
                document.getElementById('new-user-name').value = ""; document.getElementById('new-user-id').value = "";
                notify("Autorizado");
            } catch (err) { notify("Error", true); }
        };

        function renderUsers() {
            document.getElementById('user-registry-list').innerHTML = employeeRegistry.map(u => `
                <div class="flex items-center justify-between p-5 bg-slate-50 rounded-3xl border border-slate-100 mb-2">
                    <div class="text-[12px] font-bold text-slate-800">${u.name} <span class="text-[9px] opacity-40 uppercase tracking-[0.1em] ml-2 font-black uppercase">[${u.role}]</span></div>
                    <div class="text-[11px] font-black text-blue-600 bg-blue-100 px-4 py-1 rounded-full">${u.queries || 0} q</div>
                </div>
            `).join('');
        }

        document.getElementById('file-selector').onchange = async (e) => {
            const files = e.target.files;
            if (!files.length) return;
            notify("Leyendo archivos...");
            for (let file of files) {
                const ext = file.name.split('.').pop().toLowerCase();
                let text = "";
                try {
                    if (ext === 'pdf') {
                        const data = await file.arrayBuffer();
                        const pdf = await pdfjsLib.getDocument({ data }).promise;
                        for (let i=1; i<=pdf.numPages; i++) {
                            const p = await pdf.getPage(i);
                            const c = await p.getTextContent();
                            text += c.items.map(s => s.str).join(' ') + '\n';
                        }
                    } else if (['xlsx','csv'].includes(ext)) {
                        const data = await file.arrayBuffer();
                        const wb = XLSX.read(new Uint8Array(data), {type: 'array'});
                        wb.SheetNames.forEach(n => text += XLSX.utils.sheet_to_txt(wb.Sheets[n]) + "\n");
                    } else if (ext === 'txt') text = await file.text();
                    
                    if (text) {
                        const id = "file_" + Date.now() + "_" + Math.floor(Math.random()*1000);
                        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'knowledge', id), {
                            category: "Archivo", title: file.name, content: text, date: new Date().toLocaleDateString()
                        });
                    }
                } catch (err) { notify("Error en archivo", true); }
            }
            notify("Carga completa");
        };

        // PARSER PARA ICONOS EN TÍTULOS
        function formatBotResponse(text) {
            return text.replace(/###\s*(.*?)(\n|$)/g, '<div class="bot-header"><i class="fas fa-book-open text-blue-500"></i> $1</div>')
                       .replace(/\n/g, '<br>');
        }

        async function fetchGemini(q) {
            // Unificamos la base de datos de manera que el bot sepa qué es contenido y qué es metadato
            const kb = knowledgeBase.map(e => `ID_INTERNO: ${e.id}\nCONTENIDO: ${e.content}`).join('\n\n---\n\n');
            
            const systemPrompt = `INSTRUCCIÓN TÉCNICA CRÍTICA PARA EL ASISTENTE SPEI OPS:
            1. Analiza el manual proporcionado: ${kb}.
            2. Si la consulta se responde con el manual, tu respuesta debe ser ÚNICAMENTE la transcripción exacta del texto que aparece después de "CONTENIDO:".
            3. QUEDA PROHIBIDO incluir etiquetas como "[CATEGORÍA: ...]", "ID_INTERNO:", o el título del manual en la respuesta final.
            4. NO saludes, NO te despidas, NO expliques de dónde sacaste la información. 
            5. Si la información está en varios registros, únelos de forma fluida pero mantén el texto técnico original.
            6. Usa LaTeX ($$formula$$) para matemáticas y ### para separar secciones si el texto original lo requiere.
            7. Si no encuentras la respuesta, di únicamente: "Información no registrada en el manual operativo."`;

            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [...chatHistory, { role: "user", parts: [{ text: q }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] }
                    })
                });
                const data = await res.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "Sin respuesta.";
                
                chatHistory.push({ role: "user", parts: [{ text: q }] }, { role: "model", parts: [{ text }] });
                if (chatHistory.length > 10) chatHistory.splice(0, 2);
                
                if (!isInternalMode && currentUser) {
                    const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'team', currentUser.empNumber);
                    await updateDoc(userRef, { queries: (currentUser.queries || 0) + 1 });
                }
                return text;
            } catch (e) { return "Fallo en la conexión operativa."; }
        }

        document.getElementById('chat-form').onsubmit = async (e) => {
            e.preventDefault();
            const v = document.getElementById('user-input').value.trim();
            if (!v) return;
            document.getElementById('user-input').value = "";
            addMessage(v, true);
            const l = document.createElement('div'); l.id = "loader"; l.className = "p-5 bg-white border rounded-3xl w-fit bot-bubble animate-pulse text-[11px] font-black text-slate-400 italic shadow-sm"; l.innerText = "Sincronizando información oficial...";
            document.getElementById('chat-box').appendChild(l);
            const res = await fetchGemini(v);
            if (document.getElementById('loader')) document.getElementById('loader').remove();
            addMessage(res);
            resetInactivityTimer();
        };

        function addMessage(text, isUser = false) {
            const div = document.createElement('div');
            div.className = `flex flex-col gap-2 message-appear ${isUser ? 'items-end ml-auto' : 'items-start'} max-w-[95%]`;
            const color = isUser ? 'bg-blue-600 text-white user-bubble' : 'bg-white text-slate-800 bot-bubble';
            
            const formattedContent = isUser ? text.replace(/\n/g, '<br>') : formatBotResponse(text);
            
            div.innerHTML = `<div class="${color} px-7 py-6 text-[15.5px] leading-[1.8] rounded-[2.2rem] ${isUser ? 'rounded-tr-none shadow-lg' : 'rounded-tl-none'}">${formattedContent}</div><span class="text-[10px] text-slate-400 mx-6 font-black uppercase tracking-widest">${isUser ? currentUser.name : 'Asistente SPEI'}</span>`;
            
            document.getElementById('chat-box').appendChild(div);
            document.getElementById('chat-box').scrollTop = document.getElementById('chat-box').scrollHeight;
            
            if (!isUser && window.MathJax) {
                MathJax.typesetPromise();
            }
        }

        document.getElementById('tab-kb-btn').onclick = () => {
            document.getElementById('tab-kb').classList.remove('hidden'); document.getElementById('tab-users').classList.add('hidden');
            document.getElementById('tab-kb-btn').classList.add('active'); document.getElementById('tab-users-btn').classList.remove('active');
        };
        document.getElementById('tab-users-btn').onclick = () => {
            document.getElementById('tab-kb').classList.add('hidden'); document.getElementById('tab-users').classList.remove('hidden');
            document.getElementById('tab-kb-btn').classList.remove('active'); document.getElementById('tab-users-btn').classList.add('active');
        };

        ['mousedown', 'keydown', 'touchstart'].forEach(e => window.addEventListener(e, resetInactivityTimer));
        initApp();
    </script>
</body>
</html>
