<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <title>SPEI Ops - Speikito v30.3</title>

  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/616/616430.png" />

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, collection, onSnapshot, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    let firebaseConfig;
    try {
      firebaseConfig = JSON.parse(window.__firebase_config);
    } catch (e) {
      firebaseConfig = {
        apiKey: "AIzaSyDPi5pcDL6OL2zCJK_0n3A_RdDGt3U3LVQ",
        authDomain: "chatbot-8d0a3.firebaseapp.com",
        projectId: "chatbot-8d0a3",
        storageBucket: "chatbot-8d0a3.firebasestorage.app",
        messagingSenderId: "390359131739",
        appId: "1:390359131739:web:23373d0ba69b4719bb417e",
      };
    }

    const appId = typeof __app_id !== "undefined" ? __app_id : firebaseConfig.projectId;
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    window.fb = {
      auth, db, appId,
      doc, setDoc, collection, onSnapshot, deleteDoc, writeBatch,
      signInAnonymously, signInWithCustomToken, onAuthStateChanged
    };
  </script>

  <style>
    @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap");
    * { box-sizing: border-box; }
    body { font-family: "Inter", sans-serif; background:#f1f5f9; height:100vh; overflow:hidden; display:flex; flex-direction:column; }
    .layout-container { display:flex; height:100%; width:100%; }
    .sidebar { width:280px; background:#0f172a; color:#94a3b8; display:flex; flex-direction:column; border-right:1px solid #1e293b; transition:transform .3s; flex-shrink:0; z-index:50; }
    .sidebar-header { padding:1.5rem; border-bottom:1px solid #1e293b; display:flex; align-items:center; gap:.75rem; color:#fff; font-weight:800; font-size:1.1rem; }
    .nav-scroll { flex:1; overflow-y:auto; padding:1rem 0; }
    .nav-section { font-size:.65rem; font-weight:800; text-transform:uppercase; color:#475569; padding:1rem 1.5rem .5rem; letter-spacing:.05em; }
    .nav-item { padding:.75rem 1.5rem; cursor:pointer; display:flex; align-items:center; gap:.75rem; font-size:.85rem; font-weight:600; transition:.2s; border-left:3px solid transparent; }
    .nav-item:hover { background:#1e293b; color:#fff; }
    .nav-item.active { background:#1e293b; color:#fff; border-left-color:#3b82f6; }
    .main-area { flex:1; display:flex; flex-direction:column; background:#fff; position:relative; overflow:hidden; }
    .top-header { height:4rem; border-bottom:1px solid #e2e8f0; display:flex; align-items:center; justify-content:space-between; padding:0 2rem; background:#fff; z-index:20; }
    .view-section { flex:1; overflow-y:auto; padding:2rem; display:none; height:100%; flex-direction:column; }
    .view-section.active { display:flex; }
    #view-chat { padding:0; }
    .chat-box { flex:1; overflow-y:auto; padding:2rem; background:#f8fafc; }
    .chat-input-area { padding:1.5rem 2rem; background:#fff; border-top:1px solid #e2e8f0; }
    .chat-bubble { max-width:85%; padding:1rem 1.25rem; border-radius:1rem; font-size:.9rem; line-height:1.6; margin-bottom:1rem; box-shadow:0 2px 4px rgba(0,0,0,.05); }
    .user-msg { align-self:flex-end; background:#2563eb; color:#fff; border-bottom-right-radius:0; margin-left:auto; }
    .bot-msg { align-self:flex-start; background:#fff; border:1px solid #e2e8f0; color:#0f172a; border-bottom-left-radius:0; width:100%; }
    .bot-header { font-weight:900; color:#0f172a; margin-bottom:.5rem; display:flex; align-items:center; gap:.5rem; border-bottom:2px solid #e2e8f0; padding-bottom:.5rem; }

    .reg-card { background:#fffbeb; border-left:4px solid #f59e0b; padding:1rem; border-radius:.5rem; margin-top:.5rem; }
    .reg-title { font-size:.75rem; font-weight:900; color:#92400e; text-transform:uppercase; margin-bottom:.5rem; }
    .reg-content { color:#451a03; line-height:1.6; font-size:.95rem; white-space:pre-wrap; }
    .reg-footer { margin-top:.5rem; font-size:.7rem; color:#b45309; font-weight:800; text-align:right; }

    #table-content { flex:1; overflow-y:auto; padding-bottom:6rem; display:flex; flex-direction:column; gap:.75rem; min-height:300px; }
    .data-card { background:#fff; border:1px solid #e2e8f0; border-radius:.75rem; padding:1rem; display:flex; justify-content:space-between; align-items:center; transition:.2s; box-shadow:0 1px 2px rgba(0,0,0,.05); min-height:80px; }
    .data-card:hover { border-color:#3b82f6; transform:translateY(-1px); }
    .badge { font-size:.65rem; font-weight:900; text-transform:uppercase; padding:.25rem .5rem; border-radius:99px; display:inline-block; margin-bottom:.25rem; }
    .badge-REGLA_SPEI { background:#fffbeb; color:#b45309; }
    .badge-CERTIFICADO { background:#eff6ff; color:#1d4ed8; }
    .badge-EXTENSION { background:#f0fdf4; color:#15803d; }
    .badge-MANUAL { background:#f8fafc; color:#475569; }
    .badge-ARCHIVO { background:#e0f2fe; color:#0369a1; }

    .form-input { width:100%; padding:.7rem; border:1px solid #cbd5e1; border-radius:.5rem; font-size:.85rem; outline:none; transition:.2s; background:#fff; color:#0f172a; font-weight:700; }
    .form-input:focus { border-color:#2563eb; box-shadow:0 0 0 2px #bfdbfe; }
    .form-label { font-size:.7rem; font-weight:800; color:#64748b; margin-bottom:.25rem; display:block; text-transform:uppercase; }

    .overlay { position:fixed; inset:0; background:rgba(15,23,42,.95); backdrop-filter:blur(4px); z-index:60; display:flex; align-items:center; justify-content:center; }
    .modal { background:#fff; width:90%; max-width:800px; max-height:90vh; border-radius:1rem; display:flex; flex-direction:column; overflow:hidden; box-shadow:0 25px 50px -12px rgba(0,0,0,.25); }
    .hidden-ui { display:none !important; opacity:0; pointer-events:none; }
    .admin-only.hidden-ui { display:none !important; }

    #toast { position:fixed; top:2rem; left:50%; transform:translateX(-50%); z-index:10001; padding:.75rem 1.5rem; border-radius:99px; font-weight:900; font-size:.85rem; color:#fff; background:#0f172a; opacity:0; pointer-events:none; transition:.3s; }
    #toast.show { opacity:1; top:3rem; }

    .select-row { width:1.2rem; height:1.2rem; margin-right:1rem; cursor:pointer; accent-color:#2563eb; }

    .avatar-circle { width:32px; height:32px; border-radius:50%; object-fit:cover; background:#334155; display:flex; align-items:center; justify-content:center; font-weight:900; color:#fff; font-size:.7rem; cursor:pointer; border:2px solid #475569; }
    .avatar-circle:hover { border-color:#fff; }

    @media (max-width:768px){
      .sidebar { position:fixed; height:100%; transform:translateX(-100%); }
      .sidebar.open { transform:translateX(0); }
    }
  </style>
</head>

<body>
  <div id="toast">Notificaci√≥n</div>

  <!-- CARGA -->
  <div id="loading-screen" class="overlay">
    <div class="text-center">
      <div class="w-16 h-16 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
      <p class="text-xs font-bold uppercase tracking-widest text-slate-400">Iniciando Sistema...</p>
    </div>
  </div>

  <!-- LOGIN -->
  <div id="login-screen" class="overlay hidden-ui">
    <div class="bg-white p-10 rounded-2xl shadow-2xl w-full max-w-sm text-center">
      <div class="w-16 h-16 bg-slate-900 rounded-2xl mx-auto mb-6 flex items-center justify-center text-white text-3xl"><i class="fas fa-fingerprint"></i></div>
      <h1 class="text-2xl font-black text-slate-900 mb-1">SPEI Ops</h1>
      <p class="text-slate-500 text-xs mb-8 font-bold uppercase tracking-widest">Acceso Corporativo</p>
      <div class="space-y-4">
        <input type="text" id="login-id" placeholder="ID de Empleado" class="form-input text-center text-lg font-black tracking-widest border-slate-300" />
        <button onclick="handleLogin()" id="btn-login" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3.5 rounded-lg font-black shadow-lg transition-all active:scale-95 cursor-pointer">INGRESAR</button>
        <p id="login-msg" class="text-red-500 text-xs font-black mt-2 opacity-0 transition-opacity">Credenciales Incorrectas</p>
      </div>
      <p class="mt-8 text-[10px] text-slate-400 font-black uppercase tracking-wider">v30.3 ‚Ä¢ Creado por Daniel Anzaldo</p>
    </div>
  </div>

  <!-- APP PRINCIPAL -->
  <div id="app-layout" class="layout-container hidden-ui">

    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <i class="fas fa-cat text-blue-500 text-xl"></i> SPEI Ops
        <button class="ml-auto md:hidden text-slate-400" onclick="toggleSidebar()"><i class="fas fa-times"></i></button>
      </div>

      <div class="nav-scroll">
        <div class="nav-section">Operaci√≥n</div>
        <div onclick="navigate('chat')" class="nav-item active" id="nav-chat"><i class="fas fa-comments w-5"></i> Speikito</div>

        <div class="admin-only hidden-ui">
          <div class="nav-section">Gesti√≥n</div>
          <div onclick="navigate('admin-all')" class="nav-item text-blue-400" id="nav-all"><i class="fas fa-globe w-5"></i> VER TODO</div>
          <div onclick="navigate('admin-rules')" class="nav-item text-amber-500" id="nav-rules"><i class="fas fa-balance-scale w-5"></i> Normativa SPEI</div>
          <div onclick="navigate('admin-cert')" class="nav-item" id="nav-cert"><i class="fas fa-certificate w-5"></i> Certificados</div>
          <div onclick="navigate('admin-ext')" class="nav-item" id="nav-ext"><i class="fas fa-address-book w-5"></i> Directorio</div>
          <div onclick="navigate('admin-docs')" class="nav-item" id="nav-docs"><i class="fas fa-file-alt w-5"></i> Manuales</div>
          <div onclick="navigate('admin-files')" class="nav-item" id="nav-files"><i class="fas fa-folder w-5"></i> Archivos</div>

          <div class="nav-section">Sistema</div>
          <div onclick="navigate('admin-users')" class="nav-item text-indigo-400" id="nav-users"><i class="fas fa-users-cog w-5"></i> Usuarios</div>
        </div>
      </div>

      <div class="p-4 border-t border-slate-800">
        <div class="flex items-center gap-3 mb-4">
          <div onclick="openProfileModal()" class="avatar-circle" id="user-avatar-container">
            <span id="user-initials">DA</span>
            <img id="user-img-display" class="hidden w-full h-full rounded-full object-cover" src="" />
          </div>
          <div class="overflow-hidden">
            <p class="text-xs font-black text-white truncate" id="user-name-display">Usuario</p>
            <p class="text-[10px] text-slate-400 uppercase font-black truncate" id="user-role-display">Rol</p>
          </div>
        </div>
        <button onclick="logout()" class="w-full bg-slate-800 hover:bg-red-900/50 text-slate-300 hover:text-red-200 py-2 rounded text-xs font-black transition-all">
          <i class="fas fa-sign-out-alt mr-2"></i>Cerrar Sesi√≥n
        </button>
      </div>
    </aside>

    <div class="fixed inset-0 bg-black/50 z-40 hidden md:hidden" id="sidebar-backdrop" onclick="toggleSidebar()"></div>

    <!-- CONTENIDO -->
    <main class="main-area">
      <div class="top-header">
        <div class="flex items-center gap-3">
          <button class="md:hidden text-slate-500 text-xl" onclick="toggleSidebar()"><i class="fas fa-bars text-xl"></i></button>
          <h2 class="font-black text-slate-800 text-lg" id="page-title">Chat Operativo</h2>
        </div>
        <div class="flex gap-2" id="header-actions"></div>
      </div>

      <!-- CHAT -->
      <div id="view-chat" class="view-section active">
        <div id="chat-box" class="chat-box space-y-4">
          <div class="bot-msg chat-bubble shadow-sm w-full">
            <div class="bot-header"><i class="fas fa-cat text-blue-600"></i> Speikito</div>
            <p class="text-sm text-slate-600">
              Hola. Soy <b>Speikito</b> üê±.
              <br/>Si tu pregunta coincide con normativa cargada, te respondo con evidencia.
              <br/>Si no coincide, te ayudo a aclarar qu√© falta / qu√© buscar (sin inventar reglas).
            </p>
          </div>
        </div>

        <div class="chat-input-area">
          <form id="chat-form" class="relative max-w-5xl mx-auto flex gap-2">
            <input type="text" id="chat-input" placeholder="Ej: ¬øQu√© regla aplica para devoluciones?" class="flex-1 bg-slate-50 border border-slate-200 rounded-2xl px-6 py-4 text-sm font-black text-slate-700 outline-none focus:border-blue-500 transition-all" autocomplete="off" />
            <button type="submit" class="w-14 bg-blue-600 text-white rounded-2xl flex items-center justify-center shadow-lg hover:bg-blue-700 active:scale-90 transition-all">
              <i class="fas fa-paper-plane text-lg"></i>
            </button>
          </form>
        </div>
      </div>

      <!-- TABLA -->
      <div id="view-table" class="view-section hidden-ui h-full flex flex-col">
        <div class="mb-4 sticky top-0 bg-[#f8fafc] z-10 py-2 flex gap-2 items-center">
          <input type="checkbox" id="select-all" class="ml-2 w-4 h-4 accent-blue-600" onchange="toggleSelectAll(this)" />
          <input type="text" id="table-search" placeholder="Filtrar..." class="form-input max-w-sm shadow-sm flex-1" onkeyup="filterList()" />
          <button onclick="renderList(document.body.dataset.viewType)" class="w-10 h-10 bg-white border border-slate-300 rounded-lg flex items-center justify-center text-slate-500 hover:text-blue-600">
            <i class="fas fa-sync-alt"></i>
          </button>
        </div>
        <div id="table-content" class="space-y-2 pb-20 overflow-y-auto w-full">
          <div class="text-center py-10 text-slate-400 italic">Cargando datos...</div>
        </div>
      </div>
    </main>
  </div>

  <!-- MODAL PERFIL -->
  <div id="modal-profile" class="overlay hidden-ui">
    <div class="modal max-w-sm">
      <div class="p-5 border-b bg-slate-50"><h3 class="font-black">Foto de Perfil</h3></div>
      <div class="p-8 text-center">
        <div class="w-24 h-24 rounded-full bg-slate-200 mx-auto mb-4 overflow-hidden border-4 border-white shadow-lg cursor-pointer" onclick="document.getElementById('profile-up').click()">
          <img id="profile-prev" src="" class="w-full h-full object-cover hidden" />
          <i id="profile-icon" class="fas fa-camera text-3xl text-slate-400 mt-8"></i>
        </div>
        <input type="file" id="profile-up" class="hidden" accept="image/*" onchange="handleProfileUpload(this)" />
        <p class="text-xs text-slate-500">Clic para cambiar</p>
      </div>
      <div class="p-5 border-t text-center"><button onclick="closeModal('modal-profile')" class="text-slate-400 text-xs font-black">Cerrar</button></div>
    </div>
  </div>

  <script type="module">
    const { auth, db, appId, doc, setDoc, collection, onSnapshot, deleteDoc, signInAnonymously, onAuthStateChanged, signInWithCustomToken, writeBatch } = window.fb;

    let currentUser = null;
    let knowledgeBase = [];
    let team = [];

    // -------- Utils
    function escapeHtml(str) {
      return String(str || "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function normalizeText(s) {
      return String(s || "")
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
        .toLowerCase()
        .trim();
    }

    // -------- Global
    window.toast = (m, e) => {
      const t = document.getElementById("toast");
      t.innerText = m;
      t.className = `fixed top-6 left-1/2 -translate-x-1/2 px-6 py-3 rounded-full text-xs font-black shadow-2xl z-[10002] transition-all opacity-100 ${e ? "bg-red-500 text-white" : "bg-emerald-500 text-white"}`;
      setTimeout(() => t.classList.remove("opacity-100"), 3000);
    };

    window.toggleSidebar = () => document.getElementById("sidebar").classList.toggle("open");
    window.closeModal = (id) => document.getElementById(id).classList.add("hidden-ui");
    window.openProfileModal = () => document.getElementById("modal-profile").classList.remove("hidden-ui");

    window.handleLogin = () => {
      const val = document.getElementById("login-id").value.trim();
      if (val === "682930") { login({ name: "Daniel Anzaldo", role: "admin", empNumber: "682930" }); return; }
      const u = team.find(x => x.empNumber === val);
      if (u) login(u);
      else document.getElementById("login-msg").style.opacity = "1";
    };

    window.logout = () => { localStorage.removeItem("spei_v30_3_session"); location.reload(); };

    // NAV
    window.navigate = (view) => {
      if (window.innerWidth < 768) document.getElementById("sidebar").classList.remove("open");
      document.querySelectorAll(".nav-item").forEach(n => n.classList.remove("active"));

      const chat = document.getElementById("view-chat");
      const table = document.getElementById("view-table");
      const title = document.getElementById("page-title");
      const acts = document.getElementById("header-actions");

      if (view === "chat") {
        document.getElementById("nav-chat").classList.add("active");
        chat.classList.remove("hidden-ui"); table.classList.add("hidden-ui");
        title.innerText = "Chat Operativo"; acts.innerHTML = "";
      } else {
        let type = "ALL", label = "Base Completa", navId = "nav-all";
        if (view === "admin-rules") { type = "REGLA_SPEI"; label = "Normativa SPEI"; navId = "nav-rules"; }
        if (view === "admin-cert") { type = "CERTIFICADO"; label = "Certificados"; navId = "nav-cert"; }
        if (view === "admin-ext")  { type = "EXTENSION"; label = "Directorio"; navId = "nav-ext"; }
        if (view === "admin-docs") { type = "MANUAL"; label = "Manuales"; navId = "nav-docs"; }
        if (view === "admin-files"){ type = "ARCHIVO"; label = "Archivos"; navId = "nav-files"; }

        document.getElementById(navId)?.classList.add("active");
        chat.classList.add("hidden-ui"); table.classList.remove("hidden-ui");
        title.innerText = label; document.body.dataset.viewType = type;

        acts.innerHTML = `<button onclick="window.deleteSelected()" class="bg-red-50 text-red-600 px-3 py-1 rounded-lg text-xs font-black shadow-sm hover:bg-red-100 transition-all"><i class="fas fa-trash-alt"></i> Borrar</button>`;
        renderList(type);
      }
    };

    // -------- Render list (m√≠nimo)
    function renderList(type) {
      const list = document.getElementById("table-content");
      if (!list) return;

      let data = (type === "ALL") ? knowledgeBase : knowledgeBase.filter(k => k.contentType === type);
      if (!data.length) { list.innerHTML = "<div class='text-center py-10 text-slate-400 font-black'>Sin registros</div>"; return; }

      list.innerHTML = data.map(i => {
        const id = i.id;
        const title = i.title || "(Sin t√≠tulo)";
        const desc = (i.content || "").substring(0, 90);
        return `
          <div class="data-card">
            <div class="flex items-center w-full overflow-hidden">
              <input type="checkbox" class="mr-3 accent-blue-600 w-4 h-4 select-row" value="${escapeHtml(id)}">
              <div>
                <span class="badge badge-${escapeHtml(i.contentType || "MANUAL")}">${escapeHtml(i.contentType || "MANUAL")}</span>
                <h4 class="font-black text-sm mt-1">${escapeHtml(title)}</h4>
                <p class="text-xs text-slate-500">${escapeHtml(desc)}</p>
              </div>
            </div>
            <div class="flex gap-2">
              <button onclick="window.deleteRec('${escapeHtml(id)}')" class="text-red-500"><i class="fas fa-trash"></i></button>
            </div>
          </div>
        `;
      }).join("");
    }

    window.filterList = () => renderList(document.body.dataset.viewType || "ALL");

    window.deleteRec = async (id) => {
      if (!confirm("¬øEliminar?")) return;
      await deleteDoc(doc(db, "artifacts", appId, "public", "data", "knowledge", id));
      renderList(document.body.dataset.viewType || "ALL");
    };

    window.toggleSelectAll = (el) => document.querySelectorAll(".select-row").forEach(cb => cb.checked = el.checked);

    window.deleteSelected = async () => {
      const selected = Array.from(document.querySelectorAll(".select-row:checked")).map(cb => cb.value);
      if (!selected.length) return window.toast("Nada seleccionado", true);

      if (!confirm(`¬øBorrar ${selected.length} registros seleccionados?`)) return;

      const batch = writeBatch(db);
      selected.forEach(id => batch.delete(doc(db, "artifacts", appId, "public", "data", "knowledge", id)));
      await batch.commit();

      window.toast(`${selected.length} registros eliminados`);
      renderList(document.body.dataset.viewType || "ALL");
    };

    // -------- IA (NO JSON). Si hay reglas, se ‚Äúamarran‚Äù al contexto; si no hay reglas, solo ayuda a aclarar.
    async function askGeminiGuarded(question, context, hasRules) {
      const guard = hasRules
        ? `INSTRUCCIONES:
- Usa SOLO la informaci√≥n del CONTEXTO.
- Si el contexto no contiene la respuesta, di: "No hay evidencia en la base cargada".
- No inventes datos.`
        : `INSTRUCCIONES:
- No afirmes hechos como si vinieran de normativa (no hay coincidencias).
- Ayuda a aclarar: qu√© dato falta, qu√© palabras clave buscar, qu√© falta cargar.
- Prohibido inventar reglas/cap√≠tulos/textos.`;

      const prompt = `
Eres Speikito, asistente de consulta.

${guard}

PREGUNTA:
${question}

${context ? `CONTEXTO:\n${context}` : "CONTEXTO: (vac√≠o)"}

FORMATO DE RESPUESTA (TEXTO NORMAL, NO JSON):
- Respuesta:
- Citas (si aplica): (cada cita con: Regla / Cap√≠tulo / Texto literal entre ¬´ ¬ª)
- Preguntas para aclarar (si aplica):
- Sugerencias de b√∫squeda (si aplica):
`;

      try {
        const res = await fetch("/api/gemini", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ prompt }),
        });

        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          return `Error API (${res.status}): ${err?.error || err?.detail?.message || err?.message || "No se pudo consultar la IA"}`;
        }

        const data = await res.json();
        return data?.candidates?.[0]?.content?.parts?.map(p => p.text).join("") || "Sin respuesta de IA.";
      } catch {
        return "Error de conexi√≥n.";
      }
    }

    function renderGuarded(aiText, hitsCount, rulesCount) {
      const meta = `<div class="reg-footer">Matches: ${hitsCount} ‚Ä¢ Reglas: ${rulesCount}</div>`;
      return `
        <div class="reg-card">
          <div class="reg-title">Respuesta</div>
          <div class="reg-content">${escapeHtml(aiText)}</div>
          ${meta}
        </div>
      `;
    }

    function buildOpsHtml(hits) {
      if (!hits.length) return "";
      let h = `<div class="mb-2 font-black text-xs text-blue-600">RESULTADOS OPERATIVOS</div>`;
      hits.slice(0, 10).forEach(x => {
        if (x.contentType === "CERTIFICADO") {
          h += `<div class="bg-blue-50 p-2 rounded mb-1 text-xs border border-blue-100 font-mono"><b>${escapeHtml(x.title)}</b><br>Estatus: ${escapeHtml(x.estatus || "-")} | Vence: ${escapeHtml(x.vigenciaFin || "-")}</div>`;
        } else if (x.contentType === "EXTENSION") {
          h += `<div class="bg-emerald-50 p-2 rounded mb-1 text-xs"><b>${escapeHtml(x.ext || "")}</b> - ${escapeHtml(x.nombre || "")} (${escapeHtml(x.area || "")})</div>`;
        } else {
          h += `<div class="bg-white p-2 rounded border mb-1 text-xs"><b>${escapeHtml(x.title || "")}</b><br>${escapeHtml((x.content || "").slice(0, 140))}</div>`;
        }
      });
      return h;
    }

    // CHAT
    document.getElementById("chat-form").onsubmit = async (e) => {
      e.preventDefault();
      const v = document.getElementById("chat-input").value.trim();
      if (!v) return;

      document.getElementById("chat-input").value = "";
      addMsg(v, true);

      // B√∫squeda por ‚Äúcontiene‚Äù. (mejora futura: scoring por keywords)
      const normV = normalizeText(v);
      const hits = knowledgeBase.filter(k => {
        const text = normalizeText((k.title || "") + " " + (k.content || "") + " " + (k.tema || "") + " " + (k.keywords || ""));
        return normV && text.includes(normV);
      });

      const rules = hits.filter(k => k.contentType === "REGLA_SPEI");
      const hasRules = rules.length > 0;

      // Contexto: si hay reglas, solo reglas; si no, mandamos ‚Äútop hits‚Äù de todo para que ayude a orientar.
      const context = hasRules
        ? rules.map(r => `Regla: ${r.regla}\nCap√≠tulo: ${r.capitulo}\nTexto: ${r.content}\n---`).join("\n")
        : hits.slice(0, 6).map(x => `Tipo: ${x.contentType}\nT√≠tulo: ${x.title}\nContenido: ${(x.content || "").slice(0, 400)}\n---`).join("\n");

      const aiText = await askGeminiGuarded(v, context, hasRules);

      const opsHtml = buildOpsHtml(hits.filter(x => x.contentType !== "REGLA_SPEI"));
      const finalHtml = renderGuarded(aiText, hits.length, rules.length) + (opsHtml ? `<div class="mt-3">${opsHtml}</div>` : "");

      addMsg(finalHtml, false);
    };

    function addMsg(t, u) {
      const d = document.createElement("div");
      d.className = `chat-bubble ${u ? "user-msg" : "bot-msg"} shadow-sm`;
      d.innerHTML = t;

      const b = document.getElementById("chat-box");
      const r = document.createElement("div");
      r.className = `flex w-full mb-2 ${u ? "justify-end" : "justify-start"}`;
      r.appendChild(d);

      b.appendChild(r);
      b.scrollTop = b.scrollHeight;
    }

    // PERFIL (opcional)
    window.handleProfileUpload = (input) => {
      const f = input.files[0];
      if (!f) return;
      const r = new FileReader();
      r.onload = async (e) => {
        if (!currentUser) return;
        await setDoc(doc(db, "artifacts", appId, "public", "data", "team", currentUser.empNumber), { photoURL: e.target.result }, { merge: true });
        updateAvatar(e.target.result);
      };
      r.readAsDataURL(f);
    };

    function updateAvatar(url) {
      if (!url) return;
      document.getElementById("user-initials").classList.add("hidden");
      document.getElementById("user-img-display").src = url;
      document.getElementById("user-img-display").classList.remove("hidden");
      document.getElementById("profile-prev").src = url;
      document.getElementById("profile-prev").classList.remove("hidden");
      document.getElementById("profile-icon").classList.add("hidden");
    }

    function login(u) {
      currentUser = u;
      localStorage.setItem("spei_v30_3_session", JSON.stringify(u));
      document.body.setAttribute("data-role", u.role);

      document.getElementById("login-screen").classList.add("hidden-ui");
      document.getElementById("loading-screen").classList.add("hidden-ui");
      document.getElementById("app-layout").classList.remove("hidden-ui");

      document.getElementById("user-name-display").innerText = u.name;
      document.getElementById("user-role-display").innerText = (u.role === "admin") ? "ADMIN" : "OPERATIVO";

      if (u.role !== "admin") document.querySelectorAll(".admin-only").forEach(e => e.classList.add("hidden-ui"));
      else document.querySelectorAll(".admin-only").forEach(e => e.classList.remove("hidden-ui"));

      if (u.photoURL) updateAvatar(u.photoURL);
    }

    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== "undefined" && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (e) { console.error(e); }
    };

    async function init() {
      await initAuth();

      onAuthStateChanged(auth, async (u) => {
        if (!u) return;

        // Team
        onSnapshot(collection(db, "artifacts", appId, "public", "data", "team"), async (s) => {
          team = s.docs.map(d => ({ id: d.id, ...d.data() }));
          if (!team.length) {
            await setDoc(doc(db, "artifacts", appId, "public", "data", "team", "682930"), { name: "Daniel Anzaldo", role: "admin", empNumber: "682930" });
          }

          const saved = localStorage.getItem("spei_v30_3_session");
          if (saved) login(JSON.parse(saved));
          else document.getElementById("login-screen").classList.remove("hidden-ui");

          document.getElementById("loading-screen").classList.add("hidden-ui");
        });

        // Knowledge
        onSnapshot(collection(db, "artifacts", appId, "public", "data", "knowledge"), (s) => {
          knowledgeBase = s.docs.map(d => ({ id: d.id, ...d.data() }));
          const viewType = document.body.dataset.viewType;
          if (viewType) renderList(viewType);
        });
      });
    }

    window.addEventListener("load", init);
  </script>
</body>
</html>


========================
NOTAS R√ÅPIDAS (IMPORTANTE)
========================
1) Crea la carpeta /api y dentro pega gemini.js (exacto).
2) Tu index.html va en la ra√≠z del proyecto.
3) En Vercel: Settings -> Environment Variables:
   GEMINI_API_KEY = TU_API_KEY
4) Si antes ten√≠as un endpoint diferente, en el frontend SIEMPRE debe llamar:
   fetch("/api/gemini", { method:"POST", ... })
5) Esta versi√≥n:
   - Nunca imprime JSON en el chat
   - Si NO hay coincidencia en normativa, igual consulta a IA pero SOLO para "aclarar / orientar" sin inventar reglas
   - Si hay reglas, obliga a usar SOLO ese contexto
