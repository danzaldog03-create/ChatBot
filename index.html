<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>SPEI Ops - Speikito IA PRO</title>

  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/616/616430.png" />

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
    * { box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background:#f1f5f9; height:100vh; overflow:hidden; }

    .layout-container{display:flex;height:100%;width:100%;}
    .sidebar{width:280px;background:#0f172a;color:#94a3b8;display:flex;flex-direction:column;border-right:1px solid #1e293b;transition:transform .25s;flex-shrink:0;z-index:50;}
    .sidebar-header{padding:1.25rem;border-bottom:1px solid #1e293b;display:flex;align-items:center;gap:.75rem;color:#fff;font-weight:800;font-size:1.05rem;}
    .nav-scroll{flex:1;overflow-y:auto;padding:1rem 0;}
    .nav-section{font-size:.65rem;font-weight:900;text-transform:uppercase;color:#475569;padding:1rem 1.25rem .5rem;letter-spacing:.08em;}
    .nav-item{padding:.75rem 1.25rem;cursor:pointer;display:flex;align-items:center;gap:.75rem;font-size:.85rem;font-weight:600;transition:.15s;border-left:3px solid transparent;}
    .nav-item:hover{background:#1e293b;color:#fff;}
    .nav-item.active{background:#1e293b;color:#fff;border-left-color:#3b82f6;}

    .main-area{flex:1;display:flex;flex-direction:column;background:#fff;overflow:hidden;}
    .top-header{height:4rem;border-bottom:1px solid #e2e8f0;display:flex;align-items:center;justify-content:space-between;padding:0 1.25rem;background:#fff;z-index:20;}
    .view{flex:1;overflow:hidden;display:none;}
    .view.active{display:flex;flex-direction:column;}

    .chat-box{flex:1;overflow-y:auto;padding:1.25rem;background:#f8fafc;}
    .chat-input{padding:1rem 1.25rem;background:#fff;border-top:1px solid #e2e8f0;}
    .chat-bubble{max-width:88%;padding:1rem 1.1rem;border-radius:1rem;font-size:.9rem;line-height:1.55;margin-bottom:.85rem;box-shadow:0 2px 4px rgba(0,0,0,.05);}
    .user-msg{align-self:flex-end;background:#2563eb;color:#fff;border-bottom-right-radius:0;margin-left:auto;}
    .bot-msg{align-self:flex-start;background:#fff;border:1px solid #e2e8f0;color:#0f172a;border-bottom-left-radius:0;width:100%;}
    .bot-header{font-weight:900;color:#0f172a;margin-bottom:.35rem;display:flex;align-items:center;gap:.5rem;border-bottom:2px solid #e2e8f0;padding-bottom:.45rem;}
    .reg-card{background:#fffbeb;border-left:4px solid #f59e0b;padding:1rem;border-radius:.5rem;}
    .reg-title{font-size:.75rem;font-weight:900;color:#92400e;text-transform:uppercase;margin-bottom:.4rem;letter-spacing:.03em;}
    .reg-content{font-family:Georgia,serif;font-style:italic;color:#451a03;line-height:1.55;font-size:.95rem;}
    .reg-footer{margin-top:.5rem;font-size:.7rem;color:#b45309;font-weight:800;text-align:right;}

    .overlay{position:fixed;inset:0;background:rgba(15,23,42,.92);backdrop-filter:blur(4px);z-index:60;display:flex;align-items:center;justify-content:center;}
    .hidden-ui{display:none !important;}
    .modal{background:#fff;width:92%;max-width:900px;max-height:90vh;border-radius:1rem;display:flex;flex-direction:column;overflow:hidden;box-shadow:0 25px 50px -12px rgba(0,0,0,.25);}
    .form-input{width:100%;padding:.7rem;border:1px solid #cbd5e1;border-radius:.6rem;font-size:.85rem;outline:none;background:#fff;color:#0f172a;font-weight:650;}
    .form-input:focus{border-color:#2563eb;box-shadow:0 0 0 3px rgba(37,99,235,.2);}
    .form-label{font-size:.7rem;font-weight:800;color:#64748b;margin-bottom:.25rem;display:block;text-transform:uppercase;letter-spacing:.05em;}

    .data-card{background:#fff;border:1px solid #e2e8f0;border-radius:.75rem;padding:1rem;display:flex;justify-content:space-between;align-items:center;transition:.15s;box-shadow:0 1px 2px rgba(0,0,0,.05);min-height:80px;}
    .data-card:hover{border-color:#3b82f6;box-shadow:0 4px 6px -1px rgba(0,0,0,.05);transform:translateY(-1px);}
    .badge{font-size:.65rem;font-weight:900;text-transform:uppercase;padding:.25rem .5rem;border-radius:999px;display:inline-block;margin-bottom:.25rem;}
    .badge-CERTIFICADO{background:#eff6ff;color:#1d4ed8;}
    .badge-EXTENSION{background:#f0fdf4;color:#15803d;}
    .badge-MANUAL{background:#f8fafc;color:#475569;}
    .badge-REGLA_SPEI{background:#fffbeb;color:#b45309;}
    .badge-ARCHIVO{background:#e0f2fe;color:#0369a1;}
    .badge-USUARIO{background:#eef2ff;color:#4338ca;}

    #toast{position:fixed;top:1.25rem;left:50%;transform:translateX(-50%);z-index:10001;padding:.7rem 1.25rem;border-radius:999px;font-weight:900;font-size:.8rem;color:#fff;background:#0f172a;opacity:0;pointer-events:none;transition:.25s;}
    #toast.show{opacity:1;top:1.75rem;}

    @media (max-width:768px){
      .sidebar{position:fixed;height:100%;transform:translateX(-100%);}
      .sidebar.open{transform:translateX(0);}
      .top-header{padding:0 1rem;}
    }
  </style>
</head>
<body>
  <div id="toast">Notificaci√≥n</div>

  <!-- LOADING -->
  <div id="loading" class="overlay">
    <div class="text-center">
      <div class="w-16 h-16 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
      <p class="text-xs font-black uppercase tracking-widest text-slate-300">Iniciando...</p>
      <p class="text-[11px] font-bold text-slate-400 mt-2" id="loading-hint">Conectando a Firebase</p>
    </div>
  </div>

  <!-- LOGIN -->
  <div id="login" class="overlay hidden-ui">
    <div class="bg-white p-10 rounded-2xl shadow-2xl w-full max-w-sm text-center">
      <div class="w-16 h-16 bg-slate-900 rounded-2xl mx-auto mb-6 flex items-center justify-center text-white text-3xl"><i class="fas fa-fingerprint"></i></div>
      <h1 class="text-2xl font-black text-slate-900 mb-1">SPEI Ops</h1>
      <p class="text-slate-500 text-xs mb-8 font-black uppercase tracking-widest">Acceso</p>
      <div class="space-y-4">
        <input type="text" id="login-id" placeholder="ID de Empleado" class="form-input text-center text-lg font-black tracking-widest" />
        <button id="btn-login" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3.5 rounded-lg font-black shadow-lg transition-all active:scale-95">INGRESAR</button>
        <p id="login-msg" class="text-red-500 text-xs font-black mt-2 opacity-0 transition-opacity">Credenciales incorrectas</p>
      </div>
      <p class="mt-8 text-[10px] text-slate-400 font-black uppercase tracking-wider">Speikito IA PRO ‚Ä¢ v3</p>
    </div>
  </div>

  <!-- APP -->
  <div id="app" class="layout-container hidden-ui">
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <i class="fas fa-cat text-blue-500 text-xl"></i> SPEI Ops
        <button class="ml-auto md:hidden text-slate-400" id="btn-close-sidebar"><i class="fas fa-times"></i></button>
      </div>

      <div class="nav-scroll">
        <div class="nav-section">Operaci√≥n</div>
        <div class="nav-item active" id="nav-chat"><i class="fas fa-comments w-5"></i> Speikito</div>

        <div class="admin-only hidden-ui" id="admin-menu">
          <div class="nav-section">Gesti√≥n</div>
          <div class="nav-item text-blue-400" id="nav-all"><i class="fas fa-globe w-5"></i> Ver todo</div>
          <div class="nav-item text-amber-500" id="nav-rules"><i class="fas fa-balance-scale w-5"></i> Normativa SPEI</div>
          <div class="nav-item" id="nav-cert"><i class="fas fa-certificate w-5"></i> Certificados</div>
          <div class="nav-item" id="nav-ext"><i class="fas fa-address-book w-5"></i> Directorio</div>
          <div class="nav-item" id="nav-docs"><i class="fas fa-book w-5"></i> Manuales</div>
          <div class="nav-item" id="nav-files"><i class="fas fa-folder w-5"></i> Archivos</div>

          <div class="nav-section">Sistema</div>
          <div class="nav-item text-indigo-400" id="nav-users"><i class="fas fa-users-cog w-5"></i> Usuarios</div>
        </div>
      </div>

      <div class="p-4 border-t border-slate-800">
        <div class="flex items-center gap-3 mb-4">
          <div class="w-9 h-9 rounded-full bg-slate-700 flex items-center justify-center text-white font-black" id="avatar">DA</div>
          <div class="overflow-hidden">
            <p class="text-xs font-black text-white truncate" id="user-name">Usuario</p>
            <p class="text-[10px] text-slate-400 uppercase font-black truncate" id="user-role">ROL</p>
          </div>
        </div>
        <button id="btn-logout" class="w-full bg-slate-800 hover:bg-red-900/50 text-slate-300 hover:text-red-200 py-2 rounded text-xs font-black transition-all">
          <i class="fas fa-sign-out-alt mr-2"></i>Cerrar sesi√≥n
        </button>
      </div>
    </aside>

    <div class="fixed inset-0 bg-black/50 z-40 hidden md:hidden" id="sidebar-backdrop"></div>

    <main class="main-area">
      <div class="top-header">
        <div class="flex items-center gap-3">
          <button class="md:hidden text-slate-500 text-xl" id="btn-open-sidebar"><i class="fas fa-bars text-xl"></i></button>
          <h2 class="font-black text-slate-800 text-lg" id="page-title">Chat Operativo</h2>
        </div>
        <div class="flex gap-2" id="header-actions"></div>
      </div>

      <!-- CHAT -->
      <section id="view-chat" class="view active">
        <div id="chat-box" class="chat-box space-y-4">
          <div class="bot-msg chat-bubble">
            <div class="bot-header"><i class="fas fa-cat text-blue-600"></i> Speikito IA PRO</div>
            <p class="text-sm text-slate-600">
              Hola üê±. Consulto primero tu <b>base interna</b> y, si lo pides o si no hay match, consulto a la <b>IA</b>.
              <span class="block mt-1 text-[12px] text-slate-500">Tip: escribe <b>/ia</b> al inicio para forzar IA.</span>
            </p>
          </div>
        </div>
        <div class="chat-input">
          <form id="chat-form" class="relative max-w-5xl mx-auto flex gap-2">
            <input id="chat-input" type="text" placeholder="Ej: /ia ¬øQu√© significa devoluci√≥n extempor√°nea?" class="flex-1 bg-slate-50 border border-slate-200 rounded-2xl px-6 py-4 text-sm font-black text-slate-700 outline-none focus:border-blue-500 transition-all" autocomplete="off" />
            <button type="submit" class="w-14 bg-blue-600 text-white rounded-2xl flex items-center justify-center shadow-lg hover:bg-blue-700 active:scale-90 transition-all">
              <i class="fas fa-paper-plane text-lg"></i>
            </button>
          </form>
        </div>
      </section>

      <!-- TABLE -->
      <section id="view-table" class="view">
        <div class="p-4 border-b bg-slate-50 flex flex-wrap gap-2 items-center">
          <input type="checkbox" id="select-all" class="ml-1 w-4 h-4 accent-blue-600" />
          <input type="text" id="table-search" placeholder="Filtrar..." class="form-input max-w-sm flex-1 shadow-sm" />
          <button id="btn-refresh" class="w-10 h-10 bg-white border border-slate-300 rounded-lg flex items-center justify-center text-slate-500 hover:text-blue-600"><i class="fas fa-sync-alt"></i></button>
        </div>
        <div id="table-content" class="p-4 space-y-2 overflow-y-auto"></div>
      </section>
    </main>
  </div>

  <!-- MODAL: CARGA MASIVA -->
  <div id="modal-upload" class="overlay hidden-ui">
    <div class="modal max-w-2xl">
      <div class="p-5 border-b bg-slate-50 flex items-center justify-between">
        <h3 class="font-black text-slate-800">Carga masiva (layout)</h3>
        <button class="text-slate-400 hover:text-red-500" data-close="modal-upload"><i class="fas fa-times"></i></button>
      </div>
      <div class="p-6">
        <p class="text-sm text-slate-600 leading-relaxed">
          Sube un <b>.xlsx</b> o <b>.csv</b> con columnas. Se detecta por <b>TIPO</b>:
          <span class="font-black">CERTIFICADO</span>, <span class="font-black">EXTENSION</span>, <span class="font-black">MANUAL</span>, <span class="font-black">REGLA_SPEI</span>.
        </p>
        <div class="grid md:grid-cols-2 gap-4 mt-4">
          <div class="p-4 rounded-xl border bg-slate-50">
            <div class="font-black text-sm mb-2">Plantilla CSV</div>
            <button id="btn-template" class="px-3 py-2 rounded-lg bg-slate-900 text-white text-xs font-black"><i class="fas fa-download mr-2"></i>Descargar</button>
            <p class="text-[12px] text-slate-500 mt-2">Incluye todos los campos que ya usas.</p>
          </div>
          <div class="p-4 rounded-xl border bg-amber-50 border-amber-200">
            <div class="font-black text-sm mb-2 text-amber-900">Subir archivo</div>
            <input id="file-in" type="file" class="form-input" accept=".xlsx,.csv" />
            <button id="btn-upload" class="mt-3 w-full px-3 py-2 rounded-lg bg-amber-600 hover:bg-amber-700 text-white text-xs font-black"><i class="fas fa-upload mr-2"></i>Cargar</button>
            <p class="text-[12px] text-amber-800 mt-2" id="upload-status"></p>
          </div>
        </div>
      </div>
      <div class="p-5 border-t bg-slate-50 flex justify-end">
        <button class="text-slate-500 font-black text-xs px-4" data-close="modal-upload">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- MODAL: USUARIOS -->
  <div id="modal-user" class="overlay hidden-ui">
    <div class="modal max-w-md">
      <div class="p-5 border-b bg-slate-50 flex items-center justify-between">
        <h3 class="font-black text-slate-800">Nuevo usuario</h3>
        <button class="text-slate-400 hover:text-red-500" data-close="modal-user"><i class="fas fa-times"></i></button>
      </div>
      <div class="p-6 space-y-3">
        <div>
          <label class="form-label">Nombre</label>
          <input id="u-name" class="form-input" placeholder="Nombre completo" />
        </div>
        <div>
          <label class="form-label">ID empleado</label>
          <input id="u-id" class="form-input" placeholder="682930" />
        </div>
        <div>
          <label class="form-label">Rol</label>
          <select id="u-role" class="form-input">
            <option value="user">Usuario operativo</option>
            <option value="admin">Administrador</option>
          </select>
        </div>
        <button id="btn-save-user" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-black text-xs">Crear</button>
        <p class="text-[12px] text-slate-500">Tip: el admin por defecto es <b>682930</b>. Si no ves men√∫, borra cach√© o cierra sesi√≥n.</p>
      </div>
      <div class="p-5 border-t bg-slate-50 flex justify-end">
        <button class="text-slate-500 font-black text-xs px-4" data-close="modal-user">Cancelar</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, collection, onSnapshot, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // ====== FIREBASE CONFIG (fallback robusto) ======
    let firebaseConfig;
    try {
      firebaseConfig = JSON.parse(window.__firebase_config);
    } catch (e) {
      firebaseConfig = {
        apiKey: "AIzaSyDPi5pcDL6OL2zCJK_0n3A_RdDGt3U3LVQ",
        authDomain: "chatbot-8d0a3.firebaseapp.com",
        projectId: "chatbot-8d0a3",
        storageBucket: "chatbot-8d0a3.firebasestorage.app",
        messagingSenderId: "390359131739",
        appId: "1:390359131739:web:23373d0ba69b4719bb417e",
      };
    }

    const appId = (typeof __app_id !== "undefined" && __app_id) ? __app_id : firebaseConfig.projectId;
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ====== STATE ======
    const ADMIN_ID = "682930"; // <-- cambia aqu√≠ si quieres otro super-admin
    let currentUser = null;
    let knowledgeBase = [];
    let team = [];

    // ====== UI HELPERS ======
    const $ = (id) => document.getElementById(id);
    const show = (id) => $(id).classList.remove("hidden-ui");
    const hide = (id) => $(id).classList.add("hidden-ui");
    const toast = (msg, isErr=false) => {
      const t = $("toast");
      t.textContent = msg;
      t.style.background = isErr ? "#ef4444" : "#0f172a";
      t.classList.add("show");
      clearTimeout(window.__toastT);
      window.__toastT = setTimeout(()=>t.classList.remove("show"), 2600);
    };

    // sidebar
    const openSidebar = () => { $("sidebar").classList.add("open"); $("sidebar-backdrop").classList.remove("hidden"); };
    const closeSidebar = () => { $("sidebar").classList.remove("open"); $("sidebar-backdrop").classList.add("hidden"); };

    // ====== NAV ======
    function setActiveNav(elId){
      document.querySelectorAll(".nav-item").forEach(n=>n.classList.remove("active"));
      $(elId).classList.add("active");
    }

    function openView(view){
      ["view-chat","view-table"].forEach(v=>$(v).classList.remove("active"));
      $(view).classList.add("active");
    }

    function setHeaderActions(html){ $("header-actions").innerHTML = html || ""; }

    function navigate(view){
      if(window.innerWidth < 768) closeSidebar();

      if(view === "chat"){
        setActiveNav("nav-chat");
        $("page-title").textContent = "Chat Operativo";
        setHeaderActions("");
        openView("view-chat");
        return;
      }

      // admin tables
      openView("view-table");
      let type = "ALL";
      let label = "Base completa";
      let navId = "nav-all";

      if(view === "rules"){ type="REGLA_SPEI"; label="Normativa SPEI"; navId="nav-rules"; }
      if(view === "cert"){ type="CERTIFICADO"; label="Certificados"; navId="nav-cert"; }
      if(view === "ext"){ type="EXTENSION"; label="Directorio"; navId="nav-ext"; }
      if(view === "docs"){ type="MANUAL"; label="Manuales"; navId="nav-docs"; }
      if(view === "files"){ type="ARCHIVO"; label="Archivos"; navId="nav-files"; }
      if(view === "users"){ type="USERS"; label="Usuarios"; navId="nav-users"; }

      setActiveNav(navId);
      $("page-title").textContent = label;
      document.body.dataset.viewType = type;

      // actions
      if(type === "REGLA_SPEI" || type === "CERTIFICADO" || type === "EXTENSION" || type === "MANUAL" || type === "ARCHIVO" || type === "ALL"){
        setHeaderActions(`
          <button id="btn-open-upload" class="bg-amber-600 hover:bg-amber-700 text-white px-3 py-1.5 rounded-lg text-xs font-black shadow"><i class="fas fa-upload"></i> Carga masiva</button>
          <button id="btn-delete-selected" class="bg-red-50 text-red-600 px-3 py-1.5 rounded-lg text-xs font-black shadow-sm hover:bg-red-100 transition-all"><i class="fas fa-trash-alt"></i> Borrar</button>
        `);
        $("btn-open-upload").onclick = () => show("modal-upload");
        $("btn-delete-selected").onclick = deleteSelected;
      } else if(type === "USERS"){
        setHeaderActions(`
          <button id="btn-open-user" class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1.5 rounded-lg text-xs font-black shadow"><i class="fas fa-user-plus"></i> Nuevo</button>
          <button id="btn-delete-selected" class="bg-red-50 text-red-600 px-3 py-1.5 rounded-lg text-xs font-black shadow-sm hover:bg-red-100 transition-all"><i class="fas fa-trash-alt"></i> Borrar</button>
        `);
        $("btn-open-user").onclick = () => show("modal-user");
        $("btn-delete-selected").onclick = deleteSelected;
      }

      renderList(type);
    }

    // ====== LIST RENDER ======
    function normStr(s){
      return (s||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase();
    }

    function getFilteredData(type){
      const q = normStr($("table-search").value);
      let data = [];
      if(type === "USERS") data = team.map(x=>({ ...x, contentType:"USUARIO", title:x.name, content:x.role }));
      else if(type === "ALL") data = knowledgeBase;
      else data = knowledgeBase.filter(k=>k.contentType === type);

      if(!q) return data;
      return data.filter(i => normStr(JSON.stringify(i)).includes(q));
    }

    function renderList(type){
      const list = $("table-content");
      const data = getFilteredData(type);

      if(!data.length){
        list.innerHTML = "<div class='text-center py-10 text-slate-400 font-black'>Sin registros</div>";
        return;
      }

      list.innerHTML = data.map(i=>{
        const isUser = type === "USERS";
        const id = isUser ? (i.empNumber || i.id) : i.id;
        const badge = isUser ? "USUARIO" : (i.contentType || "MANUAL");
        const title = isUser ? i.name : (i.title || "(sin t√≠tulo)");
        const desc = isUser ? `Rol: ${i.role || "user"}` : (i.content || "").toString().slice(0,90);

        return `
          <div class="data-card">
            <div class="flex items-center w-full overflow-hidden">
              <input type="checkbox" class="mr-3 accent-blue-600 w-4 h-4 select-row" value="${id}">
              <div class="min-w-0">
                <span class="badge badge-${badge}">${badge}</span>
                <h4 class="font-black text-sm mt-1 truncate">${title}</h4>
                <p class="text-xs text-slate-500 truncate">${desc}</p>
              </div>
            </div>
            <div class="flex gap-2">
              <button class="text-red-500 hover:text-red-700" data-del="${id}" data-kind="${isUser?'user':'kb'}"><i class="fas fa-trash"></i></button>
            </div>
          </div>
        `;
      }).join("");

      // bind delete buttons
      list.querySelectorAll("[data-del]").forEach(btn=>{
        btn.onclick = async () => {
          const id = btn.getAttribute("data-del");
          const kind = btn.getAttribute("data-kind");
          if(!confirm("¬øEliminar?")) return;
          if(kind==="user"){
            await deleteDoc(doc(db,"artifacts",appId,"public","data","team",id));
            toast("Usuario eliminado");
          } else {
            await deleteDoc(doc(db,"artifacts",appId,"public","data","knowledge",id));
            toast("Registro eliminado");
          }
        };
      });
    }

    // ====== BULK UPLOAD ======
    function downloadTemplate(){
      const csv =
`TIPO,TITULO,CONTENIDO,NUMERO,NEGOCIO,ENTORNO,ESTATUS,INICIO,FIN,EXTENSION,NOMBRE,AREA,REGLA,CAPITULO,TEXTO_LITERAL,TEMA_OPERATIVO,PALABRAS_CLAVE
CERTIFICADO,,,"9A3F",SPEI,PRODUCCION,VIGENTE,2024-01-01,2026-12-31,,,,,,,
EXTENSION,,,,,,,,,"5522","Juan Perez","Soporte",,,,
MANUAL,"Manual devoluciones","Texto del manual...",,,,,,,,,,,,
REGLA_SPEI,,,,"",,,,"",,"",,"","17a","Cap 3","El participante deber√°...","Devoluciones","devolucion retorno rechazo"
`;
      const blob = new Blob([csv], {type:"text/csv"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "layout_spei_ops.csv";
      a.click();
    }

    async function handleBulkUpload(){
      const file = $("file-in").files?.[0];
      if(!file) return toast("Selecciona un archivo", true);

      $("upload-status").textContent = "Leyendo archivo...";
      try{
        let rows = [];
        if(file.name.toLowerCase().endsWith(".csv")){
          const text = await file.text();
          const lines = text.split(/\r?\n/).filter(Boolean);
          const headers = lines[0].split(",").map(h=>h.trim());
          rows = lines.slice(1).map(line=>{
            const cols = line.split(",");
            const obj = {};
            headers.forEach((h,idx)=>obj[h]=cols[idx] ?? "");
            return obj;
          });
        } else {
          const buf = await file.arrayBuffer();
          const wb = XLSX.read(new Uint8Array(buf), {type:"array"});
          const sheet = wb.Sheets[wb.SheetNames[0]];
          rows = XLSX.utils.sheet_to_json(sheet, {defval:""});
        }

        if(!rows.length) return toast("Archivo vac√≠o", true);

        const batch = writeBatch(db);
        const now = Date.now();
        rows.forEach((row,idx)=>{
          const tipo = (row.TIPO || row.tipo || row.Tipo || "").toString().trim().toUpperCase();
          const id = `imp_${now}_${idx}_${Math.random().toString(36).slice(2,7)}`;
          const ref = doc(db,"artifacts",appId,"public","data","knowledge",id);

          const base = {
            date: new Date().toISOString(),
            author: currentUser?.name || "system",
          };

          if(tipo === "CERTIFICADO"){
            const entry = {
              ...base,
              contentType:"CERTIFICADO",
              num: (row.NUMERO||row.num||"").toString().trim(),
              negocio: (row.NEGOCIO||"").toString().trim(),
              entorno: (row.ENTORNO||"").toString().trim(),
              estatus: (row.ESTATUS||"").toString().trim(),
              vigenciaIni: (row.INICIO||row.vigenciaIni||"").toString().trim(),
              vigenciaFin: (row.FIN||row.vigenciaFin||"").toString().trim(),
              title: row.TITULO ? row.TITULO : `CERT ${row.NUMERO||row.num||""}`,
              content: row.CONTENIDO ? row.CONTENIDO : `${row.NEGOCIO||""} | ${row.ESTATUS||""}`,
            };
            batch.set(ref, entry, {merge:true});
            return;
          }

          if(tipo === "EXTENSION"){
            const entry = {
              ...base,
              contentType:"EXTENSION",
              ext: (row.EXTENSION||row.ext||"").toString().trim(),
              nombre: (row.NOMBRE||"").toString().trim(),
              area: (row.AREA||"").toString().trim(),
              title: row.TITULO ? row.TITULO : `EXT ${row.EXTENSION||row.ext||""}`,
              content: row.CONTENIDO ? row.CONTENIDO : `${row.NOMBRE||""} - ${row.AREA||""}`,
            };
            batch.set(ref, entry, {merge:true});
            return;
          }

          if(tipo === "REGLA_SPEI"){
            const entry = {
              ...base,
              contentType:"REGLA_SPEI",
              regla: (row.REGLA||row.Regla||row.regla||"").toString().trim(),
              capitulo: (row.CAPITULO||row.Cap√≠tulo||row.capitulo||"").toString().trim(),
              content: (row.TEXTO_LITERAL||row.Texto_literal||row.CONTENIDO||row.content||"").toString(),
              tema: (row.TEMA_OPERATIVO||row.Tema_operativo||row.tema||row.TITULO||"").toString().trim(),
              keywords: (row.PALABRAS_CLAVE||row.keywords||"").toString(),
              title: row.TITULO ? row.TITULO : `Regla ${(row.REGLA||row.Regla||row.regla||"")}`,
            };
            batch.set(ref, entry, {merge:true});
            return;
          }

          // MANUAL (default)
          const entry = {
            ...base,
            contentType:"MANUAL",
            title: (row.TITULO||"Importado").toString(),
            content: (row.CONTENIDO||"").toString(),
          };
          batch.set(ref, entry, {merge:true});
        });

        await batch.commit();
        $("upload-status").textContent = "";
        toast(`Carga exitosa: ${rows.length} filas`);
        hide("modal-upload");
        renderList(document.body.dataset.viewType || "ALL");
      } catch(e){
        console.error(e);
        $("upload-status").textContent = "";
        toast("Error en carga masiva", true);
      }
    }

    // ====== DELETE SELECTED ======
    async function deleteSelected(){
      const ids = Array.from(document.querySelectorAll(".select-row:checked")).map(cb=>cb.value);
      if(!ids.length) return toast("Nada seleccionado", true);
      if(!confirm(`¬øBorrar ${ids.length} seleccionados?`)) return;

      const type = document.body.dataset.viewType || "ALL";
      const batch = writeBatch(db);
      const col = (type === "USERS") ? "team" : "knowledge";
      ids.forEach(id=>{
        batch.delete(doc(db,"artifacts",appId,"public","data",col,id));
      });
      await batch.commit();
      toast("Eliminados");
    }

    // ====== GEMINI CALL ======
    async function askGemini(question, context, forceIA=false){
      // Importante: NO devolvemos JSON; devolvemos SOLO texto.
      const q = question.trim();
      const prompt =
`Responde en espa√±ol, claro y operativo.
Si te doy CONTEXTO, √∫salo como referencia. Si no, responde de forma general.
Evita devolver JSON o bloques de c√≥digo a menos que el usuario lo pida expl√≠citamente.

CONTEXTO:
${context || "(sin contexto)"}

PREGUNTA:
${q}
`;
      try{
        const res = await fetch("/api/gemini", {
          method:"POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({ prompt })
        });

        if(!res.ok){
          const err = await res.json().catch(()=>({}));
          return `‚ùå Error API (${res.status}): ${err?.error || err?.message || "No se pudo consultar la IA"}`;
        }
        const data = await res.json().catch(()=>null);
        const text = data?.text || data?.candidates?.[0]?.content?.parts?.[0]?.text;
        return (text && String(text).trim()) ? String(text).trim() : "Sin respuesta de IA.";
      } catch(e){
        return "Error de conexi√≥n con la IA.";
      }
    }

    // ====== CHAT FLOW ======
    function addMsg(html, isUser){
      const bubble = document.createElement("div");
      bubble.className = `chat-bubble ${isUser ? "user-msg" : "bot-msg"}`;
      bubble.innerHTML = html;

      const row = document.createElement("div");
      row.className = `flex w-full ${isUser ? "justify-end" : "justify-start"} mb-2`;
      row.appendChild(bubble);

      $("chat-box").appendChild(row);
      $("chat-box").scrollTop = $("chat-box").scrollHeight;
    }

    function buildInternalContext(hits){
      // compact context for IA
      return hits.slice(0,10).map(x=>{
        const t = x.contentType || "MANUAL";
        if(t==="REGLA_SPEI"){
          return `REGLA ${x.regla || ""} | Cap ${x.capitulo || ""} | Tema ${x.tema || ""}\n${(x.content||"").toString().slice(0,1200)}`;
        }
        if(t==="CERTIFICADO"){
          return `CERT ${x.num || ""} | ${x.negocio||""} | ${x.estatus||""} | Fin ${x.vigenciaFin||""}`;
        }
        if(t==="EXTENSION"){
          return `EXT ${x.ext||""} | ${x.nombre||""} | ${x.area||""}`;
        }
        return `${x.title||""}\n${(x.content||"").toString().slice(0,800)}`;
      }).join("\n\n---\n\n");
    }

    function searchKB(query){
      const q = normStr(query);
      if(!q) return [];
      return knowledgeBase.filter(k=>{
        const blob = normStr((k.title||"") + " " + (k.content||"") + " " + (k.tema||"") + " " + (k.keywords||""));
        return blob.includes(q);
      });
    }

    $("chat-form").onsubmit = async (e) => {
      e.preventDefault();
      const raw = $("chat-input").value.trim();
      if(!raw) return;
      $("chat-input").value = "";
      addMsg(raw, true);

      const forceIA = raw.startsWith("/ia");
      const q = forceIA ? raw.replace(/^\/ia\s*/,"").trim() : raw;

      // 1) internal search
      const hits = searchKB(q);
      if(hits.length){
        // show quick internal summary
        let html = `<div class="mb-2 font-black text-xs text-blue-600">BASE INTERNA (${hits.length})</div>`;
        hits.slice(0,6).forEach(x=>{
          if(x.contentType==="CERTIFICADO"){
            html += `<div class="bg-blue-50 p-2 rounded mb-1 text-xs border border-blue-100 font-mono"><b>CERT ${x.num||""}</b><br>${x.negocio||""} | ${x.estatus||""} | Vence: ${x.vigenciaFin||""}</div>`;
          } else if(x.contentType==="EXTENSION"){
            html += `<div class="bg-emerald-50 p-2 rounded mb-1 text-xs border border-emerald-100"><b>${x.ext||""}</b> - ${x.nombre||""} <span class="text-slate-500">(${x.area||""})</span></div>`;
          } else if(x.contentType==="REGLA_SPEI"){
            html += `<div class="bg-amber-50 p-2 rounded mb-1 text-xs border border-amber-100"><b>Regla ${x.regla||""}</b> <span class="text-slate-500">(${x.capitulo||""})</span><div class="mt-1 text-slate-700">${(x.tema||"").toString()}</div></div>`;
          } else {
            html += `<div class="bg-white p-2 rounded mb-1 text-xs border"><b>${x.title||"Manual"}</b></div>`;
          }
        });
        addMsg(html, false);

        if(!forceIA){
          addMsg(`<div class="text-xs text-slate-600 font-bold">Si necesitas aclaraci√≥n con IA, escribe <b>/ia</b> + tu pregunta.</div>`, false);
          return;
        }
      }

      // 2) IA (forzada o sin match)
      addMsg(`<div class="text-xs text-slate-500 font-black">Consultando IA...</div>`, false);
      const ctx = hits.length ? buildInternalContext(hits) : "";
      const ans = await askGemini(q, ctx, forceIA);
      addMsg(`<div class="reg-card"><div class="reg-content" style="font-style:normal">${ans.replace(/\n/g,"<br>")}</div><div class="reg-footer">IA</div></div>`, false);
    };

    // ====== AUTH / LOGIN ======
    function applyRoleUI(role){
      $("user-role").textContent = role === "admin" ? "ADMIN" : "OPERATIVO";
      if(role === "admin"){
        document.querySelectorAll(".admin-only").forEach(e=>e.classList.remove("hidden-ui"));
      } else {
        document.querySelectorAll(".admin-only").forEach(e=>e.classList.add("hidden-ui"));
      }
    }

    function loginAs(user){
      currentUser = user;
      localStorage.setItem("spei_session", JSON.stringify(user));
      $("user-name").textContent = user.name || "Usuario";
      $("avatar").textContent = (user.name || "U").split(" ").slice(0,2).map(s=>s[0]).join("").toUpperCase();
      applyRoleUI(user.role || "user");
      hide("login");
      hide("loading");
      show("app");
      navigate("chat");
    }

    function logout(){
      localStorage.removeItem("spei_session");
      location.reload();
    }

    function findUserByEmp(emp){
      if(emp === ADMIN_ID) return { name:"Daniel Anzaldo", role:"admin", empNumber:ADMIN_ID };
      const u = team.find(x => (x.empNumber||x.id) === emp);
      return u ? { ...u } : null;
    }

    async function ensureAdminSeed(){
      // si no existe admin, lo crea (solo 1 vez)
      const exists = team.some(x => (x.empNumber||x.id) === ADMIN_ID);
      if(!exists){
        await setDoc(doc(db,"artifacts",appId,"public","data","team",ADMIN_ID), { name:"Daniel Anzaldo", role:"admin", empNumber:ADMIN_ID }, {merge:true});
      }
    }

    // ====== USERS ======
    async function saveUser(){
      const name = $("u-name").value.trim();
      const emp = $("u-id").value.trim();
      const role = $("u-role").value;
      if(!name || !emp) return toast("Faltan datos", true);

      await setDoc(doc(db,"artifacts",appId,"public","data","team",emp), { name, empNumber:emp, role }, {merge:true});
      toast("Usuario creado");
      hide("modal-user");
      $("u-name").value = ""; $("u-id").value = "";
      renderList("USERS");
    }

    // ====== INIT ======
    async function initAuth(){
      try{
        if(typeof __initial_auth_token !== "undefined" && __initial_auth_token){
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch(e){
        console.error(e);
      }
    }

    async function init(){
      await initAuth();

      // bind UI events
      $("btn-open-sidebar").onclick = openSidebar;
      $("btn-close-sidebar").onclick = closeSidebar;
      $("sidebar-backdrop").onclick = closeSidebar;
      $("btn-logout").onclick = logout;

      $("nav-chat").onclick = () => navigate("chat");
      $("nav-all").onclick = () => navigate("all");
      $("nav-rules").onclick = () => navigate("rules");
      $("nav-cert").onclick = () => navigate("cert");
      $("nav-ext").onclick = () => navigate("ext");
      $("nav-docs").onclick = () => navigate("docs");
      $("nav-files").onclick = () => navigate("files");
      $("nav-users").onclick = () => navigate("users");

      $("btn-refresh").onclick = () => renderList(document.body.dataset.viewType || "ALL");
      $("table-search").onkeyup = () => renderList(document.body.dataset.viewType || "ALL");
      $("select-all").onchange = (e) => document.querySelectorAll(".select-row").forEach(cb => cb.checked = e.target.checked);

      // modals close
      document.querySelectorAll("[data-close]").forEach(btn=>{
        btn.onclick = () => hide(btn.getAttribute("data-close"));
      });

      $("btn-template").onclick = downloadTemplate;
      $("btn-upload").onclick = handleBulkUpload;
      $("btn-save-user").onclick = saveUser;

      $("btn-login").onclick = () => {
        const emp = $("login-id").value.trim();
        const u = findUserByEmp(emp);
        if(!u){
          $("login-msg").style.opacity = "1";
          return;
        }
        $("login-msg").style.opacity = "0";
        loginAs(u);
      };

      // firestore listeners
      onAuthStateChanged(auth, async (u)=>{
        if(!u) return;
        $("loading-hint").textContent = "Cargando usuarios/base...";
        onSnapshot(collection(db,"artifacts",appId,"public","data","team"), async (snap)=>{
          team = snap.docs.map(d => ({ id:d.id, ...d.data() }));
          await ensureAdminSeed();

          // session restore
          const saved = localStorage.getItem("spei_session");
          if(saved){
            const s = JSON.parse(saved);
            // refresh role from firestore
            const fresh = findUserByEmp(s.empNumber || s.id || s.empNumber) || s;
            loginAs(fresh);
          } else {
            hide("loading");
            show("login");
          }
        });

        onSnapshot(collection(db,"artifacts",appId,"public","data","knowledge"), (snap)=>{
          knowledgeBase = snap.docs.map(d => ({ id:d.id, ...d.data() }));
          // refresh list if open
          const t = document.body.dataset.viewType;
          if(t && $("view-table").classList.contains("active")) renderList(t);
        });
      });
    }

    window.addEventListener("load", init);
  </script>
</body>
</html>
