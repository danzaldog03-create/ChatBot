<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <!-- Metaetiquetas para forzar actualizaci√≥n inmediata -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <title>SPEI Ops - Speikito v30.2</title>

  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/616/616430.png" />

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
    window.MathJax = { tex: { inlineMath: [["$", "$"]] }, options: { enableMenu: false } };
  </script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, collection, onSnapshot, updateDoc, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Configuraci√≥n con fallback robusto
    let firebaseConfig;
    try {
      firebaseConfig = JSON.parse(window.__firebase_config);
    } catch (e) {
      firebaseConfig = {
        apiKey: "AIzaSyDPi5pcDL6OL2zCJK_0n3A_RdDGt3U3LVQ",
        authDomain: "chatbot-8d0a3.firebaseapp.com",
        projectId: "chatbot-8d0a3",
        storageBucket: "chatbot-8d0a3.firebasestorage.app",
        messagingSenderId: "390359131739",
        appId: "1:390359131739:web:23373d0ba69b4719bb417e",
      };
    }

    const appId = typeof __app_id !== "undefined" ? __app_id : firebaseConfig.projectId;
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    window.fb = {
      auth, db, appId,
      doc, setDoc, collection, onSnapshot, updateDoc, deleteDoc, writeBatch,
      signInAnonymously, signInWithCustomToken, onAuthStateChanged
    };
  </script>

  <style>
    @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap");
    @import url("https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,300;0,700;1,300&display=swap");

    * { box-sizing: border-box; }
    body {
      font-family: "Inter", sans-serif;
      background-color: #f1f5f9;
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    /* Layout */
    .layout-container { display: flex; height: 100%; width: 100%; }
    .sidebar {
      width: 280px;
      background: #0f172a;
      color: #94a3b8;
      display: flex;
      flex-direction: column;
      border-right: 1px solid #1e293b;
      transition: transform 0.3s;
      flex-shrink: 0;
      z-index: 50;
    }
    .sidebar-header {
      padding: 1.5rem;
      border-bottom: 1px solid #1e293b;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      color: white;
      font-weight: 800;
      font-size: 1.1rem;
    }
    .nav-scroll { flex: 1; overflow-y: auto; padding: 1rem 0; }
    .nav-section {
      font-size: 0.65rem;
      font-weight: 800;
      text-transform: uppercase;
      color: #475569;
      padding: 1rem 1.5rem 0.5rem;
      letter-spacing: 0.05em;
    }
    .nav-item {
      padding: 0.75rem 1.5rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-size: 0.85rem;
      font-weight: 500;
      transition: all 0.2s;
      border-left: 3px solid transparent;
    }
    .nav-item:hover { background: #1e293b; color: white; }
    .nav-item.active { background: #1e293b; color: white; border-left-color: #3b82f6; }

    .main-area { flex: 1; display: flex; flex-direction: column; background: white; position: relative; overflow: hidden; }
    .top-header {
      height: 4rem;
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 2rem;
      background: white;
      shrink: 0;
      z-index: 20;
    }

    .view-section { flex: 1; overflow-y: auto; padding: 2rem; display: none; height: 100%; flex-direction: column; }
    .view-section.active { display: flex; }
    #view-chat { padding: 0; }

    .chat-box { flex: 1; overflow-y: auto; padding: 2rem; background: #f8fafc; }
    .chat-input-area { padding: 1.5rem 2rem; background: white; border-top: 1px solid #e2e8f0; }

    .chat-bubble { max-width: 85%; padding: 1rem 1.25rem; border-radius: 1rem; font-size: 0.9rem; line-height: 1.6; margin-bottom: 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .user-msg { align-self: flex-end; background: #2563eb; color: white; border-bottom-right-radius: 0; margin-left: auto; }
    .bot-msg { align-self: flex-start; background: white; border: 1px solid #e2e8f0; color: #1e293b; border-bottom-left-radius: 0; width: 100%; }
    .bot-header { font-weight: 800; color: #0f172a; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; border-bottom: 2px solid #e2e8f0; padding-bottom: 0.5rem; }

    .reg-card { background: #fffbeb; border-left: 4px solid #f59e0b; padding: 1rem; border-radius: 0.5rem; margin-top: 0.5rem; }
    .reg-title { font-size: 0.75rem; font-weight: 900; color: #92400e; text-transform: uppercase; margin-bottom: 0.5rem; }
    .reg-content { font-family: "Georgia", serif; font-style: italic; color: #451a03; line-height: 1.6; font-size: 0.95rem; }
    .reg-footer { margin-top: 0.5rem; font-size: 0.7rem; color: #b45309; font-weight: 700; text-align: right; }

    #table-content { flex: 1; overflow-y: auto; padding-bottom: 6rem; display: flex; flex-direction: column; gap: 0.75rem; min-height: 300px; }
    .data-card { background: white; border: 1px solid #e2e8f0; border-radius: 0.75rem; padding: 1rem; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.05); min-height: 80px; }
    .data-card:hover { border-color: #3b82f6; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); transform: translateY(-1px); }

    .badge { font-size: 0.65rem; font-weight: 800; text-transform: uppercase; padding: 0.25rem 0.5rem; border-radius: 99px; display: inline-block; margin-bottom: 0.25rem; }
    .badge-CERTIFICADO { background: #eff6ff; color: #1d4ed8; }
    .badge-EXTENSION { background: #f0fdf4; color: #15803d; }
    .badge-MANUAL { background: #f8fafc; color: #475569; }
    .badge-REGLA_SPEI { background: #fffbeb; color: #b45309; }
    .badge-ARCHIVO { background: #e0f2fe; color: #0369a1; }
    .badge-USER { background: #eef2ff; color: #4338ca; }

    .form-input { width: 100%; padding: 0.7rem; border: 1px solid #cbd5e1; rounded: 0.5rem; font-size: 0.85rem; outline: none; transition: 0.2s; background: white; color: #1e293b !important; font-weight: 600; }
    .form-input:focus { border-color: #2563eb; ring: 2px solid #bfdbfe; }
    .form-label { font-size: 0.7rem; font-weight: 700; color: #64748b; margin-bottom: 0.25rem; display: block; text-transform: uppercase; }

    .overlay { position: fixed; inset: 0; background: rgba(15,23,42,0.95); backdrop-filter: blur(4px); z-index: 60; display: flex; align-items: center; justify-content: center; }
    .modal { background: white; width: 90%; max-width: 800px; max-height: 90vh; border-radius: 1rem; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); }

    .hidden-ui { display: none !important; opacity: 0; pointer-events: none; }
    .admin-only.hidden-ui { display: none !important; }

    #toast { position: fixed; top: 2rem; left: 50%; transform: translateX(-50%); z-index: 10001; padding: 0.75rem 1.5rem; border-radius: 99px; font-weight: 700; font-size: 0.85rem; color: white; background: #0f172a; opacity: 0; pointer-events: none; transition: 0.3s; }
    #toast.show { opacity: 1; top: 3rem; }

    .select-row { width: 1.2rem; height: 1.2rem; margin-right: 1rem; cursor: pointer; accent-color: #2563eb; }

    .avatar-circle { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; background-color: #334155; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; font-size: 0.7rem; cursor: pointer; border: 2px solid #475569; }
    .avatar-circle:hover { border-color: white; }

    @media (max-width: 768px) {
      .sidebar { position: fixed; height: 100%; transform: translateX(-100%); }
      .sidebar.open { transform: translateX(0); }
    }

    /* =======================
       LOGIN - MODO PRO (NEW)
       ======================= */

    #login-screen.overlay {
      background:
        radial-gradient(1200px 600px at 20% 20%, rgba(59,130,246,0.35), transparent 60%),
        radial-gradient(900px 500px at 80% 70%, rgba(245,158,11,0.25), transparent 60%),
        linear-gradient(rgba(2,6,23,0.55), rgba(2,6,23,0.65)),
        url("speikitologin.png") center center / cover no-repeat !important;
      backdrop-filter: blur(6px);
      display: flex;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.35s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.99); }
      to   { opacity: 1; transform: scale(1); }
    }

    .login-pro-shell {
      width: 100%;
      max-width: 560px;
      padding: 28px;
      border-radius: 24px;
      background: rgba(255,255,255,0.10);
      border: 1px solid rgba(255,255,255,0.18);
      box-shadow: 0 25px 70px rgba(0,0,0,0.45);
      backdrop-filter: blur(18px);
      position: relative;
      overflow: hidden;
    }

    .login-pro-shell::before {
      content: "";
      position: absolute;
      inset: -40px;
      background:
        radial-gradient(400px 220px at 15% 10%, rgba(59,130,246,0.25), transparent 60%),
        radial-gradient(380px 240px at 85% 40%, rgba(245,158,11,0.18), transparent 60%);
      filter: blur(6px);
      pointer-events: none;
    }

    .login-pro-inner { position: relative; z-index: 2; color: white; text-align: center; }

    .login-pro-badge {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      border-radius: 999px;
      background: rgba(255,255,255,0.12);
      border: 1px solid rgba(255,255,255,0.18);
      font-weight: 900;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      font-size: 12px;
      margin-bottom: 16px;
    }

    .login-pro-title {
      font-size: 30px;
      font-weight: 1000;
      line-height: 1.15;
      text-shadow: 0 10px 30px rgba(0,0,0,0.5);
      margin-bottom: 10px;
    }

    .login-pro-sub {
      font-size: 14px;
      opacity: 0.92;
      line-height: 1.55;
      margin-bottom: 18px;
    }

    .login-pro-cta {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      width: 100%;
      padding: 14px 18px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.18);
      background: linear-gradient(180deg, rgba(59,130,246,0.95), rgba(37,99,235,0.95));
      font-size: 16px;
      font-weight: 900;
      cursor: pointer;
      box-shadow: 0 18px 40px rgba(37,99,235,0.35);
      transition: transform 0.18s ease, filter 0.18s ease;
      margin-bottom: 14px;
    }

    .login-pro-cta:hover { transform: translateY(-1px); filter: brightness(1.03); }
    .login-pro-cta:active { transform: translateY(0px) scale(0.99); }

    .login-pro-divider {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 12px 0 16px;
      opacity: 0.85;
      font-weight: 800;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }
    .login-pro-divider::before,
    .login-pro-divider::after {
      content: "";
      flex: 1;
      height: 1px;
      background: rgba(255,255,255,0.22);
    }

    .login-pro-input {
      width: 100%;
      max-width: 320px;
      padding: 14px 14px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.22);
      background: rgba(2,6,23,0.25);
      color: #fff;
      font-weight: 900;
      letter-spacing: 0.12em;
      text-align: center;
      outline: none;
      transition: 0.18s;
    }
    .login-pro-input:focus { border-color: rgba(59,130,246,0.95); box-shadow: 0 0 0 4px rgba(59,130,246,0.20); }

    .login-pro-btn {
      margin-top: 12px;
      width: 100%;
      max-width: 320px;
      padding: 12px 14px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(15,23,42,0.55);
      color: rgba(255,255,255,0.92);
      font-weight: 900;
      cursor: pointer;
      transition: 0.18s;
    }
    .login-pro-btn:hover { background: rgba(15,23,42,0.70); }
    .login-pro-err {
      margin-top: 10px;
      font-size: 12px;
      font-weight: 900;
      color: #fecaca;
      opacity: 0;
      transition: 0.2s;
    }

    .login-pro-foot {
      margin-top: 22px;
      font-size: 11px;
      font-weight: 900;
      letter-spacing: 0.10em;
      text-transform: uppercase;
      opacity: 0.7;
    }
  </style>
</head>

<body>
  <div id="toast">Notificaci√≥n</div>

  <!-- CARGA -->
  <div id="loading-screen" class="overlay">
    <div class="text-center">
      <div class="w-16 h-16 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
      <p class="text-xs font-bold uppercase tracking-widest text-slate-400">Iniciando Sistema...</p>
    </div>
  </div>

  <!-- LOGIN (MODO PRO) -->
  <div id="login-screen" class="overlay hidden-ui">
    <div class="login-pro-shell">
      <div class="login-pro-inner">
        <div class="login-pro-badge">
          <i class="fas fa-cat text-blue-300"></i>
          SPEI OPS ‚Ä¢ ACCESO
        </div>

        <div class="login-pro-title">
          Hola humano üëã<br/>
          Soy <span style="color:#93c5fd;">Speikito</span>, tu asistente
        </div>

        <div class="login-pro-sub">
          Entra con tu ID corporativo para consultar normativa, certificados, manuales y directorio.
          <br/>Si eres <b>admin</b>, ver√°s gesti√≥n completa.
        </div>

        <button class="login-pro-cta" onclick="focusLogin()">
          <i class="fas fa-comment-dots"></i> Hablar con Speikito
        </button>

        <div class="login-pro-divider">Acceso corporativo</div>

        <div style="display:flex; justify-content:center;">
          <input
            type="text"
            id="login-id"
            class="login-pro-input"
            placeholder="ID DE EMPLEADO"
            autocomplete="off"
            inputmode="numeric"
          />
        </div>

        <div style="display:flex; justify-content:center;">
          <button onclick="handleLogin()" id="btn-login" class="login-pro-btn">
            <i class="fas fa-fingerprint mr-2"></i> INGRESAR
          </button>
        </div>

        <div id="login-msg" class="login-pro-err">Credenciales incorrectas</div>

        <div class="login-pro-foot">v30.2 ‚Ä¢ Creado por Daniel Anzaldo</div>
      </div>
    </div>
  </div>

  <!-- APP PRINCIPAL -->
  <div id="app-layout" class="layout-container hidden-ui">
    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <i class="fas fa-cat text-blue-500 text-xl"></i> SPEI Ops
        <button class="ml-auto md:hidden text-slate-400" onclick="toggleSidebar()"><i class="fas fa-times"></i></button>
      </div>

      <div class="nav-scroll">
        <div class="nav-section">Operaci√≥n</div>
        <div onclick="navigate('chat')" class="nav-item active" id="nav-chat"><i class="fas fa-comments w-5"></i> Speikito</div>

        <div class="admin-only hidden-ui">
          <div class="nav-section">Gesti√≥n</div>
          <div onclick="navigate('admin-all')" class="nav-item text-blue-400" id="nav-all"><i class="fas fa-globe w-5"></i> VER TODO</div>
          <div onclick="navigate('admin-rules')" class="nav-item text-amber-500" id="nav-rules"><i class="fas fa-balance-scale w-5"></i> Normativa SPEI</div>
          <div onclick="navigate('admin-cert')" class="nav-item" id="nav-cert"><i class="fas fa-certificate w-5"></i> Certificados</div>
          <div onclick="navigate('admin-ext')" class="nav-item" id="nav-ext"><i class="fas fa-address-book w-5"></i> Directorio</div>
          <div onclick="navigate('admin-docs')" class="nav-item" id="nav-docs"><i class="fas fa-file-alt w-5"></i> Manuales</div>
          <div onclick="navigate('admin-files')" class="nav-item" id="nav-files"><i class="fas fa-folder w-5"></i> Archivos</div>

          <div class="nav-section">Sistema</div>
          <div onclick="navigate('admin-users')" class="nav-item text-indigo-400" id="nav-users"><i class="fas fa-users-cog w-5"></i> Usuarios</div>
        </div>
      </div>

      <div class="p-4 border-t border-slate-800">
        <div class="flex items-center gap-3 mb-4">
          <div onclick="openProfileModal()" class="avatar-circle" id="user-avatar-container">
            <span id="user-initials">DA</span>
            <img id="user-img-display" class="hidden w-full h-full rounded-full object-cover" src="" />
          </div>
          <div class="overflow-hidden">
            <p class="text-xs font-bold text-white truncate" id="user-name-display">Usuario</p>
            <p class="text-[10px] text-slate-400 uppercase font-bold truncate" id="user-role-display">Rol</p>
          </div>
        </div>
        <button onclick="logout()" class="w-full bg-slate-800 hover:bg-red-900/50 text-slate-300 hover:text-red-200 py-2 rounded text-xs font-bold transition-all">
          <i class="fas fa-sign-out-alt mr-2"></i>Cerrar Sesi√≥n
        </button>
      </div>
    </aside>

    <div class="fixed inset-0 bg-black/50 z-40 hidden md:hidden" id="sidebar-backdrop" onclick="toggleSidebar()"></div>

    <!-- CONTENIDO -->
    <main class="main-area">
      <div class="top-header">
        <div class="flex items-center gap-3">
          <button class="md:hidden text-slate-500 text-xl" onclick="toggleSidebar()"><i class="fas fa-bars text-xl"></i></button>
          <h2 class="font-black text-slate-800 text-lg" id="page-title">Chat Operativo</h2>
        </div>
        <div class="flex gap-2" id="header-actions"></div>
      </div>

      <div id="view-chat" class="view-section active">
        <div id="chat-box" class="chat-box space-y-4">
          <div class="bot-msg chat-bubble shadow-sm w-full">
            <div class="bot-header"><i class="fas fa-cat text-blue-600"></i> Speikito</div>
            <p class="text-sm text-slate-600">
              Hola. Soy <b>Speikito</b> üê±. Puedo consultar tu base interna y tambi√©n la IA cuando aplique.
            </p>
          </div>
        </div>

        <div class="chat-input-area">
          <form id="chat-form" class="relative max-w-5xl mx-auto flex gap-2">
            <input
              type="text"
              id="chat-input"
              placeholder="Ej: ¬øQu√© regla aplica para devoluciones?"
              class="flex-1 bg-slate-50 border border-slate-200 rounded-2xl px-6 py-4 text-sm font-bold text-slate-700 outline-none focus:border-blue-500 transition-all"
              autocomplete="off"
            />
            <button type="submit" class="w-14 bg-blue-600 text-white rounded-2xl flex items-center justify-center shadow-lg hover:bg-blue-700 active:scale-90 transition-all">
              <i class="fas fa-paper-plane text-lg"></i>
            </button>
          </form>
        </div>
      </div>

      <div id="view-table" class="view-section hidden-ui h-full flex flex-col">
        <div class="mb-4 sticky top-0 bg-[#f8fafc] z-10 py-2 flex gap-2 items-center">
          <input type="checkbox" id="select-all" class="ml-2 w-4 h-4 accent-blue-600" onchange="toggleSelectAll(this)" />
          <input type="text" id="table-search" placeholder="Filtrar..." class="form-input max-w-sm shadow-sm flex-1" onkeyup="filterList()" />
          <button onclick="renderList(document.body.dataset.viewType)" class="w-10 h-10 bg-white border border-slate-300 rounded-lg flex items-center justify-center text-slate-500 hover:text-blue-600">
            <i class="fas fa-sync-alt"></i>
          </button>
        </div>
        <div id="table-content" class="space-y-2 pb-20 overflow-y-auto w-full">
          <div class="text-center py-10 text-slate-400 italic">Cargando datos...</div>
        </div>
      </div>
    </main>
  </div>

  <!-- MODAL REGISTRO -->
  <div id="modal-capture" class="overlay hidden-ui">
    <div class="modal">
      <div class="p-5 border-b flex justify-between items-center bg-slate-50">
        <h3 class="font-bold text-slate-800">Nuevo Registro</h3>
        <button onclick="closeModal('modal-capture')" class="text-slate-400 hover:text-red-500"><i class="fas fa-times"></i></button>
      </div>
      <div class="p-6 overflow-y-auto bg-white flex-1">
        <div class="mb-6">
          <label class="form-label">Tipo de Registro</label>
          <div class="grid grid-cols-2 gap-3 mb-2">
            <button onclick="setFormType('CERTIFICADO')" class="type-btn p-3 border rounded-xl text-xs font-bold text-center hover:bg-blue-50 focus:ring-2 ring-blue-500">
              <i class="fas fa-certificate block text-xl mb-1 text-blue-500"></i> Certificado
            </button>
            <button onclick="setFormType('EXTENSION')" class="type-btn p-3 border rounded-xl text-xs font-bold text-center hover:bg-emerald-50 focus:ring-2 ring-emerald-500">
              <i class="fas fa-address-book block text-xl mb-1 text-emerald-500"></i> Extensi√≥n
            </button>
            <button onclick="setFormType('REGLA')" class="type-btn p-3 border rounded-xl text-xs font-bold text-center hover:bg-amber-50 focus:ring-2 ring-amber-500">
              <i class="fas fa-balance-scale block text-xl mb-1 text-amber-500"></i> Regla
            </button>
            <button onclick="setFormType('MANUAL')" class="type-btn p-3 border rounded-xl text-xs font-bold text-center hover:bg-slate-100 focus:ring-2 ring-slate-500">
              <i class="fas fa-book block text-xl mb-1 text-slate-500"></i> Manual
            </button>
          </div>
          <input type="hidden" id="current-type" value="MANUAL" />
          <input type="hidden" id="editing-id" value="" />
        </div>

        <div id="forms-area">
          <div id="form-cert" class="hidden space-y-4">
            <div class="grid grid-cols-2 gap-4">
              <div><label class="form-label">√öltimos 4</label><input id="c-num" class="form-input uppercase" maxlength="4" /></div>
              <div><label class="form-label">Negocio</label><select id="c-neg" class="form-input"><option>SPEI</option><option>CODI</option><option>DIMO</option><option>SPID</option><option>BDT</option><option>R2</option></select></div>
              <div><label class="form-label">Entorno</label><select id="c-env" class="form-input"><option>PRODUCCION</option><option>BETA</option></select></div>
              <div><label class="form-label">Estatus</label><input type="text" id="c-stat" class="form-input" /></div>
              <div><label class="form-label">Vigencia Inicio</label><input id="c-ini" type="date" class="form-input" /></div>
              <div><label class="form-label">Vigencia Fin</label><input id="c-fin" type="date" class="form-input" /></div>
            </div>
          </div>

          <div id="form-ext" class="hidden space-y-4">
            <div class="grid grid-cols-2 gap-4">
              <div><label class="form-label">Extensi√≥n</label><input id="e-num" type="text" class="form-input" /></div>
              <div><label class="form-label">Nombre</label><input id="e-nom" type="text" class="form-input" /></div>
              <div class="col-span-2"><label class="form-label">√Årea</label><input id="e-area" class="form-input" /></div>
            </div>
          </div>

          <div id="form-rule" class="hidden space-y-4">
            <div class="grid grid-cols-2 gap-4">
              <div><label class="form-label">Regla</label><input id="r-rule" class="form-input" placeholder="Ej. 17a" /></div>
              <div><label class="form-label">Cap√≠tulo</label><input id="r-chap" class="form-input" placeholder="Ej. Cap 2" /></div>
            </div>
            <div><label class="form-label">Tema Operativo</label><input id="r-topic" class="form-input" /></div>
            <div><label class="form-label">Texto Literal</label><textarea id="r-text" class="form-input h-32"></textarea></div>
          </div>

          <div id="form-doc" class="hidden space-y-4">
            <div><label class="form-label">T√≠tulo</label><input id="d-title" class="form-input" /></div>
            <div><label class="form-label">Contenido</label><textarea id="d-content" class="form-input h-32"></textarea></div>
          </div>
        </div>
      </div>

      <div class="p-5 border-t bg-slate-50 flex justify-end gap-3">
        <button onclick="closeModal('modal-capture')" class="text-slate-500 font-bold text-xs px-4">Cancelar</button>
        <button onclick="saveRegistry()" class="bg-slate-900 text-white px-6 py-2.5 rounded-xl font-bold text-xs shadow-lg hover:bg-blue-600 transition-all">GUARDAR</button>
      </div>
    </div>
  </div>

  <!-- MODAL CARGA MASIVA -->
  <div id="modal-upload" class="overlay hidden-ui">
    <div class="modal max-w-lg">
      <div class="p-5 border-b bg-slate-50"><h3 class="font-bold text-amber-700">Cargar Layout Masivo</h3></div>
      <div class="p-8 text-center">
        <p class="text-xs text-slate-500 mb-4 text-left leading-relaxed">
          Sube tu archivo (.xlsx/.csv) para cargar de forma masiva:
          <b>Reglas, Certificados, Extensiones y Manuales</b>.
        </p>
        <div class="p-8 text-center border-2 border-dashed border-amber-300 bg-amber-50 rounded-xl cursor-pointer hover:bg-amber-100 transition-colors" onclick="document.getElementById('file-in').click()">
          <i class="fas fa-upload text-4xl text-amber-500 mb-3"></i>
          <p class="text-sm font-bold text-amber-800">Seleccionar Archivo</p>
        </div>
        <input type="file" id="file-in" class="hidden" accept=".xlsx,.csv" onchange="handleBulkUpload(this)" />
      </div>
      <div class="p-5 border-t flex justify-end">
        <button onclick="document.getElementById('modal-upload').classList.add('hidden-ui')" class="text-slate-400 font-bold text-xs">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- MODAL PERFIL -->
  <div id="modal-profile" class="overlay hidden-ui">
    <div class="modal max-w-sm">
      <div class="p-5 border-b bg-slate-50"><h3 class="font-bold">Foto de Perfil</h3></div>
      <div class="p-8 text-center">
        <div class="w-24 h-24 rounded-full bg-slate-200 mx-auto mb-4 overflow-hidden border-4 border-white shadow-lg cursor-pointer" onclick="document.getElementById('profile-up').click()">
          <img id="profile-prev" src="" class="w-full h-full object-cover hidden" />
          <i id="profile-icon" class="fas fa-camera text-3xl text-slate-400 mt-8"></i>
        </div>
        <input type="file" id="profile-up" class="hidden" accept="image/*" onchange="handleProfileUpload(this)" />
        <p class="text-xs text-slate-500">Clic para cambiar</p>
      </div>
      <div class="p-5 border-t text-center"><button onclick="closeModal('modal-profile')" class="text-slate-400 text-xs">Cerrar</button></div>
    </div>
  </div>

  <!-- MODAL USUARIO -->
  <div id="modal-user" class="overlay hidden-ui">
    <div class="modal max-w-sm">
      <div class="p-5 border-b bg-slate-50"><h3 class="font-bold">Nuevo Usuario</h3></div>
      <div class="p-6 space-y-4">
        <input id="u-name" class="form-input" placeholder="Nombre" />
        <input id="u-id" class="form-input" placeholder="ID Empleado" />
        <select id="u-role" class="form-input">
          <option value="user">Usuario Operativo</option>
          <option value="admin">Administrador</option>
        </select>
        <button onclick="saveUser()" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg font-bold text-xs mt-4">Crear</button>
      </div>
      <div class="p-4 text-center"><button onclick="closeModal('modal-user')" class="text-slate-400 text-xs">Cancelar</button></div>
    </div>
  </div>

  <script type="module">
    const { auth, db, appId, doc, setDoc, collection, onSnapshot, deleteDoc, signInAnonymously, onAuthStateChanged, signInWithCustomToken, writeBatch } = window.fb;

    let currentUser = null;
    let knowledgeBase = [];
    let team = [];

    // --- GLOBAL ---
    window.toast = (m, e) => {
      const t = document.getElementById("toast");
      t.innerText = m;
      t.className = `fixed top-6 left-1/2 -translate-x-1/2 px-6 py-3 rounded-full text-xs font-black shadow-2xl z-[10002] transition-all opacity-100 ${e ? "bg-red-500 text-white" : "bg-emerald-500 text-white"}`;
      setTimeout(() => t.classList.remove("opacity-100"), 3000);
    };

    window.toggleSidebar = () => document.getElementById("sidebar").classList.toggle("open");
    window.closeModal = (id) => document.getElementById(id).classList.add("hidden-ui");
    window.openModal = (id) => {
      document.getElementById(id).classList.remove("hidden-ui");
      if (id === "modal-capture") { window.setFormType("MANUAL"); document.getElementById("editing-id").value = ""; }
    };

    // LOGIN PRO helpers
    window.focusLogin = () => {
      const el = document.getElementById("login-id");
      if (el) el.focus();
    };

    function showLoginError(msg = "Credenciales incorrectas") {
      const p = document.getElementById("login-msg");
      if (!p) return;
      p.textContent = msg;
      p.style.opacity = "1";
      setTimeout(() => (p.style.opacity = "0"), 2200);
    }

    window.handleLogin = () => {
      const val = document.getElementById("login-id").value.trim();

      // Admin hardcode (t√∫)
      if (val === "682930") { login({ name: "Daniel Anzaldo", role: "admin", empNumber: "682930" }); return; }

      const u = team.find((x) => x.empNumber === val);
      if (u) login(u);
      else showLoginError();
    };

    // Enter para ingresar
    document.addEventListener("keydown", (e) => {
      const loginVisible = !document.getElementById("login-screen").classList.contains("hidden-ui");
      if (loginVisible && e.key === "Enter") {
        e.preventDefault();
        window.handleLogin();
      }
    });

    window.logout = () => { localStorage.removeItem("spei_v30_2_session"); location.reload(); };

    // NAV
    window.navigate = (view) => {
      if (window.innerWidth < 768) document.getElementById("sidebar").classList.remove("open");
      document.querySelectorAll(".nav-item").forEach((n) => n.classList.remove("active"));

      const chat = document.getElementById("view-chat");
      const table = document.getElementById("view-table");
      const title = document.getElementById("page-title");
      const acts = document.getElementById("header-actions");

      if (view === "chat") {
        document.getElementById("nav-chat").classList.add("active");
        chat.classList.remove("hidden-ui");
        table.classList.add("hidden-ui");
        title.innerText = "Chat Operativo";
        acts.innerHTML = "";
      } else {
        let type = "ALL", label = "Base Completa", navId = "nav-all";
        if (view === "admin-rules") { type = "REGLA_SPEI"; label = "Normativa SPEI"; navId = "nav-rules"; }
        if (view === "admin-cert")  { type = "CERTIFICADO"; label = "Certificados"; navId = "nav-cert"; }
        if (view === "admin-ext")   { type = "EXTENSION"; label = "Directorio"; navId = "nav-ext"; }
        if (view === "admin-docs")  { type = "MANUAL"; label = "Manuales"; navId = "nav-docs"; }
        if (view === "admin-files") { type = "ARCHIVO"; label = "Archivos"; navId = "nav-files"; }

        document.getElementById(navId)?.classList.add("active");
        chat.classList.add("hidden-ui");
        table.classList.remove("hidden-ui");
        title.innerText = label;
        document.body.dataset.viewType = type;

        if (view === "admin-users") {
          title.innerText = "Usuarios";
          document.body.dataset.viewType = "USERS";
          acts.innerHTML = `<button onclick="document.getElementById('modal-user').classList.remove('hidden-ui')" class="bg-indigo-600 text-white px-3 py-1 rounded text-xs font-bold shadow hover:bg-indigo-700">Nuevo Usuario</button>`;
          renderList("USERS");
          return;
        }

        // Acciones admin
        acts.innerHTML = `
          <button onclick="window.openModal('modal-capture')" class="bg-blue-600 text-white px-3 py-1 rounded text-xs font-bold">Nuevo</button>
          <button onclick="document.getElementById('modal-upload').classList.remove('hidden-ui')" class="bg-amber-600 text-white px-3 py-1 rounded text-xs font-bold shadow hover:bg-amber-700"><i class="fas fa-upload"></i> Carga masiva</button>
          <button onclick="window.deleteSelected()" class="bg-red-50 text-red-600 px-3 py-1 rounded-lg text-xs font-bold shadow-sm hover:bg-red-100 transition-all"><i class="fas fa-trash-alt"></i> Borrar</button>
        `;

        renderList(type);
      }
    };

    window.setFormType = (t) => {
      document.getElementById("current-type").value = t;
      ["form-cert", "form-ext", "form-rule", "form-doc"].forEach((f) => document.getElementById(f).classList.add("hidden"));
      if (t === "CERTIFICADO") document.getElementById("form-cert").classList.remove("hidden");
      else if (t === "EXTENSION") document.getElementById("form-ext").classList.remove("hidden");
      else if (t === "REGLA") document.getElementById("form-rule").classList.remove("hidden");
      else document.getElementById("form-doc").classList.remove("hidden");
    };

    window.saveRegistry = async () => {
      const type = document.getElementById("current-type").value;
      const id = document.getElementById("editing-id").value || "doc_" + Date.now();
      let data = { contentType: type, date: new Date().toISOString(), author: currentUser.name };

      if (type === "CERTIFICADO") {
        data.num = document.getElementById("c-num").value;
        data.negocio = document.getElementById("c-neg").value;
        data.entorno = document.getElementById("c-env").value;
        data.estatus = document.getElementById("c-stat").value;
        data.vigenciaIni = document.getElementById("c-ini").value;
        data.vigenciaFin = document.getElementById("c-fin").value;
        data.title = `CERT ${data.num}`;
        data.content = `${data.negocio} | ${data.entorno} | ${data.estatus}`;
      } else if (type === "EXTENSION") {
        data.ext = document.getElementById("e-num").value;
        data.nombre = document.getElementById("e-nom").value;
        data.area = document.getElementById("e-area").value;
        data.title = `EXT ${data.ext}`;
        data.content = `${data.nombre} - ${data.area}`;
      } else if (type === "REGLA") {
        data.regla = document.getElementById("r-rule").value;
        data.content = document.getElementById("r-text").value;
        data.capitulo = document.getElementById("r-chap").value;
        data.tema = document.getElementById("r-topic").value;
        data.title = `Regla ${data.regla}`;
      } else {
        data.title = document.getElementById("d-title").value;
        data.content = document.getElementById("d-content").value;
      }

      await setDoc(doc(db, "artifacts", appId, "public", "data", "knowledge", id), data, { merge: true });
      window.toast("Guardado");
      window.closeModal("modal-capture");
      if (document.body.dataset.viewType) renderList(document.body.dataset.viewType);
    };

    window.saveUser = async () => {
      const n = document.getElementById("u-name").value;
      const i = document.getElementById("u-id").value;
      if (!n || !i) return window.toast("Faltan datos", true);
      await setDoc(doc(db, "artifacts", appId, "public", "data", "team", i), { name: n, empNumber: i, role: document.getElementById("u-role").value });
      window.toast("Usuario Creado");
      window.closeModal("modal-user");
      renderList("USERS");
    };

    window.deleteRec = async (id) => { if (confirm("¬øEliminar?")) { await deleteDoc(doc(db, "artifacts", appId, "public", "data", "knowledge", id)); renderList(document.body.dataset.viewType); } };
    window.deleteUser = async (id) => { if (confirm("¬øEliminar?")) { await deleteDoc(doc(db, "artifacts", appId, "public", "data", "team", id)); renderList("USERS"); } };

    // BORRADO MASIVO
    window.toggleSelectAll = (el) => { document.querySelectorAll(".select-row").forEach((cb) => (cb.checked = el.checked)); };

    window.deleteSelected = async () => {
      const selected = Array.from(document.querySelectorAll(".select-row:checked")).map((cb) => cb.value);
      if (selected.length === 0) return window.toast("Nada seleccionado", true);

      if (confirm(`¬øBorrar ${selected.length} registros seleccionados?`)) {
        const batch = window.fb.writeBatch(db);
        const colName = document.body.dataset.viewType === "USERS" ? "team" : "knowledge";

        selected.forEach((id) => {
          const ref = doc(db, "artifacts", appId, "public", "data", colName, id);
          batch.delete(ref);
        });

        await batch.commit();
        window.toast(`${selected.length} registros eliminados`);
        if (document.body.dataset.viewType === "USERS") renderList("USERS");
        else renderList(document.body.dataset.viewType);
      }
    };

    // CARGA MASIVA (layout flexible)
    window.handleBulkUpload = async (input) => {
      const f = input.files[0];
      if (!f) return;
      const reader = new FileReader();

      reader.onload = async (e) => {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: "array" });
        const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);

        const batch = window.fb.writeBatch(db);

        json.forEach((row) => {
          const id = "imp_" + Date.now() + "_" + Math.random().toString(36).slice(2, 7);
          const ref = doc(db, "artifacts", appId, "public", "data", "knowledge", id);
          let entry = { date: new Date().toISOString(), author: currentUser?.name || "system" };

          // Reglas
          if (row.Regla || row.REGLA) {
            entry.contentType = "REGLA_SPEI";
            entry.regla = row.Regla || row.REGLA;
            entry.capitulo = row.Cap√≠tulo || row.CAPITULO || row.CAPITULO_SPEI;
            entry.content = row.Texto_literal || row.TEXTO_LITERAL || row.CONTENIDO || row.TEXTO;
            entry.tema = row.Tema_operativo || row.TEMA || row.TITULO || row.TEMA_OPERATIVO;
            entry.keywords = row.Palabras_clave || row.PALABRAS_CLAVE || "";
            entry.ia_text = row.Texto_normalizado_IA || row.TEXTO_NORMALIZADO_IA || "";
            entry.title = `Regla ${entry.regla}`;
          }
          // Extensiones
          else if (row.EXTENSION || row.EXT || row.Extension) {
            entry.contentType = "EXTENSION";
            entry.ext = row.EXTENSION || row.EXT || row.Extension;
            entry.nombre = row.NOMBRE || row.Nombre || "";
            entry.area = row.AREA || row.Area || "";
            entry.title = `EXT ${entry.ext}`;
            entry.content = `${entry.nombre} - ${entry.area}`;
          }
          // Certificados
          else if (row.NUMERO || row.CERTIFICADO || row.Numero) {
            entry.contentType = "CERTIFICADO";
            entry.num = row.NUMERO || row.CERTIFICADO || row.Numero;
            entry.negocio = row.NEGOCIO || row.Negocio || "";
            entry.entorno = row.ENTORNO || row.Entorno || "";
            entry.estatus = row.ESTATUS || row.Estatus || "";
            entry.vigenciaIni = row.INICIO || row.Inicio || row.VIGENCIA_INICIO || "";
            entry.vigenciaFin = row.FIN || row.Fin || row.VIGENCIA_FIN || "";
            entry.title = `CERT ${entry.num}`;
            entry.content = `${entry.negocio} | ${entry.entorno} | ${entry.estatus}`;
          }
          // Manuales
          else {
            entry.contentType = "MANUAL";
            entry.title = row.TITULO || row.T√≠tulo || row.Title || "Importado";
            entry.content = row.CONTENIDO || row.Contenido || row.Content || "";
          }

          batch.set(ref, entry);
        });

        await batch.commit();
        window.toast("Carga Exitosa");
        window.closeModal("modal-upload");
        if (document.body.dataset.viewType) renderList(document.body.dataset.viewType);
        input.value = "";
      };

      reader.readAsArrayBuffer(f);
    };

    function renderList(type) {
      const list = document.getElementById("table-content");
      if (!list) return;

      let data = type === "USERS" ? team : (type === "ALL" ? knowledgeBase : knowledgeBase.filter((k) => k.contentType === type));
      const q = (document.getElementById("table-search")?.value || "").trim().toLowerCase();

      if (q) {
        data = data.filter((i) => {
          const blob = (JSON.stringify(i) || "").toLowerCase();
          return blob.includes(q);
        });
      }

      if (!data.length) { list.innerHTML = "<div class='text-center py-10 text-slate-400'>Sin registros</div>"; return; }

      list.innerHTML = data.map((i) => {
        const isUser = type === "USERS";
        const id = isUser ? i.empNumber : i.id;
        const title = isUser ? i.name : i.title;
        const desc = isUser ? i.role : (i.content?.substring(0, 90) || "");

        return `
          <div class="data-card">
            <div class="flex items-center w-full overflow-hidden">
              <input type="checkbox" class="mr-3 accent-blue-600 w-4 h-4 select-row" value="${id}">
              <div class="overflow-hidden">
                <span class="badge badge-${i.contentType || "USER"}">${i.contentType || "USUARIO"}</span>
                <h4 class="font-bold text-sm mt-1 truncate">${title || "(sin t√≠tulo)"}</h4>
                <p class="text-xs text-slate-500 line-clamp-1">${desc || ""}</p>
              </div>
            </div>
            <div class="flex gap-2">
              <button onclick="${isUser ? `window.deleteUser('${id}')` : `window.deleteRec('${id}')`}" class="text-red-500"><i class="fas fa-trash"></i></button>
            </div>
          </div>
        `;
      }).join("");
    }

    window.filterList = () => renderList(document.body.dataset.viewType);

    // CHAT (base interna + IA)
    async function askGemini(q, ctx) {
      try {
        const prompt = `
Eres Speikito, asistente de Operaci√≥n SPEI/CoDi/SPID/DIMO.
Usa primero el CONTEXTO INTERNO si viene, y si falta, explica de forma pr√°ctica.

CONTEXTO INTERNO (si existe):
${ctx || "(sin contexto interno)"}

PREGUNTA:
${q}

REGLAS DE RESPUESTA:
- Responde en espa√±ol, claro y operativo.
- Si el contexto interno existe, c√≠talo con frases como: "Seg√∫n tu base interna: ..."
- Si no existe contexto, da una gu√≠a general y sugiere qu√© dato cargar en la base para futuras respuestas.
- No devuelvas JSON ni bloques raros, solo texto.
`.trim();

        const res = await fetch("/api/gemini", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ prompt }),
        });

        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          return `Error API (${res.status}): ${err?.error || err?.message || "No se pudo consultar la IA"}`;
        }

        const data = await res.json();
        return data?.text || data?.candidates?.[0]?.content?.parts?.[0]?.text || "Sin respuesta de IA.";
      } catch (e) {
        return "Error de conexi√≥n.";
      }
    }

    document.getElementById("chat-form").onsubmit = async (e) => {
      e.preventDefault();
      const v = document.getElementById("chat-input").value.trim();
      if (!v) return;

      document.getElementById("chat-input").value = "";
      addMsg(escapeHtml(v), true);

      // b√∫squeda simple en base interna
      const normV = v.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();

      const hits = knowledgeBase.filter((k) => {
        const text = ((k.title || "") + " " + (k.content || "") + " " + (k.tema || "") + " " + (k.keywords || ""))
          .normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
        return text.includes(normV);
      });

      // Armar contexto para IA con los top hits (sin saturar)
      const top = hits.slice(0, 6);
      const ctx = top.map((x) => {
        if (x.contentType === "REGLA_SPEI") return `REGLA ${x.regla} (${x.capitulo || ""}): ${x.content || ""}`;
        if (x.contentType === "CERTIFICADO") return `CERT ${x.num} | ${x.negocio || ""} | ${x.entorno || ""} | ${x.estatus || ""} | FIN ${x.vigenciaFin || ""}`;
        if (x.contentType === "EXTENSION") return `EXT ${x.ext}: ${x.nombre || ""} (${x.area || ""})`;
        return `MANUAL ${x.title || ""}: ${(x.content || "").slice(0, 220)}`;
      }).join("\n");

      // Mostrar resultados internos si hay, y luego IA
      if (hits.length > 0) {
        let h = `<div class="mb-2 font-bold text-xs text-blue-600">BASE INTERNA (TOP ${top.length}/${hits.length})</div>`;
        top.forEach((x) => {
          if (x.contentType === "CERTIFICADO")
            h += `<div class="bg-blue-50 p-2 rounded mb-1 text-xs border border-blue-100 font-mono"><b>${escapeHtml(x.title || "")}</b><br>Estatus: ${escapeHtml(x.estatus || "")} | Vence: ${escapeHtml(x.vigenciaFin || "")}</div>`;
          else if (x.contentType === "EXTENSION")
            h += `<div class="bg-emerald-50 p-2 rounded mb-1 text-xs"><b>${escapeHtml(x.ext || "")}</b> - ${escapeHtml(x.nombre || "")} (${escapeHtml(x.area || "")})</div>`;
          else if (x.contentType === "REGLA_SPEI")
            h += `<div class="bg-amber-50 p-2 rounded mb-1 text-xs border border-amber-100"><b>Regla ${escapeHtml(x.regla || "")}</b> ‚Ä¢ ${escapeHtml(x.capitulo || "")}<br>${escapeHtml((x.content || "").slice(0, 220))}</div>`;
          else
            h += `<div class="bg-white p-2 rounded border mb-1 text-xs"><b>${escapeHtml(x.title || "")}</b></div>`;
        });
        addMsg(h, false);
      }

      addMsg(`<div class="text-xs font-black text-slate-400 uppercase tracking-widest">Consultando IA‚Ä¶</div>`, false);
      const aiRes = await askGemini(v, ctx);
      addMsg(`<div class="reg-card">${escapeHtml(aiRes).replace(/\n/g, "<br>")}</div>`, false);
    };

    function addMsg(t, u) {
      const d = document.createElement("div");
      d.className = `chat-bubble ${u ? "user-msg" : "bot-msg"} shadow-sm`;
      d.innerHTML = t;

      const b = document.getElementById("chat-box");
      const r = document.createElement("div");
      r.className = `flex w-full mb-2 ${u ? "justify-end" : "justify-start"}`;
      r.appendChild(d);
      b.appendChild(r);
      b.scrollTop = b.scrollHeight;
    }

    function escapeHtml(str) {
      return String(str || "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    // PERFIL
    window.handleProfileUpload = (input) => {
      const f = input.files[0];
      const r = new FileReader();
      r.onload = (e) => {
        if (currentUser) {
          setDoc(doc(db, "artifacts", appId, "public", "data", "team", currentUser.empNumber), { photoURL: e.target.result }, { merge: true });
          updateAvatar(e.target.result);
        }
      };
      if (f) r.readAsDataURL(f);
    };

    function updateAvatar(url) {
      if (url) {
        document.getElementById("user-initials").classList.add("hidden");
        document.getElementById("user-img-display").src = url;
        document.getElementById("user-img-display").classList.remove("hidden");
        document.getElementById("profile-prev").src = url;
        document.getElementById("profile-prev").classList.remove("hidden");
        document.getElementById("profile-icon").classList.add("hidden");
      }
    }

    function login(u) {
      currentUser = u;
      localStorage.setItem("spei_v30_2_session", JSON.stringify(u));
      document.body.setAttribute("data-role", u.role);

      document.getElementById("login-screen").classList.add("hidden-ui");
      document.getElementById("loading-screen").classList.add("hidden-ui");
      document.getElementById("app-layout").classList.remove("hidden-ui");

      document.getElementById("user-name-display").innerText = u.name;
      document.getElementById("user-role-display").innerText = u.role === "admin" ? "ADMIN" : "OPERATIVO";

      if (u.role !== "admin") document.querySelectorAll(".admin-only").forEach((e) => e.classList.add("hidden-ui"));
      else document.querySelectorAll(".admin-only").forEach((e) => e.classList.remove("hidden-ui"));

      if (u.photoURL) updateAvatar(u.photoURL);
    }

    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== "undefined" && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (e) { console.error(e); }
    };

    async function init() {
      await initAuth();

      onAuthStateChanged(auth, (u) => {
        if (!u) return;

        onSnapshot(collection(db, "artifacts", appId, "public", "data", "team"), async (s) => {
          team = s.docs.map((d) => ({ id: d.id, ...d.data() }));

          // seed admin
          if (!team.find((x) => x.empNumber === "682930")) {
            await setDoc(doc(db, "artifacts", appId, "public", "data", "team", "682930"), { name: "Daniel Anzaldo", role: "admin", empNumber: "682930" }, { merge: true });
          }

          const savedSession = localStorage.getItem("spei_v30_2_session");
          document.getElementById("loading-screen").classList.add("hidden-ui");

          if (savedSession) {
            login(JSON.parse(savedSession));
          } else {
            document.getElementById("login-screen").classList.remove("hidden-ui");
            setTimeout(() => window.focusLogin(), 120);
          }
        });

        onSnapshot(collection(db, "artifacts", appId, "public", "data", "knowledge"), (s) => {
          knowledgeBase = s.docs.map((d) => ({ id: d.id, ...d.data() }));
          if (document.body.dataset.viewType) renderList(document.body.dataset.viewType);
        });
      });
    }

    window.addEventListener("load", init);
  </script>
</body>
</html>