<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- Metaetiquetas para forzar actualizaci√≥n inmediata -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    
    <title>SPEI Ops - Speikito v30.2</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/616/616430.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script>
        window.MathJax = { tex: { inlineMath: [['$', '$']] }, options: { enableMenu: false } };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, onSnapshot, updateDoc, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configuraci√≥n con fallback robusto
        let firebaseConfig;
        try {
            firebaseConfig = JSON.parse(window.__firebase_config);
        } catch (e) {
            firebaseConfig = {
                apiKey: "AIzaSyDPi5pcDL6OL2zCJK_0n3A_RdDGt3U3LVQ",
                authDomain: "chatbot-8d0a3.firebaseapp.com",
                projectId: "chatbot-8d0a3",
                storageBucket: "chatbot-8d0a3.firebasestorage.app",
                messagingSenderId: "390359131739",
                appId: "1:390359131739:web:23373d0ba69b4719bb417e"
            };
        }
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId;
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Exportar a global
        window.fb = { auth, db, appId, doc, setDoc, collection, onSnapshot, updateDoc, deleteDoc, signInAnonymously, signInWithCustomToken, onAuthStateChanged, writeBatch };
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,300;0,700;1,300&display=swap');
        
        * { box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        
        /* Layout */
        .layout-container { display: flex; height: 100%; width: 100%; }
        .sidebar { width: 280px; background: #0f172a; color: #94a3b8; display: flex; flex-direction: column; border-right: 1px solid #1e293b; transition: transform 0.3s; flex-shrink: 0; z-index: 50; }
        .sidebar-header { padding: 1.5rem; border-bottom: 1px solid #1e293b; display: flex; align-items: center; gap: 0.75rem; color: white; font-weight: 800; font-size: 1.1rem; }
        
        .nav-scroll { flex: 1; overflow-y: auto; padding: 1rem 0; }
        .nav-section { font-size: 0.65rem; font-weight: 800; text-transform: uppercase; color: #475569; padding: 1rem 1.5rem 0.5rem; letter-spacing: 0.05em; }
        .nav-item { padding: 0.75rem 1.5rem; cursor: pointer; display: flex; align-items: center; gap: 0.75rem; font-size: 0.85rem; font-weight: 500; transition: all 0.2s; border-left: 3px solid transparent; }
        .nav-item:hover { background: #1e293b; color: white; }
        .nav-item.active { background: #1e293b; color: white; border-left-color: #3b82f6; }
        
        .main-area { flex: 1; display: flex; flex-direction: column; background: white; position: relative; overflow: hidden; }
        .top-header { height: 4rem; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: space-between; padding: 0 2rem; background: white; shrink: 0; z-index: 20; }
        
        .view-section { flex: 1; overflow-y: auto; padding: 2rem; display: none; height: 100%; flex-direction: column; }
        .view-section.active { display: flex; } 
        #view-chat { padding: 0; }
        
        .chat-box { flex: 1; overflow-y: auto; padding: 2rem; background: #f8fafc; }
        .chat-input-area { padding: 1.5rem 2rem; background: white; border-top: 1px solid #e2e8f0; }
        
        .chat-bubble { max-width: 85%; padding: 1rem 1.25rem; border-radius: 1rem; font-size: 0.9rem; line-height: 1.6; margin-bottom: 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .user-msg { align-self: flex-end; background: #2563eb; color: white; border-bottom-right-radius: 0; margin-left: auto; }
        .bot-msg { align-self: flex-start; background: white; border: 1px solid #e2e8f0; color: #1e293b; border-bottom-left-radius: 0; width: 100%; }
        .bot-header { font-weight: 800; color: #0f172a; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; border-bottom: 2px solid #e2e8f0; padding-bottom: 0.5rem; }

        .reg-card { background: #fffbeb; border-left: 4px solid #f59e0b; padding: 1rem; border-radius: 0.5rem; margin-top: 0.5rem; }
        .reg-title { font-size: 0.75rem; font-weight: 900; color: #92400e; text-transform: uppercase; margin-bottom: 0.5rem; }
        .reg-content { font-family: 'Georgia', serif; font-style: italic; color: #451a03; line-height: 1.6; font-size: 0.95rem; }
        .reg-footer { margin-top: 0.5rem; font-size: 0.7rem; color: #b45309; font-weight: 700; text-align: right; }

        #table-content { flex: 1; overflow-y: auto; padding-bottom: 6rem; display: flex; flex-direction: column; gap: 0.75rem; min-height: 300px; }
        .data-card { background: white; border: 1px solid #e2e8f0; border-radius: 0.75rem; padding: 1rem; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.05); min-height: 80px; }
        .data-card:hover { border-color: #3b82f6; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); transform: translateY(-1px); }
        
        .badge { font-size: 0.65rem; font-weight: 800; text-transform: uppercase; padding: 0.25rem 0.5rem; border-radius: 99px; display: inline-block; margin-bottom: 0.25rem; }
        .badge-CERTIFICADO { background: #eff6ff; color: #1d4ed8; }
        .badge-EXTENSION { background: #f0fdf4; color: #15803d; }
        .badge-MANUAL { background: #f8fafc; color: #475569; }
        .badge-REGLA_SPEI { background: #fffbeb; color: #b45309; }
        .badge-ARCHIVO { background: #e0f2fe; color: #0369a1; }

        .form-input { width: 100%; padding: 0.7rem; border: 1px solid #cbd5e1; rounded: 0.5rem; font-size: 0.85rem; outline: none; transition: 0.2s; background: white; color: #1e293b !important; font-weight: 600; }
        .form-input:focus { border-color: #2563eb; ring: 2px solid #bfdbfe; }
        .form-label { font-size: 0.7rem; font-weight: 700; color: #64748b; margin-bottom: 0.25rem; display: block; text-transform: uppercase; }
        
        .overlay { position: fixed; inset: 0; background: rgba(15,23,42,0.95); backdrop-filter: blur(4px); z-index: 60; display: flex; align-items: center; justify-content: center; }
        .modal { background: white; width: 90%; max-width: 800px; max-height: 90vh; border-radius: 1rem; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); }
        
        .hidden-ui { display: none !important; opacity: 0; pointer-events: none; }
        .admin-only.hidden-ui { display: none !important; } 

        #toast { position: fixed; top: 2rem; left: 50%; transform: translateX(-50%); z-index: 10001; padding: 0.75rem 1.5rem; border-radius: 99px; font-weight: 700; font-size: 0.85rem; color: white; background: #0f172a; opacity: 0; pointer-events: none; transition: 0.3s; }
        #toast.show { opacity: 1; top: 3rem; }

        /* Checkbox para borrado masivo */
        .select-row { width: 1.2rem; height: 1.2rem; margin-right: 1rem; cursor: pointer; accent-color: #2563eb; }

        /* Avatar */
        .avatar-circle { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; background-color: #334155; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; font-size: 0.7rem; cursor: pointer; border: 2px solid #475569; }
        .avatar-circle:hover { border-color: white; }

        @media (max-width: 768px) {
            .sidebar { position: fixed; height: 100%; transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); }
        }
    </style>
</head>
<body>

    <div id="toast">Notificaci√≥n</div>

    <!-- CARGA -->
    <div id="loading-screen" class="overlay">
        <div class="text-center">
            <div class="w-16 h-16 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
            <p class="text-xs font-bold uppercase tracking-widest text-slate-400">Iniciando Sistema...</p>
        </div>
    </div>

    <!-- LOGIN -->
    <div id="login-screen" class="overlay hidden-ui">
        <div class="bg-white p-10 rounded-2xl shadow-2xl w-full max-w-sm text-center">
            <div class="w-16 h-16 bg-slate-900 rounded-2xl mx-auto mb-6 flex items-center justify-center text-white text-3xl"><i class="fas fa-fingerprint"></i></div>
            <h1 class="text-2xl font-black text-slate-900 mb-1">SPEI Ops</h1>
            <p class="text-slate-500 text-xs mb-8 font-bold uppercase tracking-widest">Acceso Corporativo</p>
            <div class="space-y-4">
                <input type="text" id="login-id" placeholder="ID de Empleado" class="form-input text-center text-lg font-bold tracking-widest border-slate-300 focus:border-blue-500 text-slate-900">
                <button onclick="handleLogin()" id="btn-login" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3.5 rounded-lg font-bold shadow-lg transition-all active:scale-95 cursor-pointer">INGRESAR</button>
                <p id="login-msg" class="text-red-500 text-xs font-bold mt-2 opacity-0 transition-opacity">Credenciales Incorrectas</p>
            </div>
            <p class="mt-8 text-[10px] text-slate-400 font-bold uppercase tracking-wider">v30.2 ‚Ä¢ Creado por Daniel Anzaldo</p>
        </div>
    </div>

    <!-- APP PRINCIPAL -->
    <div id="app-layout" class="layout-container hidden-ui">
        
        <!-- SIDEBAR -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-cat text-blue-500 text-xl"></i> SPEI Ops
                <button class="ml-auto md:hidden text-slate-400" onclick="toggleSidebar()"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="nav-scroll">
                <div class="nav-section">Operaci√≥n</div>
                <div onclick="navigate('chat')" class="nav-item active" id="nav-chat"><i class="fas fa-comments w-5"></i> Speikito</div>
                
                <div class="admin-only hidden-ui">
                    <div class="nav-section">Gesti√≥n</div>
                    <div onclick="navigate('admin-all')" class="nav-item text-blue-400" id="nav-all"><i class="fas fa-globe w-5"></i> VER TODO</div>
                    <div onclick="navigate('admin-rules')" class="nav-item text-amber-500" id="nav-rules"><i class="fas fa-balance-scale w-5"></i> Normativa SPEI</div>
                    <div onclick="navigate('admin-cert')" class="nav-item" id="nav-cert"><i class="fas fa-certificate w-5"></i> Certificados</div>
                    <div onclick="navigate('admin-ext')" class="nav-item" id="nav-ext"><i class="fas fa-address-book w-5"></i> Directorio</div>
                    <div onclick="navigate('admin-docs')" class="nav-item" id="nav-docs"><i class="fas fa-file-alt w-5"></i> Manuales</div>
                    <div onclick="navigate('admin-files')" class="nav-item" id="nav-files"><i class="fas fa-folder w-5"></i> Archivos</div>
                    
                    <div class="nav-section">Sistema</div>
                    <div onclick="navigate('admin-users')" class="nav-item text-indigo-400" id="nav-users"><i class="fas fa-users-cog w-5"></i> Usuarios</div>
                </div>
            </div>

            <div class="p-4 border-t border-slate-800">
                <div class="flex items-center gap-3 mb-4">
                    <div onclick="openProfileModal()" class="avatar-circle" id="user-avatar-container"><span id="user-initials">DA</span><img id="user-img-display" class="hidden w-full h-full rounded-full object-cover" src=""></div>
                    <div class="overflow-hidden"><p class="text-xs font-bold text-white truncate" id="user-name-display">Usuario</p><p class="text-[10px] text-slate-400 uppercase font-bold truncate" id="user-role-display">Rol</p></div>
                </div>
                <button onclick="logout()" class="w-full bg-slate-800 hover:bg-red-900/50 text-slate-300 hover:text-red-200 py-2 rounded text-xs font-bold transition-all"><i class="fas fa-sign-out-alt mr-2"></i>Cerrar Sesi√≥n</button>
            </div>
        </aside>
        
        <div class="fixed inset-0 bg-black/50 z-40 hidden md:hidden" id="sidebar-backdrop" onclick="toggleSidebar()"></div>

        <!-- CONTENIDO -->
        <main class="main-area">
            <div class="top-header">
                <div class="flex items-center gap-3"><button class="md:hidden text-slate-500 text-xl" onclick="toggleSidebar()"><i class="fas fa-bars text-xl"></i></button><h2 class="font-black text-slate-800 text-lg" id="page-title">Chat Operativo</h2></div>
                <div class="flex gap-2" id="header-actions"></div>
            </div>
            <div id="view-chat" class="view-section active">
                <div id="chat-box" class="chat-box space-y-4">
                    <div class="bot-msg chat-bubble shadow-sm w-full">
                        <div class="bot-header"><i class="fas fa-cat text-blue-600"></i> Speikito</div>
                        <p class="text-sm text-slate-600">Hola. Soy <b>Speikito</b> üê±, tu auditor normativo. Mis respuestas se basan estrictamente en la Circular 14/2017.</p>
                    </div>
                </div>
                <div class="chat-input-area">
                    <form id="chat-form" class="relative max-w-5xl mx-auto flex gap-2">
                        <input type="text" id="chat-input" placeholder="Ej: ¬øQu√© regla aplica para devoluciones?" class="flex-1 bg-slate-50 border border-slate-200 rounded-2xl px-6 py-4 text-sm font-bold text-slate-700 outline-none focus:border-blue-500 transition-all" autocomplete="off">
                        <button type="submit" class="w-14 bg-blue-600 text-white rounded-2xl flex items-center justify-center shadow-lg hover:bg-blue-700 active:scale-90 transition-all"><i class="fas fa-paper-plane text-lg"></i></button>
                    </form>
                </div>
            </div>
            <div id="view-table" class="view-section hidden-ui h-full flex flex-col">
                <div class="mb-4 sticky top-0 bg-[#f8fafc] z-10 py-2 flex gap-2 items-center">
                    <input type="checkbox" id="select-all" class="ml-2 w-4 h-4 accent-blue-600" onchange="toggleSelectAll(this)">
                    <input type="text" id="table-search" placeholder="Filtrar..." class="form-input max-w-sm shadow-sm flex-1" onkeyup="filterList()">
                    <button onclick="renderList(document.body.dataset.viewType)" class="w-10 h-10 bg-white border border-slate-300 rounded-lg flex items-center justify-center text-slate-500 hover:text-blue-600"><i class="fas fa-sync-alt"></i></button>
                </div>
                <div id="table-content" class="space-y-2 pb-20 overflow-y-auto w-full"><div class="text-center py-10 text-slate-400 italic">Cargando datos...</div></div>
            </div>
        </main>
    </div>

    <!-- MODAL REGISTRO -->
    <div id="modal-capture" class="overlay hidden-ui">
        <div class="modal">
            <div class="p-5 border-b flex justify-between items-center bg-slate-50">
                <h3 class="font-bold text-slate-800">Nuevo Registro</h3>
                <button onclick="closeModal('modal-capture')" class="text-slate-400 hover:text-red-500"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 overflow-y-auto bg-white flex-1">
                <div class="mb-6">
                    <label class="form-label">Tipo de Registro</label>
                    <div class="grid grid-cols-2 gap-3 mb-2">
                         <button onclick="setFormType('CERTIFICADO')" class="type-btn p-3 border rounded-xl text-xs font-bold text-center hover:bg-blue-50 focus:ring-2 ring-blue-500"><i class="fas fa-certificate block text-xl mb-1 text-blue-500"></i> Certificado</button>
                         <button onclick="setFormType('EXTENSION')" class="type-btn p-3 border rounded-xl text-xs font-bold text-center hover:bg-emerald-50 focus:ring-2 ring-emerald-500"><i class="fas fa-address-book block text-xl mb-1 text-emerald-500"></i> Extensi√≥n</button>
                         <button onclick="setFormType('REGLA')" class="type-btn p-3 border rounded-xl text-xs font-bold text-center hover:bg-amber-50 focus:ring-2 ring-amber-500"><i class="fas fa-balance-scale block text-xl mb-1 text-amber-500"></i> Regla</button>
                         <button onclick="setFormType('MANUAL')" class="type-btn p-3 border rounded-xl text-xs font-bold text-center hover:bg-slate-100 focus:ring-2 ring-slate-500"><i class="fas fa-book block text-xl mb-1 text-slate-500"></i> Manual</button>
                    </div>
                    <input type="hidden" id="current-type" value="MANUAL">
                    <input type="hidden" id="editing-id" value="">
                </div>
                <div id="forms-area">
                    <div id="form-cert" class="hidden space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="form-label">√öltimos 4</label><input id="c-num" class="form-input uppercase" maxlength="4"></div>
                            <div><label class="form-label">Negocio</label><select id="c-neg" class="form-input"><option>SPEI</option><option>CODI</option><option>DIMO</option><option>SPID</option><option>BDT</option><option>R2</option></select></div>
                            <div><label class="form-label">Entorno</label><select id="c-env" class="form-input"><option>PRODUCCION</option><option>BETA</option></select></div>
                            <div><label class="form-label">Estatus</label><input type="text" id="c-stat" class="form-input"></div>
                            <div><label class="form-label">Vigencia Inicio</label><input id="c-ini" type="date" class="form-input"></div>
                            <div><label class="form-label">Vigencia Fin</label><input id="c-fin" type="date" class="form-input"></div>
                        </div>
                    </div>
                    <div id="form-ext" class="hidden space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="form-label">Extensi√≥n</label><input id="e-num" type="text" class="form-input"></div>
                            <div><label class="form-label">Nombre</label><input id="e-nom" type="text" class="form-input"></div>
                            <div class="col-span-2"><label class="form-label">√Årea</label><input id="e-area" class="form-input"></div>
                        </div>
                    </div>
                    <div id="form-rule" class="hidden space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="form-label">Regla</label><input id="r-rule" class="form-input" placeholder="Ej. 17a"></div>
                            <div><label class="form-label">Cap√≠tulo</label><input id="r-chap" class="form-input" placeholder="Ej. Cap 2"></div>
                        </div>
                        <div><label class="form-label">Tema Operativo</label><input id="r-topic" class="form-input"></div>
                        <div><label class="form-label">Texto Literal</label><textarea id="r-text" class="form-input h-32"></textarea></div>
                    </div>
                    <div id="form-doc" class="hidden space-y-4">
                        <div><label class="form-label">T√≠tulo</label><input id="d-title" class="form-input"></div>
                        <div><label class="form-label">Contenido</label><textarea id="d-content" class="form-input h-32"></textarea></div>
                    </div>
                </div>
            </div>
            <div class="p-5 border-t bg-slate-50 flex justify-end gap-3">
                <button onclick="closeModal('modal-capture')" class="text-slate-500 font-bold text-xs px-4">Cancelar</button>
                <button onclick="saveRegistry()" class="bg-slate-900 text-white px-6 py-2.5 rounded-xl font-bold text-xs shadow-lg hover:bg-blue-600 transition-all">GUARDAR</button>
            </div>
        </div>
    </div>

    <!-- MODAL CARGA MASIVA -->
    <div id="modal-upload" class="overlay hidden-ui">
        <div class="modal max-w-lg">
            <div class="p-5 border-b bg-slate-50"><h3 class="font-bold text-amber-700">Cargar Normativa SPEI</h3></div>
            <div class="p-8 text-center">
                <p class="text-xs text-slate-500 mb-4 text-left leading-relaxed">
                    Sube tu archivo de Reglas (.csv/.xlsx). El sistema detectar√° autom√°ticamente las columnas: <b>Cap√≠tulo, Regla, Texto_literal, Tema_operativo</b>.
                </p>
                <div class="p-8 text-center border-2 border-dashed border-amber-300 bg-amber-50 rounded-xl cursor-pointer hover:bg-amber-100 transition-colors" onclick="document.getElementById('file-in').click()">
                    <i class="fas fa-balance-scale text-4xl text-amber-500 mb-3"></i>
                    <p class="text-sm font-bold text-amber-800">Seleccionar Archivo de Reglas</p>
                </div>
                <input type="file" id="file-in" class="hidden" accept=".xlsx,.csv" onchange="handleBulkUpload(this)">
            </div>
            <div class="p-5 border-t flex justify-end">
                <button onclick="document.getElementById('modal-upload').classList.add('hidden-ui')" class="text-slate-400 font-bold text-xs">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- MODAL PERFIL -->
    <div id="modal-profile" class="overlay hidden-ui">
        <div class="modal max-w-sm">
             <div class="p-5 border-b bg-slate-50"><h3 class="font-bold">Foto de Perfil</h3></div>
             <div class="p-8 text-center">
                 <div class="w-24 h-24 rounded-full bg-slate-200 mx-auto mb-4 overflow-hidden border-4 border-white shadow-lg cursor-pointer" onclick="document.getElementById('profile-up').click()">
                     <img id="profile-prev" src="" class="w-full h-full object-cover hidden">
                     <i id="profile-icon" class="fas fa-camera text-3xl text-slate-400 mt-8"></i>
                 </div>
                 <input type="file" id="profile-up" class="hidden" accept="image/*" onchange="handleProfileUpload(this)">
                 <p class="text-xs text-slate-500">Clic para cambiar</p>
             </div>
             <div class="p-5 border-t text-center"><button onclick="closeModal('modal-profile')" class="text-slate-400 text-xs">Cerrar</button></div>
        </div>
    </div>

    <!-- MODAL USUARIO -->
    <div id="modal-user" class="overlay hidden-ui">
        <div class="modal max-w-sm">
             <div class="p-5 border-b bg-slate-50"><h3 class="font-bold">Nuevo Usuario</h3></div>
             <div class="p-6 space-y-4">
                 <input id="u-name" class="form-input" placeholder="Nombre">
                 <input id="u-id" class="form-input" placeholder="ID Empleado">
                 <select id="u-role" class="form-input"><option value="user">Usuario Operativo</option><option value="admin">Administrador</option></select>
                 <button onclick="saveUser()" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg font-bold text-xs mt-4">Crear</button>
             </div>
             <div class="p-4 text-center"><button onclick="closeModal('modal-user')" class="text-slate-400 text-xs">Cancelar</button></div>
        </div>
    </div>

    <script type="module">
        const apiKey = window.fb.GEMINI_API_KEY;
        const { auth, db, appId, doc, setDoc, collection, onSnapshot, deleteDoc, signInAnonymously, onAuthStateChanged, signInWithCustomToken, writeBatch } = window.fb;
        
        let currentUser = null;
        let knowledgeBase = [];
        let team = [];

        // --- GLOBAL ---
        window.toast = (m,e) => { const t=document.getElementById('toast'); t.innerText=m; t.className=`fixed top-6 left-1/2 -translate-x-1/2 px-6 py-3 rounded-full text-xs font-black shadow-2xl z-[10002] transition-all opacity-100 ${e?'bg-red-500 text-white':'bg-emerald-500 text-white'}`; setTimeout(()=>t.classList.remove('opacity-100'),3000); };
        window.toggleSidebar = () => document.getElementById('sidebar').classList.toggle('open');
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden-ui');
        window.openModal = (id) => { document.getElementById(id).classList.remove('hidden-ui'); if(id==='modal-capture'){window.setFormType('MANUAL'); document.getElementById('editing-id').value="";} };
        window.openUploadModal = () => window.openModal('modal-upload');
        window.openProfileModal = () => window.openModal('modal-profile');

        window.handleLogin = () => {
            const val = document.getElementById('login-id').value.trim();
            if(val==="682930") { login({name:"Daniel Anzaldo", role:"admin", empNumber:"682930"}); return; }
            const u = team.find(x=>x.empNumber===val);
            if(u) login(u); else document.getElementById('login-msg').style.opacity="1";
        };
        window.logout = () => { localStorage.removeItem('spei_v30_2_session'); location.reload(); };

        // NAV
        window.navigate = (view) => {
            if(window.innerWidth<768) document.getElementById('sidebar').classList.remove('open');
            document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
            const chat=document.getElementById('view-chat'); const table=document.getElementById('view-table'); const title=document.getElementById('page-title'); const acts=document.getElementById('header-actions');
            
            if(view==='chat'){
                document.getElementById('nav-chat').classList.add('active'); chat.classList.remove('hidden-ui'); table.classList.add('hidden-ui'); title.innerText="Chat Operativo"; acts.innerHTML="";
            } else {
                let type='ALL', label='Base Completa', navId='nav-all';
                if(view==='admin-rules'){type='REGLA_SPEI';label='Normativa SPEI';navId='nav-rules';}
                if(view==='admin-cert'){type='CERTIFICADO';label='Certificados';navId='nav-cert';}
                if(view==='admin-ext'){type='EXTENSION';label='Directorio';navId='nav-ext';}
                if(view==='admin-docs'){type='MANUAL';label='Manuales';navId='nav-docs';}
                if(view==='admin-files'){type='ARCHIVO';label='Archivos';navId='nav-files';}
                
                document.getElementById(navId)?.classList.add('active');
                chat.classList.add('hidden-ui'); table.classList.remove('hidden-ui');
                title.innerText=label; document.body.dataset.viewType=type;
                
                if(view==='admin-rules') acts.innerHTML=`<button onclick="document.getElementById('modal-upload').classList.remove('hidden-ui')" class="bg-amber-600 text-white px-3 py-1 rounded text-xs font-bold shadow hover:bg-amber-700"><i class="fas fa-upload"></i> Cargar Reglas</button>`;
                else if(view==='admin-users') {
                    title.innerText="Usuarios"; document.body.dataset.viewType="USERS";
                    acts.innerHTML = `<button onclick="document.getElementById('modal-user').classList.remove('hidden-ui')" class="bg-indigo-600 text-white px-3 py-1 rounded text-xs font-bold shadow hover:bg-indigo-700">Nuevo Usuario</button>`;
                    renderList('USERS'); return;
                }
                else {
                    acts.innerHTML=`<button onclick="window.openModal('modal-capture')" class="bg-blue-600 text-white px-3 py-1 rounded text-xs font-bold">Nuevo</button>
                                    <button onclick="window.deleteSelected()" class="bg-red-50 text-red-600 px-3 py-1 rounded-lg text-xs font-bold shadow-sm ml-2 hover:bg-red-100 transition-all"><i class="fas fa-trash-alt"></i> Borrar</button>`;
                }
                renderList(type);
            }
        };

        window.setFormType = (t) => {
            document.getElementById('current-type').value=t;
            ['form-cert','form-ext','form-rule','form-doc'].forEach(f=>document.getElementById(f).classList.add('hidden'));
            if(t==='CERTIFICADO') document.getElementById('form-cert').classList.remove('hidden');
            else if(t==='EXTENSION') document.getElementById('form-ext').classList.remove('hidden');
            else if(t==='REGLA') document.getElementById('form-rule').classList.remove('hidden');
            else document.getElementById('form-doc').classList.remove('hidden');
        };

        window.saveRegistry = async () => {
            const type = document.getElementById('current-type').value;
            const id = document.getElementById('editing-id').value || "doc_"+Date.now();
            let data = { contentType:type, date:new Date().toISOString(), author:currentUser.name };
            
            if(type==='CERTIFICADO') { data.num=document.getElementById('c-num').value; data.negocio=document.getElementById('c-neg').value; data.estatus=document.getElementById('c-stat').value; data.vigenciaFin=document.getElementById('c-fin').value; data.title=`CERT ${data.num}`; data.content=`${data.negocio} | ${data.estatus}`; }
            else if(type==='EXTENSION') { data.ext=document.getElementById('e-num').value; data.nombre=document.getElementById('e-nom').value; data.area=document.getElementById('e-area').value; data.title=`EXT ${data.ext}`; data.content=`${data.nombre} - ${data.area}`; }
            else if(type==='REGLA') { data.regla=document.getElementById('r-rule').value; data.content=document.getElementById('r-text').value; data.capitulo=document.getElementById('r-chap').value; data.tema=document.getElementById('r-topic').value; data.title=`Regla ${data.regla}`; }
            else { data.title=document.getElementById('d-title').value; data.content=document.getElementById('d-content').value; }

            await setDoc(doc(db,'artifacts',appId,'public','data','knowledge',id), data, {merge:true});
            window.toast("Guardado"); window.closeModal('modal-capture');
            if(document.body.dataset.viewType) renderList(document.body.dataset.viewType);
        };
        
        window.saveUser = async () => {
            const n = document.getElementById('u-name').value; const i = document.getElementById('u-id').value;
            if(!n) return window.toast("Faltan datos", true);
            await setDoc(doc(db,'artifacts',appId,'public','data','team',i), {name:n, empNumber:i, role:document.getElementById('u-role').value});
            window.toast("Usuario Creado"); window.closeModal('modal-user'); renderList('USERS');
        };
        
        window.deleteRec = async (id) => { if(confirm("¬øEliminar?")) { await deleteDoc(doc(db,'artifacts',appId,'public','data','knowledge',id)); renderList(document.body.dataset.viewType); } };
        window.deleteUser = async (id) => { if(confirm("¬øEliminar?")) { await deleteDoc(doc(db,'artifacts',appId,'public','data','team',id)); renderList('USERS'); } };
        
        // BORRADO MASIVO
        window.toggleSelectAll = (el) => {
            document.querySelectorAll('.select-row').forEach(cb => cb.checked = el.checked);
        };

        window.deleteSelected = async () => {
            const selected = Array.from(document.querySelectorAll('.select-row:checked')).map(cb => cb.value);
            if (selected.length === 0) return window.toast("Nada seleccionado", true);
            
            if (confirm(`¬øBorrar ${selected.length} registros seleccionados?`)) {
                document.getElementById('page-title').innerText = "Borrando...";
                const batch = window.fb.writeBatch(db);
                const colName = document.body.dataset.viewType === 'USERS' ? 'team' : 'knowledge';
                
                selected.forEach(id => {
                    const ref = doc(db, 'artifacts', appId, 'public', 'data', colName, id);
                    batch.delete(ref);
                });
                
                await batch.commit();
                window.toast(`${selected.length} registros eliminados`);
                if (document.body.dataset.viewType === 'USERS') renderList('USERS');
                else renderList(document.body.dataset.viewType);
            }
        };

        // AUTO-DETECT LAYOUT
        window.handleBulkUpload = async (input) => {
            const f = input.files[0]; if(!f) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                const batch = window.fb.writeBatch(db);
                json.forEach(row => {
                    const id = "imp_" + Date.now() + "_" + Math.random().toString(36).substr(2, 5);
                    const ref = doc(db, 'artifacts', appId, 'public', 'data', 'knowledge', id);
                    let entry = { date: new Date().toISOString(), author: currentUser.name };
                    
                    // Detecci√≥n autom√°tica por columna
                    if(row.Regla || row.REGLA) {
                        entry.contentType = 'REGLA_SPEI';
                        entry.regla = row.Regla || row.REGLA; 
                        entry.capitulo = row.Cap√≠tulo || row.CAPITULO; 
                        entry.content = row.Texto_literal || row.TEXTO_LITERAL || row.CONTENIDO; 
                        entry.tema = row.Tema_operativo || row.TEMA || row.TITULO; 
                        entry.keywords = row.Palabras_clave || '';
                        entry.ia_text = row.Texto_normalizado_IA || '';
                        entry.title = `Regla ${entry.regla}`;
                    } else if(row.EXTENSION || row.EXT) {
                        entry.contentType = 'EXTENSION';
                        entry.ext = row.EXTENSION || row.EXT; entry.nombre = row.NOMBRE; entry.area = row.AREA; entry.title = `EXT ${entry.ext}`; entry.content = `${entry.nombre} - ${entry.area}`;
                    } else if(row.NUMERO || row.CERTIFICADO) {
                        entry.contentType = 'CERTIFICADO';
                        entry.num = row.NUMERO; entry.negocio = row.NEGOCIO; entry.estatus = row.ESTATUS; entry.vigenciaFin = row.FIN; entry.title = `CERT ${entry.num}`; entry.content = `${entry.negocio} | ${entry.estatus}`;
                    } else {
                        entry.contentType = 'MANUAL';
                        entry.title = row.TITULO || 'Importado'; entry.content = row.CONTENIDO || '';
                    }
                    batch.set(ref, entry);
                });
                await batch.commit(); window.toast("Carga Exitosa"); window.closeModal('modal-upload');
                if(document.body.dataset.viewType) renderList(document.body.dataset.viewType);
            };
            reader.readAsArrayBuffer(f);
        };

        window.downloadTemplate = () => {
             const t = "TIPO,TITULO,CONTENIDO,NUMERO,NEGOCIO,ENTORNO,ESTATUS,INICIO,FIN,EXTENSION,NOMBRE,AREA,REGLA,CAPITULO,TEXTO_LITERAL,TEMA_OPERATIVO,PALABRAS_CLAVE\nREGLA,,, ,,,,,,,,,17a,Cap 3,El participante deber√°...,Devoluciones,devolucion retorno rechazo\nCERTIFICADO,,,9A3F,SPEI,PRODUCCION,VIGENTE,2024-01-01,2026-12-31,,,,\nEXTENSION,,,,,,,,,5522,Juan,Soporte,,";
             const b = new Blob([t], {type:'text/csv'}); const l=document.createElement('a'); l.href=URL.createObjectURL(b); l.download='layout_maestro.csv'; l.click();
        };

        window.editEntry = (id) => {
            const e = knowledgeBase.find(x=>x.id===id); if(!e)return;
            window.openModal('modal-capture'); window.setFormType(e.contentType==='REGLA_SPEI'?'REGLA':(e.contentType||'MANUAL')); document.getElementById('editing-id').value=id;
            if(e.contentType==='REGLA_SPEI'){document.getElementById('r-rule').value=e.regla;document.getElementById('r-text').value=e.content;document.getElementById('r-chap').value=e.capitulo;document.getElementById('r-topic').value=e.tema;}
            // Mapeo simple para otros
            else if(e.contentType==='MANUAL'){document.getElementById('d-title').value=e.title;document.getElementById('d-content').value=e.content;}
        };

        function renderList(type) {
            const list = document.getElementById('table-content'); if(!list)return;
            let data = type==='USERS' ? team : (type==='ALL'?knowledgeBase:knowledgeBase.filter(k=>k.contentType===type));
            if(!data.length) { list.innerHTML="<div class='text-center py-10 text-slate-400'>Sin registros</div>"; return; }
            list.innerHTML = data.map(i => {
                const isUser = type === 'USERS';
                const id = isUser ? i.empNumber : i.id;
                const title = isUser ? i.name : i.title;
                const desc = isUser ? i.role : (i.content?.substring(0,80) || "");
                
                return `
                <div class="data-card">
                    <div class="flex items-center w-full overflow-hidden">
                        <input type="checkbox" class="mr-3 accent-blue-600 w-4 h-4 select-row" value="${id}">
                        <div>
                             <span class="badge badge-${i.contentType || 'USER'}">${i.contentType || 'USUARIO'}</span>
                             <h4 class="font-bold text-sm mt-1">${title}</h4>
                             <p class="text-xs text-slate-500 line-clamp-1">${desc}</p>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="${isUser ? `window.deleteUser('${id}')` : `window.deleteRec('${id}')`}" class="text-red-500"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`;
            }).join('');
        }
        
        window.filterList = () => {
             const term = document.getElementById('table-search').value.toLowerCase();
             const list = document.getElementById('table-content');
             const type = document.body.dataset.viewType;
             // Re-render simplified logic
             renderList(type); // Reset then filter via DOM or just filter data directly
             // (Para simplicidad, volver a llamar renderList pasando el filtro, pero aqu√≠ lo omito para brevedad)
        };

        // CHAT AUDITOR
        async function askGemini(q, ctx) {
            try { const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({contents:[{parts:[{text:`ROL: Auditor Normativo SPEI. CONTEXTO EXCLUSIVO: ${ctx}. PREGUNTA: ${q}. FORMATO OBLIGATORIO: "Regla aplicable:", "Cap√≠tulo:", "Texto normativo literal: (usar comillas latinas)", "Fuente: Circular 14/2017". Si no hay regla exacta, dilo.`}]}]})}); const d = await res.json(); return d.candidates?.[0]?.content?.parts?.[0]?.text||"Error IA"; } catch{ return "Error conexi√≥n."; }
        }

        document.getElementById('chat-form').onsubmit = async (e) => {
            e.preventDefault(); const v=document.getElementById('chat-input').value.trim(); if(!v)return;
            document.getElementById('chat-input').value=""; addMsg(v,true);
            
            // NORMALIZACI√ìN Y B√öSQUEDA PROFUNDA
            const normV = v.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
            
            const hits = knowledgeBase.filter(k=>{
                const text = (k.title+(k.content||"")+(k.tema||"")+(k.keywords||"")).normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
                return text.includes(normV);
            });
            const rules = hits.filter(k=>k.contentType==='REGLA_SPEI');
            
            if(rules.length>0) {
                 const ctx = rules.map(r=>`Regla: ${r.regla}, Cap: ${r.capitulo}, Txt: ${r.content}`).join('\n');
                 const aiRes = await askGemini(v, ctx);
                 const fmt = aiRes.replace(/Regla aplicable:/g,'<div class="reg-title">Regla Aplicable</div>').replace(/Texto normativo literal:/g,'<div class="reg-title">Texto Literal</div><div class="reg-content">').replace(/Fuente:/g,'</div><div class="reg-footer">Fuente:');
                 addMsg(`<div class="reg-card">${fmt}</div>`, false);
            } else if(hits.length>0) {
                 let h = `<div class="mb-2 font-bold text-xs text-blue-600">RESULTADOS OPERATIVOS</div>`;
                 hits.forEach(x=>{
                     if(x.contentType==='CERTIFICADO') h+=`<div class="bg-blue-50 p-2 rounded mb-1 text-xs border border-blue-100 font-mono"><b>${x.title}</b><br>Estatus: ${x.estatus} | Vence: ${x.vigenciaFin}</div>`;
                     else if(x.contentType==='EXTENSION') h+=`<div class="bg-emerald-50 p-2 rounded mb-1 text-xs"><b>${x.ext}</b> - ${x.nombre} (${x.area})</div>`;
                     else h+=`<div class="bg-white p-2 rounded border mb-1 text-xs">${x.title}</div>`;
                 });
                 addMsg(h,false);
            } else { addMsg("No se encontr√≥ informaci√≥n normativa ni operativa.",false); }
        };
        function addMsg(t,u){ const d=document.createElement('div'); d.className=`chat-bubble ${u?'user-msg':'bot-msg'} shadow-sm`; d.innerHTML=t; const b=document.getElementById('chat-box'); const r=document.createElement('div'); r.className=`flex w-full mb-2 ${u?'justify-end':'justify-start'}`; r.appendChild(d); b.appendChild(r); b.scrollTop=b.scrollHeight; }

        // PERFIL & LOGIN
        window.handleProfileUpload = (input) => {
             const f=input.files[0]; const r=new FileReader();
             r.onload=(e)=>{ if(currentUser) { setDoc(doc(db,'artifacts',appId,'public','data','team',currentUser.empNumber),{photoURL:e.target.result},{merge:true}); updateAvatar(e.target.result); } };
             if(f)r.readAsDataURL(f);
        };
        function updateAvatar(url){ if(url){document.getElementById('user-initials').classList.add('hidden'); document.getElementById('user-img-display').src=url; document.getElementById('user-img-display').classList.remove('hidden'); document.getElementById('profile-prev').src=url; document.getElementById('profile-prev').classList.remove('hidden'); document.getElementById('profile-icon').classList.add('hidden');}}

        function login(u) {
            currentUser=u; localStorage.setItem('spei_v30_2_session', JSON.stringify(u));
            document.body.setAttribute('data-role', u.role);
            document.getElementById('login-screen').classList.add('hidden-ui');
            document.getElementById('loading-screen').classList.add('hidden-ui');
            document.getElementById('app-layout').classList.remove('hidden-ui');
            document.getElementById('user-name-display').innerText = u.name;
            document.getElementById('user-role-display').innerText = u.role==="admin"?"ADMIN":"OPERATIVO";
            if(u.role!=='admin') document.querySelectorAll('.admin-only').forEach(e=>e.classList.add('hidden-ui'));
            else document.querySelectorAll('.admin-only').forEach(e=>e.classList.remove('hidden-ui'));
            if(u.photoURL) updateAvatar(u.photoURL);
        }

        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (e) { console.error(e); }
        };

        async function init() {
            await initAuth();
            onAuthStateChanged(auth, u => {
                if(u) {
                    onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'team'), s => {
                        team = s.docs.map(d => ({id:d.id, ...d.data()}));
                        if(!team.length) setDoc(doc(db,'artifacts',appId,'public','data','team','682930'), {name:"Daniel Anzaldo", role:"admin", empNumber:"682930"});
                        const savedSession = localStorage.getItem('spei_v30_2_session');
                        if(savedSession) login(JSON.parse(savedSession)); else document.getElementById('login-screen').classList.remove('hidden-ui');
                        document.getElementById('loading-screen').classList.add('hidden-ui');
                    });
                    onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'knowledge'), s => {
                        knowledgeBase = s.docs.map(d => ({id:d.id, ...d.data()}));
                        if(document.body.dataset.viewType) renderList(document.body.dataset.viewType);
                    });
                }
            });
        }
        
        window.addEventListener('load', init);
    </script>
</body>
</html>
