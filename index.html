<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- Metaetiquetas para forzar actualización inmediata -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    
    <title>SPEI Ops - Panel v23.0</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2830/2830284.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script>
        window.MathJax = { tex: { inlineMath: [['$', '$']] }, options: { enableMenu: false } };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, onSnapshot, updateDoc, deleteDoc, getDoc, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDPi5pcDL6OL2zCJK_0n3A_RdDGt3U3LVQ",
            authDomain: "chatbot-8d0a3.firebaseapp.com",
            projectId: "chatbot-8d0a3",
            storageBucket: "chatbot-8d0a3.firebasestorage.app",
            messagingSenderId: "390359131739",
            appId: "1:390359131739:web:23373d0ba69b4719bb417e"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = "chatbot-8d0a3"; 

        window.fb = { auth, db, appId, doc, setDoc, collection, onSnapshot, updateDoc, deleteDoc, signInAnonymously, onAuthStateChanged };
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        * { box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; height: 100vh; width: 100vw; overflow: hidden; display: flex; flex-direction: column; }
        
        .layout-container { display: flex; height: 100%; width: 100%; }
        .sidebar { width: 260px; background: #0f172a; color: #94a3b8; display: flex; flex-direction: column; border-right: 1px solid #1e293b; transition: transform 0.3s; flex-shrink: 0; z-index: 50; }
        .sidebar-header { padding: 1.5rem; border-bottom: 1px solid #1e293b; display: flex; align-items: center; gap: 0.75rem; color: white; font-weight: 800; font-size: 1.1rem; }
        
        .nav-scroll { flex: 1; overflow-y: auto; padding: 1rem 0; }
        .nav-section { font-size: 0.65rem; font-weight: 800; text-transform: uppercase; color: #475569; padding: 1rem 1.5rem 0.5rem; letter-spacing: 0.05em; }
        .nav-item { padding: 0.75rem 1.5rem; cursor: pointer; display: flex; align-items: center; gap: 0.75rem; font-size: 0.85rem; font-weight: 500; transition: all 0.2s; border-left: 3px solid transparent; }
        .nav-item:hover { background: #1e293b; color: white; }
        .nav-item.active { background: #1e293b; color: white; border-left-color: #3b82f6; }
        
        .main-area { flex: 1; display: flex; flex-direction: column; background: white; position: relative; overflow: hidden; }
        .top-header { height: 4rem; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: space-between; padding: 0 2rem; background: white; shrink: 0; z-index: 20; }
        
        .view-section { flex: 1; overflow-y: auto; padding: 2rem; display: none; height: 100%; flex-direction: column; }
        .view-section.active { display: flex; } 
        #view-chat { padding: 0; }
        
        .chat-box { flex: 1; overflow-y: auto; padding: 2rem; background: #f8fafc; }
        .chat-input-area { padding: 1.5rem 2rem; background: white; border-top: 1px solid #e2e8f0; }
        
        .chat-bubble { max-width: 85%; padding: 1rem 1.25rem; border-radius: 1rem; font-size: 0.9rem; line-height: 1.6; margin-bottom: 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .user-msg { align-self: flex-end; background: #2563eb; color: white; border-bottom-right-radius: 0; margin-left: auto; }
        .bot-msg { align-self: flex-start; background: white; border: 1px solid #e2e8f0; color: #1e293b; border-bottom-left-radius: 0; width: 100%; }
        .bot-header { font-weight: 800; color: #0f172a; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; border-bottom: 2px solid #e2e8f0; padding-bottom: 0.5rem; }

        #table-content { flex: 1; overflow-y: auto; padding-bottom: 6rem; display: flex; flex-direction: column; gap: 0.75rem; min-height: 300px; }
        .data-card { background: white; border: 1px solid #e2e8f0; border-radius: 0.75rem; padding: 1rem; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.05); min-height: 80px; }
        .data-card:hover { border-color: #3b82f6; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); transform: translateY(-1px); }
        
        .badge { font-size: 0.65rem; font-weight: 800; text-transform: uppercase; padding: 0.25rem 0.5rem; border-radius: 99px; display: inline-block; margin-bottom: 0.25rem; }
        .badge-CERTIFICADO { background: #eff6ff; color: #1d4ed8; }
        .badge-EXTENSION { background: #f0fdf4; color: #15803d; }
        .badge-MANUAL { background: #f8fafc; color: #475569; }
        .badge-ARCHIVO { background: #fff7ed; color: #9a3412; }

        .form-input { width: 100%; padding: 0.7rem; border: 1px solid #cbd5e1; rounded: 0.5rem; font-size: 0.85rem; outline: none; transition: 0.2s; background: white; color: #1e293b !important; font-weight: 600; }
        .form-input:focus { border-color: #2563eb; ring: 2px solid #bfdbfe; }
        .form-label { font-size: 0.7rem; font-weight: 700; color: #64748b; margin-bottom: 0.25rem; display: block; text-transform: uppercase; }
        
        .overlay { position: fixed; inset: 0; background: rgba(15,23,42,0.95); backdrop-filter: blur(4px); z-index: 60; display: flex; align-items: center; justify-content: center; }
        .modal { background: white; width: 90%; max-width: 800px; max-height: 90vh; border-radius: 1rem; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); }
        
        .hidden-ui { display: none !important; opacity: 0; pointer-events: none; }
        .admin-only.hidden-ui { display: none !important; } 

        #toast { position: fixed; top: 2rem; left: 50%; transform: translateX(-50%); z-index: 10001; padding: 0.75rem 1.5rem; border-radius: 99px; font-weight: 700; font-size: 0.85rem; color: white; background: #0f172a; opacity: 0; pointer-events: none; transition: 0.3s; }
        #toast.show { opacity: 1; top: 3rem; }

        @media (max-width: 768px) {
            .sidebar { position: fixed; height: 100%; transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); }
        }
    </style>
</head>
<body>

    <div id="toast">Notificación</div>

    <!-- CARGA -->
    <div id="loading-screen" class="overlay">
        <div class="text-center">
            <div class="w-16 h-16 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
            <p class="text-xs font-bold uppercase tracking-widest text-slate-400">Iniciando Sistema...</p>
        </div>
    </div>

    <!-- LOGIN -->
    <div id="login-screen" class="overlay hidden-ui">
        <div class="bg-white p-10 rounded-2xl shadow-2xl w-full max-w-sm text-center">
            <div class="w-16 h-16 bg-slate-900 rounded-2xl mx-auto mb-6 flex items-center justify-center text-white text-3xl"><i class="fas fa-fingerprint"></i></div>
            <h1 class="text-2xl font-black text-slate-900 mb-1">SPEI Ops</h1>
            <p class="text-slate-500 text-xs mb-8 font-bold uppercase tracking-widest">Acceso Corporativo</p>
            <div class="space-y-4">
                <input type="text" id="login-id" placeholder="ID de Empleado" class="form-input text-center text-lg font-bold tracking-widest border-slate-300 focus:border-blue-500 text-slate-900">
                <button onclick="handleLogin()" id="btn-login" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3.5 rounded-lg font-bold shadow-lg transition-all active:scale-95 cursor-pointer">INGRESAR</button>
                <p id="login-msg" class="text-red-500 text-xs font-bold mt-2 opacity-0 transition-opacity">Credenciales Incorrectas</p>
            </div>
            <p class="mt-8 text-[10px] text-slate-400 font-bold uppercase tracking-wider">v23.0 • Daniel Anzaldo</p>
        </div>
    </div>

    <!-- APP PRINCIPAL -->
    <div id="app-layout" class="layout-container hidden-ui">
        
        <!-- SIDEBAR -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-cubes text-blue-500"></i> SPEI Ops
                <button class="ml-auto md:hidden text-slate-400" onclick="toggleSidebar()"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="nav-scroll">
                <div class="nav-section">Operación</div>
                <div onclick="navigate('chat')" class="nav-item active" id="nav-chat"><i class="fas fa-comments w-5"></i> Chat Operativo</div>
                
                <div class="admin-only hidden-ui">
                    <div class="nav-section">Gestión de Conocimiento</div>
                    <div onclick="navigate('admin-all')" class="nav-item text-blue-400" id="nav-all"><i class="fas fa-globe w-5"></i> VER TODO</div>
                    <div onclick="navigate('admin-cert')" class="nav-item" id="nav-cert"><i class="fas fa-certificate w-5"></i> Certificados</div>
                    <div onclick="navigate('admin-ext')" class="nav-item" id="nav-ext"><i class="fas fa-address-book w-5"></i> Directorio</div>
                    <div onclick="navigate('admin-docs')" class="nav-item" id="nav-docs"><i class="fas fa-file-alt w-5"></i> Manuales</div>
                    <div onclick="navigate('admin-files')" class="nav-item" id="nav-files"><i class="fas fa-folder w-5"></i> Archivos</div>
                    
                    <div class="nav-section">Sistema</div>
                    <div onclick="navigate('admin-users')" class="nav-item text-amber-500" id="nav-users"><i class="fas fa-users-cog w-5"></i> Usuarios</div>
                </div>
            </div>

            <div class="p-4 border-t border-slate-800">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-8 h-8 bg-slate-700 rounded-full flex items-center justify-center text-xs font-bold text-white" id="user-avatar">DA</div>
                    <div class="overflow-hidden">
                        <p class="text-xs font-bold text-white truncate" id="user-name-display">Usuario</p>
                        <p class="text-[10px] text-slate-400 uppercase font-bold truncate" id="user-role-display">Rol</p>
                    </div>
                </div>
                <button onclick="logout()" class="w-full bg-slate-800 hover:bg-red-900/50 text-slate-300 hover:text-red-200 py-2 rounded text-xs font-bold transition-all"><i class="fas fa-sign-out-alt mr-2"></i>Cerrar Sesión</button>
            </div>
        </aside>
        
        <div class="fixed inset-0 bg-black/50 z-40 hidden md:hidden" id="sidebar-backdrop" onclick="toggleSidebar()"></div>

        <!-- CONTENIDO -->
        <main class="main-area">
            <div class="top-header">
                <div class="flex items-center gap-3">
                    <button class="md:hidden text-slate-500 text-xl" onclick="toggleSidebar()"><i class="fas fa-bars text-xl"></i></button>
                    <h2 class="font-black text-slate-800 text-lg" id="page-title">Chat Operativo</h2>
                </div>
                <div class="flex gap-2" id="header-actions"></div>
            </div>

            <!-- VISTA: CHAT -->
            <div id="view-chat" class="view-section active">
                <div id="chat-box" class="chat-box space-y-4">
                    <div class="bot-msg chat-bubble shadow-sm w-full">
                        <div class="bot-header"><i class="fas fa-robot text-blue-600"></i> Asistente SPEI</div>
                        <p>Sistema en línea. Base de datos sincronizada.</p>
                    </div>
                </div>
                <div class="mt-auto pt-4 bg-white border-t border-slate-100 p-4">
                    <form id="chat-form" class="relative max-w-5xl mx-auto flex gap-2">
                        <input type="text" id="chat-input" placeholder="Realiza una consulta técnica..." class="flex-1 bg-slate-50 border border-slate-200 rounded-2xl px-6 py-4 text-sm font-bold text-slate-700 outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-50 transition-all" autocomplete="off">
                        <button type="submit" class="w-14 bg-blue-600 text-white rounded-2xl flex items-center justify-center shadow-lg hover:bg-blue-700 active:scale-90 transition-all"><i class="fas fa-paper-plane text-lg"></i></button>
                    </form>
                </div>
            </div>

            <!-- VISTA: ADMIN TABLA -->
            <div id="view-table" class="view-section hidden-ui h-full flex flex-col">
                <div class="mb-4 sticky top-0 bg-[#f8fafc] z-10 py-2 flex gap-2">
                    <input type="text" id="table-search" placeholder="Filtrar registros..." class="form-input max-w-sm shadow-sm" onkeyup="filterList()">
                    <button onclick="renderList(document.body.dataset.viewType)" class="w-10 h-10 bg-white border border-slate-300 rounded-lg flex items-center justify-center text-slate-500 hover:text-blue-600"><i class="fas fa-sync-alt"></i></button>
                </div>
                <div id="table-content" class="space-y-2 pb-20 overflow-y-auto w-full">
                    <div class="text-center py-10 text-slate-400 italic">Cargando datos...</div>
                </div>
            </div>
        </main>
    </div>

    <!-- MODAL REGISTRO -->
    <div id="modal-capture" class="overlay hidden-ui">
        <div class="modal">
            <div class="p-5 border-b flex justify-between items-center bg-slate-50">
                <h3 class="font-bold text-slate-800">Nuevo Registro</h3>
                <button onclick="closeModal('modal-capture')" class="text-slate-400 hover:text-red-500"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 overflow-y-auto bg-white flex-1">
                <div class="mb-6">
                    <label class="form-label">Tipo de Registro</label>
                    <div class="grid grid-cols-3 gap-3">
                        <button type="button" onclick="setFormType('CERTIFICADO')" class="type-btn p-3 border rounded-xl text-xs font-bold text-center hover:bg-blue-50 focus:ring-2 ring-blue-500"><i class="fas fa-certificate block text-xl mb-1 text-blue-500"></i> Certificado</button>
                        <button type="button" onclick="setFormType('EXTENSION')" class="type-btn p-3 border rounded-xl text-xs font-bold text-center hover:bg-emerald-50 focus:ring-2 ring-emerald-500"><i class="fas fa-address-book block text-xl mb-1 text-emerald-500"></i> Extensión</button>
                        <button type="button" onclick="setFormType('MANUAL')" class="type-btn p-3 border rounded-xl text-xs font-bold text-center hover:bg-slate-100 focus:ring-2 ring-slate-500"><i class="fas fa-book block text-xl mb-1 text-slate-500"></i> Manual</button>
                    </div>
                    <input type="hidden" id="current-type" value="MANUAL">
                    <input type="hidden" id="editing-id" value="">
                </div>

                <div id="forms-area">
                    <!-- Certificado -->
                    <div id="form-cert" class="hidden space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="form-label">Últimos 4 Dígitos</label><input id="c-num" type="text" class="form-input uppercase" placeholder="Ej. 9A3F" maxlength="4"></div>
                            <div><label class="form-label">Negocio</label><select id="c-neg" class="form-input"><option>SPEI</option><option>CODI</option><option>DIMO</option><option>SPID</option><option>BDT</option><option>R2</option></select></div>
                            <div><label class="form-label">Entorno</label><select id="c-env" class="form-input"><option>PRODUCCION</option><option>BETA</option></select></div>
                            <div><label class="form-label">Estatus (Libre)</label><input type="text" id="c-stat" class="form-input" placeholder="Ej. Vigente, Revocado..."></div>
                            <div><label class="form-label">Vigencia Inicio</label><input id="c-ini" type="date" class="form-input"></div>
                            <div><label class="form-label">Vigencia Fin</label><input id="c-fin" type="date" class="form-input"></div>
                            <select id="c-type" class="form-input col-span-2"><option>PRIVADO (.key)</option><option>PUBLICO (.cer)</option></select>
                        </div>
                    </div>
                    <!-- Extensión -->
                    <div id="form-ext" class="hidden space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="form-label">Extensión</label><input id="e-num" type="text" class="form-input" placeholder="1234"></div>
                            <div><label class="form-label">Nombre Persona</label><input id="e-nom" type="text" class="form-input" placeholder="Nombre completo"></div>
                            <div class="col-span-2"><label class="form-label">Área / Rol</label><input id="e-area" type="text" class="form-input" placeholder="Ej. Operaciones SPEI N1"></div>
                        </div>
                    </div>
                    <!-- Manual -->
                    <div id="form-doc" class="hidden space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                             <div><label class="form-label">Tipo</label><select id="d-type" class="form-input"><option>Manual</option><option>Procedimiento</option><option>Política</option><option>Reporte</option></select></div>
                             <div><label class="form-label">Prioridad</label><select id="d-prio" class="form-input"><option value="1">Alta</option><option value="2">Media</option><option value="3">Baja</option></select></div>
                        </div>
                        <div><label class="form-label">Título</label><input id="d-title" type="text" class="form-input"></div>
                        <div><label class="form-label">Contenido</label><textarea id="d-content" class="form-input h-32"></textarea></div>
                    </div>
                </div>
            </div>
            <div class="p-5 border-t bg-slate-50 flex justify-end gap-3">
                <button onclick="closeModal('modal-capture')" class="text-slate-500 font-bold text-xs px-4">Cancelar</button>
                <button onclick="saveRegistry()" class="bg-slate-900 text-white px-6 py-2.5 rounded-xl font-bold text-xs shadow-lg hover:bg-blue-600 transition-all">GUARDAR</button>
            </div>
        </div>
    </div>

    <!-- MODAL CARGA -->
    <div id="modal-upload" class="overlay hidden-ui">
        <div class="modal max-w-lg">
            <div class="p-5 border-b bg-slate-50"><h3 class="font-bold">Cargar Archivo</h3></div>
            <div class="p-8 text-center">
                <p class="text-xs text-slate-500 mb-4 text-left">
                    <b>Carga Masiva:</b> Sube un CSV/Excel con las columnas TIPO, TITULO, CONTENIDO, NUMERO, etc. para llenar la base.<br>
                    <button onclick="window.downloadTemplate()" class="text-blue-500 hover:underline mt-1 font-bold">Descargar Plantilla CSV</button>
                </p>
                <div class="border-2 border-dashed border-slate-300 rounded-xl p-10 cursor-pointer hover:bg-slate-50 transition-colors" onclick="document.getElementById('file-in').click()">
                    <i class="fas fa-cloud-upload-alt text-4xl text-blue-400 mb-3"></i>
                    <p class="text-sm font-bold text-slate-600">Clic para seleccionar</p>
                    <p class="text-xs text-slate-400">PDF, Excel, Imágenes, Texto</p>
                </div>
                <input type="file" id="file-in" class="hidden" onchange="handleFile(this)">
            </div>
            <div class="p-5 border-t flex justify-end">
                <button onclick="closeModal('modal-upload')" class="text-slate-400 font-bold text-xs">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- MODAL USUARIO -->
    <div id="modal-user" class="overlay hidden-ui">
        <div class="modal max-w-sm">
             <div class="p-5 border-b bg-slate-50"><h3 class="font-bold">Nuevo Usuario</h3></div>
             <div class="p-6 space-y-4">
                 <input id="u-name" class="form-input" placeholder="Nombre">
                 <input id="u-id" class="form-input" placeholder="ID Empleado">
                 <select id="u-role" class="form-input"><option value="user">Usuario Operativo</option><option value="admin">Administrador</option></select>
                 <button onclick="saveUser()" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg font-bold text-xs mt-4">Crear</button>
             </div>
             <div class="p-4 text-center"><button onclick="closeModal('modal-user')" class="text-slate-400 text-xs">Cancelar</button></div>
        </div>
    </div>

    <script type="module">
        const apiKey = "AIzaSyDraEnCKuwnicZVQ-aOcYYwMIPiuadcVgU";
        const { auth, db, appId, doc, setDoc, collection, onSnapshot, deleteDoc, signInAnonymously, onAuthStateChanged, writeBatch } = window.fb;
        
        let currentUser = null;
        let knowledgeBase = [];
        let team = [];
        let chatHistory = [];

        // --- FUNCIONES GLOBALES ---
        window.toast = (m, e) => {
            const t = document.getElementById('toast');
            if (t) {
                t.innerText = m;
                t.className = `fixed top-6 left-1/2 -translate-x-1/2 px-6 py-3 rounded-full text-xs font-black uppercase shadow-2xl z-[10002] transition-all duration-300 opacity-100 ${e?'bg-red-500 text-white':'bg-emerald-500 text-white'}`;
                setTimeout(() => t.classList.remove('opacity-100'), 3000);
            }
        };

        window.downloadTemplate = () => {
             const csvContent = "TIPO,TITULO,CONTENIDO,NUMERO,NEGOCIO,ENTORNO,ESTATUS,INICIO,FIN,EXTENSION,NOMBRE,AREA,PRIORIDAD\nCERTIFICADO,,,9A3F,SPEI,PRODUCCION,VIGENTE,2024-01-01,2026-12-31,,,1\nEXTENSION,,,,,,,,,5522,Juan Pérez,Soporte N1,1\nMANUAL,Guía de Conexión,Paso 1: Verificar VPN...,,,,,,,,2";
             const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
             const link = document.createElement("a");
             link.href = URL.createObjectURL(blob);
             link.download = "layout_spei_ops.csv";
             link.click();
        };

        window.toggleSidebar = () => {
            document.getElementById('sidebar').classList.toggle('open');
            const backdrop = document.getElementById('sidebar-backdrop');
            if(backdrop) backdrop.style.display = document.getElementById('sidebar').classList.contains('open') ? 'block' : 'none';
        };

        window.handleLogin = () => {
            const idInput = document.getElementById('login-id');
            if (!idInput) return;
            const id = idInput.value.trim();
            if(id === "682930") {
                const adminUser = { name: "Daniel Anzaldo", role: "admin", empNumber: "682930" };
                login(adminUser);
                if(!team.find(u => u.empNumber === "682930")) {
                    setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'team', '682930'), adminUser).catch(console.error);
                }
                return;
            }
            const user = team.find(u => u.empNumber === id);
            if (user) login(user); 
            else {
                const err = document.getElementById('login-msg');
                if(err) { err.style.opacity = "1"; setTimeout(() => err.style.opacity = "0", 2000); }
            }
        };

        window.logout = () => { localStorage.removeItem('spei_v23_0_session'); location.reload(); };

        window.navigate = (view) => {
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            const chatView = document.getElementById('view-chat');
            const tableView = document.getElementById('view-table');
            const title = document.getElementById('page-title');
            const actions = document.getElementById('header-actions');

            if(view === 'chat') {
                document.getElementById('nav-chat').classList.add('active');
                chatView.classList.remove('hidden-ui');
                tableView.classList.add('hidden-ui');
                title.innerText = "Chat Operativo";
                actions.innerHTML = "";
            } else if (view === 'admin-users') {
                document.getElementById('nav-users').classList.add('active');
                chatView.classList.add('hidden-ui');
                tableView.classList.remove('hidden-ui');
                title.innerText = "Usuarios";
                document.body.dataset.viewType = "USERS";
                actions.innerHTML = `<button onclick="document.getElementById('modal-user').classList.remove('hidden-ui')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-xs font-bold shadow-sm transition-all"><i class="fas fa-plus"></i> Usuario</button>`;
                renderList('USERS');
            } else {
                let type = 'MANUAL';
                let label = 'Manuales';
                let navId = 'nav-docs';

                if(view === 'admin-cert') { type = 'CERTIFICADO'; label = 'Certificados'; navId = 'nav-cert'; }
                if(view === 'admin-ext') { type = 'EXTENSION'; label = 'Directorio'; navId = 'nav-ext'; }
                if(view === 'admin-files') { type = 'ARCHIVO'; label = 'Archivos'; navId = 'nav-files'; }
                if(view === 'admin-all') { type = 'ALL'; label = 'Base Completa'; navId = 'nav-all'; }

                document.getElementById(navId)?.classList.add('active');
                chatView.classList.add('hidden-ui');
                tableView.classList.remove('hidden-ui');
                title.innerText = label;
                document.body.dataset.viewType = type;
                
                if (view !== 'admin-files' && view !== 'admin-all') {
                     actions.innerHTML = `<button onclick="window.openModal('modal-capture')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-xs font-bold shadow-sm transition-all"><i class="fas fa-plus"></i> Nuevo</button>`;
                } else if(view === 'admin-files') {
                     actions.innerHTML = `<button onclick="window.openUploadModal()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg text-xs font-bold shadow-sm transition-all"><i class="fas fa-upload"></i> Cargar</button>`;
                } else {
                    actions.innerHTML = "";
                }
                
                renderList(type);
            }
            if(window.innerWidth < 768) window.toggleSidebar();
        };

        window.openModal = (id = 'modal-capture') => {
            document.getElementById(id).classList.remove('hidden-ui');
            if(id === 'modal-capture') {
                const currentView = document.body.dataset.viewType;
                const validType = (currentView === 'CERTIFICADO' || currentView === 'EXTENSION') ? currentView : 'MANUAL';
                window.setFormType(validType);
                document.getElementById('editing-id').value = "";
            }
        };
        window.openUploadModal = () => window.openModal('modal-upload');
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden-ui');

        window.setFormType = (type) => {
            document.getElementById('current-type').value = type;
            document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('bg-blue-50', 'border-blue-500'));
            ['form-cert', 'form-ext', 'form-doc'].forEach(f => document.getElementById(f).classList.add('hidden'));
            
            if(type === 'CERTIFICADO') document.getElementById('form-cert').classList.remove('hidden');
            else if(type === 'EXTENSION') document.getElementById('form-ext').classList.remove('hidden');
            else document.getElementById('form-doc').classList.remove('hidden');
        };

        window.saveRegistry = async () => {
            const type = document.getElementById('current-type').value;
            const editId = document.getElementById('editing-id').value;
            const id = editId || "doc_" + Date.now();
            let data = { contentType: type, date: new Date().toISOString(), author: currentUser.name };

            if(type === 'CERTIFICADO') {
                const num = document.getElementById('c-num').value.trim().toUpperCase();
                if(num.length !== 4) return alert("El certificado debe tener 4 dígitos");
                data.title = `CERT ${num} (${document.getElementById('c-neg').value})`;
                data.content = `CERT ${num}`; 
                data.negocio = document.getElementById('c-neg').value;
                data.entorno = document.getElementById('c-env').value;
                data.estatus = document.getElementById('c-stat').value;
                data.vigenciaInicio = document.getElementById('c-ini').value;
                data.vigenciaFin = document.getElementById('c-fin').value;
                data.tipoCert = document.getElementById('c-type').value;
                data.num = num;
            } else if (type === 'EXTENSION') {
                const ext = document.getElementById('e-num').value.trim();
                if(!ext) return window.toast("Falta extensión", true);
                data.title = `EXT ${ext}`;
                data.content = `EXTENSION ${ext}`;
                data.ext = ext;
                data.nombre = document.getElementById('e-nom').value;
                data.area = document.getElementById('e-area').value;
            } else {
                data.title = document.getElementById('d-title').value;
                data.content = document.getElementById('d-content').value;
                if(!data.title) return window.toast("Falta título", true);
            }

            try {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'knowledge', id), data, {merge:true});
                window.toast("Guardado");
                window.closeModal('modal-capture');
                document.querySelectorAll('input,textarea').forEach(i => i.value='');
                const currentView = document.body.dataset.viewType;
                if(currentView) renderList(currentView);
            } catch(e) { window.toast("Error al guardar", true); console.error(e); }
        };

        window.deleteRec = async (id) => {
            if(confirm("¿Estás seguro de eliminar este registro permanentemente?")) {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'knowledge', id));
                const currentView = document.body.dataset.viewType;
                if(currentView) renderList(currentView);
            }
        };

        window.saveUser = async () => {
            const name = document.getElementById('u-name').value;
            const id = document.getElementById('u-id').value;
            if(!name) return window.toast("Datos faltantes", true);
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'team', id), { name: name, empNumber: id, role: document.getElementById('u-role').value });
            window.toast("Usuario Creado");
            document.getElementById('modal-user').classList.add('hidden-ui');
            renderList('USERS');
        };
        
        window.deleteUser = async (id) => {
            if(id === '682930') return alert("No se puede borrar al Admin Principal");
            if(confirm("¿Eliminar usuario?")) {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'team', id));
                renderList('USERS');
            }
        };
        
        // CARGA MASIVA EXCEL + ARCHIVOS
        window.handleFile = async (input) => {
            const f = input.files[0]; if(!f) return;
            
            // Si es CSV/Excel y estamos en modo layout
            if(f.name.endsWith('.csv') || f.name.endsWith('.xlsx')) {
                 const reader = new FileReader();
                 reader.onload = async (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        const sheet = workbook.Sheets[workbook.SheetNames[0]];
                        const json = XLSX.utils.sheet_to_json(sheet);
                        
                        const batch = window.fb.writeBatch(db);
                        let count = 0;
                        json.forEach(row => {
                            const id = "imp_" + Date.now() + "_" + Math.random().toString(36).substr(2, 5);
                            const ref = doc(db, 'artifacts', appId, 'public', 'data', 'knowledge', id);
                            // Mapeo
                            let entry = {
                                contentType: (row.TIPO || 'MANUAL').toUpperCase(),
                                date: new Date().toISOString(),
                                author: currentUser.name,
                                title: row.TITULO || `Importado ${row.TIPO}`,
                                content: row.CONTENIDO || ''
                            };
                            // (Mismo mapeo detallado que v22.0)
                            if(entry.contentType === 'CERTIFICADO') { entry.num=row.NUMERO; entry.negocio=row.NEGOCIO; entry.entorno=row.ENTORNO; entry.estatus=row.ESTATUS; entry.vigenciaFin=row.FIN; entry.title=`CERT ${entry.num} (${entry.negocio})`; }
                            else if(entry.contentType === 'EXTENSION') { entry.ext=row.EXTENSION; entry.nombre=row.NOMBRE; entry.area=row.AREA; entry.title=`EXT ${entry.ext}`; }
                            
                            batch.set(ref, entry);
                            count++;
                        });
                        await batch.commit();
                        window.toast(`Importados ${count} registros`);
                        window.closeModal('modal-upload');
                    } catch(err){ window.toast("Error procesando Excel", true); }
                 };
                 reader.readAsArrayBuffer(f);
            } else {
                 // Carga normal de archivo (texto/pdf)
                 const txt = await f.text();
                 const id = "file_" + Date.now();
                 await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'knowledge', id), {
                     contentType: "ARCHIVO", title: f.name, content: txt, date: new Date().toISOString()
                 });
                 window.toast("Archivo cargado");
                 window.closeModal('modal-upload');
            }
        };

        window.filterList = () => {
             const term = document.getElementById('table-search').value.toLowerCase();
             const currentView = document.body.dataset.viewType;
             renderList(currentView, term);
        };
        
        window.editEntry = (id) => {
            const e = knowledgeBase.find(x => x.id === id); if(!e) return;
            window.openModal('modal-capture');
            window.setFormType(e.contentType || 'MANUAL');
            document.getElementById('editing-id').value = id;
            if(e.contentType === 'MANUAL') { document.getElementById('d-title').value = e.title; document.getElementById('d-content').value = e.content; }
        };

        // --- RENDER ROBUSTO ---
        function renderList(type, term = "") {
            const list = document.getElementById('table-content');
            if(!list) return;
            
            let html = "";
            
            try {
                if(type === 'USERS') {
                    let data = team;
                    if(term) data = data.filter(u => u.name.toLowerCase().includes(term) || u.empNumber.includes(term));
                    html = data.map(u => `
                        <div class="data-card">
                            <div><div class="font-bold text-sm">${u.name}</div><div class="text-xs text-slate-500">${u.empNumber} • ${u.role}</div></div>
                            <button onclick="deleteUser('${u.empNumber}')" class="text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button>
                        </div>`).join('');
                } else {
                    let data = knowledgeBase;
                    if(type !== 'ALL') {
                        data = knowledgeBase.filter(k => k.contentType === type);
                    }
                    
                    if(term) data = data.filter(d => 
                        (d.title || "").toLowerCase().includes(term) || 
                        (d.content || "").toLowerCase().includes(term) ||
                        (d.nombre || "").toLowerCase().includes(term) ||
                        (d.negocio || "").toLowerCase().includes(term) ||
                        (d.ext || "").toLowerCase().includes(term) ||
                        (d.area || "").toLowerCase().includes(term)
                    );

                    if (data.length === 0) {
                        html = `<div class="text-center py-10 text-slate-400 italic text-sm">No se encontraron registros.</div>`;
                    } else {
                        html = data.map(item => {
                            let desc = item.content || "Sin contenido";
                            if (item.contentType === 'CERTIFICADO') {
                                desc = `${item.negocio || 'N/A'} - ${item.estatus || 'N/A'}`;
                            } else if (item.contentType === 'EXTENSION') {
                                desc = `${item.nombre || ''} - ${item.area || ''}`;
                            }
                            let dateStr = "";
                            try { dateStr = item.date ? new Date(item.date).toLocaleDateString() : 'Sin fecha'; } catch(e) { dateStr = "Error fecha"; }
                            
                            return `
                            <div class="data-card">
                                <div class="overflow-hidden w-full">
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="badge ${item.contentType==='CERTIFICADO'?'badge-cert':(item.contentType==='EXTENSION'?'badge-ext':'badge-doc')}">${item.contentType || 'DOC'}</span>
                                        <span class="text-[9px] text-slate-400">${dateStr}</span>
                                    </div>
                                    <h4 class="font-bold text-sm text-slate-800 truncate">${item.title || 'Sin título'}</h4>
                                    <p class="text-xs text-slate-500 line-clamp-1">${desc}</p>
                                </div>
                                <div class="flex gap-2 shrink-0 ml-4">
                                    <button onclick="editEntry('${item.id}')" class="w-8 h-8 rounded bg-blue-50 text-blue-500 hover:bg-blue-100 flex items-center justify-center transition-colors"><i class="fas fa-pen"></i></button>
                                    <button onclick="deleteRec('${item.id}')" class="w-8 h-8 rounded bg-red-50 text-red-500 hover:bg-red-100 flex items-center justify-center transition-colors"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                        `;}).join('');
                    }
                }
            } catch (err) {
                console.error(err);
                html = `<div class="text-center py-10 text-red-400 italic text-sm">Error al mostrar datos. Intenta recargar.</div>`;
            }
            list.innerHTML = html;
        }

        // --- CHAT DETALLADO ---
        function format(t) { return t.replace(/REGISTRO:|CONTENIDO:|\[.*?\]|\|/g, "").replace(/###/g, "").trim().replace(/\n/g, '<br>'); }
        
        async function askGemini(q) {
            const kb = knowledgeBase.map(k => `[${k.contentType}] ${k.title}: ${k.content || k.negocio || k.nombre}`).join('\n\n');
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: `Eres experto SPEI. Base: ${kb}. Pregunta: ${q}. Responde breve.` }] }] })
                });
                const d = await res.json();
                return d.candidates?.[0]?.content?.parts?.[0]?.text || "Sin respuesta.";
            } catch { return "Error técnico."; }
        }

        document.getElementById('chat-form').onsubmit = async (e) => {
            e.preventDefault(); const inp = document.getElementById('chat-input'); const q = inp.value.trim(); if(!q) return;
            inp.value = ""; addBubble(q, true);
            
            // BÚSQUEDA PROFUNDA EN TODOS LOS CAMPOS
            const hits = knowledgeBase.filter(k => {
                const text = (k.title + " " + (k.content || "") + " " + (k.nombre || "") + " " + (k.negocio || "") + " " + (k.ext || "") + " " + (k.area || "")).toLowerCase();
                return text.includes(q.toLowerCase());
            });

            let responseHTML = "";
            
            if(hits.length > 0) {
                hits.forEach(item => {
                    if (item.contentType === 'CERTIFICADO') {
                        responseHTML += `
                        <div class="bg-blue-50 p-4 rounded-xl mb-3 text-xs border border-blue-100 shadow-sm">
                            <div class="flex items-center gap-2 mb-2 font-black text-blue-800 uppercase">
                                <i class="fas fa-certificate"></i> ${item.title || 'Certificado'}
                            </div>
                            <div class="grid grid-cols-2 gap-2 text-slate-600">
                                <div><span class="font-bold block text-[10px] text-blue-400">Negocio</span>${item.negocio || 'N/A'}</div>
                                <div><span class="font-bold block text-[10px] text-blue-400">Entorno</span>${item.entorno || 'N/A'}</div>
                                <div><span class="font-bold block text-[10px] text-blue-400">Vigencia</span>${item.vigenciaFin || 'N/A'}</div>
                                <div><span class="font-bold block text-[10px] text-blue-400">Estatus</span><span class="${(item.estatus||'').includes('VIGENTE') ? 'text-emerald-600' : 'text-red-500'} font-bold">${item.estatus || 'N/A'}</span></div>
                            </div>
                        </div>`;
                    } else if (item.contentType === 'EXTENSION') {
                        responseHTML += `
                        <div class="flex items-center gap-4 bg-emerald-50 p-3 rounded-xl mb-2 border border-emerald-100 shadow-sm">
                            <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center text-emerald-600 text-lg shadow-sm"><i class="fas fa-phone"></i></div>
                            <div>
                                <div class="font-black text-lg text-slate-800">${item.ext || 'N/A'}</div>
                                <div class="text-xs font-bold text-emerald-700">${item.nombre || 'Sin nombre'}</div>
                                <div class="text-[10px] text-slate-500 uppercase font-bold tracking-wide">${item.area || ''}</div>
                            </div>
                        </div>`;
                    } else {
                        responseHTML += `
                        <div class="bg-white p-3 border border-slate-200 rounded-lg mb-2 text-xs shadow-sm">
                            <div class="font-bold text-slate-800 mb-1 flex items-center gap-2"><i class="fas fa-file-alt text-blue-500"></i> ${item.title || 'Documento'}</div>
                            <div class="text-slate-500 leading-relaxed whitespace-pre-wrap">${item.content || ''}</div>
                        </div>`;
                    }
                });
            } else {
                const aiRes = await askGemini(q);
                responseHTML = `<div class="ai-suggestion"><div class="res-header"><i class="fas fa-robot text-purple-500"></i> Sugerencia IA</div>${format(aiRes)}</div>`;
            }
            
            addBubble(responseHTML, false, true);
        };
        
        function addBubble(html, isUser, isHtml=false) {
            const box = document.getElementById('chat-box');
            const d = document.createElement('div'); d.className = `msg-group flex w-full ${isUser?'justify-end':'justify-start'}`;
            d.innerHTML = `<div class="${isUser?'user-msg':'bot-msg'} chat-bubble shadow-sm text-sm w-full">${isHtml?html:html}</div>`;
            box.appendChild(d); box.scrollTop = box.scrollHeight;
        }

        // --- INIT ---
        function login(user) {
            currentUser = user;
            localStorage.setItem('spei_v23_0_session', JSON.stringify(user));
            document.body.setAttribute('data-role', user.role);
            
            document.getElementById('login-screen').classList.add('hidden-ui');
            document.getElementById('loading-screen').classList.add('hidden-ui');
            document.getElementById('app-layout').classList.remove('hidden-ui');
            
            document.getElementById('user-name-display').innerText = user.name;
            document.getElementById('user-role-display').innerText = user.role === 'admin' ? "ADMINISTRADOR" : "OPERATIVO";
            
            if(user.role !== 'admin') {
                document.querySelectorAll('.admin-only').forEach(el => el.classList.add('hidden-ui'));
            } else {
                document.querySelectorAll('.admin-only').forEach(el => el.classList.remove('hidden-ui'));
            }
        }

        async function init() {
            await signInAnonymously(auth);
            onAuthStateChanged(auth, u => {
                if(u) {
                    onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'team'), s => {
                        team = s.docs.map(d => ({id:d.id, ...d.data()}));
                        if(team.length===0) setDoc(doc(db,'artifacts','chatbot-8d0a3','public','data','team','682930'), {name:"Daniel Anzaldo", role:"admin", empNumber:"682930"});
                        
                        const saved = localStorage.getItem('spei_v23_0_session');
                        if(saved) {
                            const usr = team.find(x => x.empNumber === JSON.parse(saved).empNumber);
                            if(usr) login(usr); else { document.getElementById('loading-screen').classList.add('hidden-ui'); document.getElementById('login-screen').classList.remove('hidden-ui'); }
                        } else {
                            document.getElementById('loading-screen').classList.add('hidden-ui');
                            document.getElementById('login-screen').classList.remove('hidden-ui');
                        }
                    });
                    onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'knowledge'), s => {
                        knowledgeBase = s.docs.map(d => ({id:d.id, ...d.data()}));
                        const adminView = document.getElementById('view-table');
                        if(adminView && !adminView.classList.contains('hidden-ui')) {
                             const currentView = document.body.dataset.viewType;
                             if(currentView) renderList(currentView);
                        }
                    });
                }
            });
        }
        window.addEventListener('load', init);
    </script>
</body>
</html>
