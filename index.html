<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>SPEI Ops - Speikito IA PRO</title>

  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/616/616430.png" />

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
    * { box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

    .layout-container { display: flex; height: 100%; width: 100%; }
    .sidebar { width: 280px; background: #0f172a; color: #94a3b8; display: flex; flex-direction: column; border-right: 1px solid #1e293b; transition: transform 0.3s; flex-shrink: 0; z-index: 50; }
    .sidebar-header { padding: 1.5rem; border-bottom: 1px solid #1e293b; display: flex; align-items: center; gap: 0.75rem; color: white; font-weight: 800; font-size: 1.1rem; }
    .nav-scroll { flex: 1; overflow-y: auto; padding: 1rem 0; }
    .nav-section { font-size: 0.65rem; font-weight: 800; text-transform: uppercase; color: #475569; padding: 1rem 1.5rem 0.5rem; letter-spacing: 0.05em; }
    .nav-item { padding: 0.75rem 1.5rem; cursor: pointer; display: flex; align-items: center; gap: 0.75rem; font-size: 0.85rem; font-weight: 500; transition: all 0.2s; border-left: 3px solid transparent; }
    .nav-item:hover { background: #1e293b; color: white; }
    .nav-item.active { background: #1e293b; color: white; border-left-color: #3b82f6; }

    .main-area { flex: 1; display: flex; flex-direction: column; background: white; position: relative; overflow: hidden; }
    .top-header { height: 4rem; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: space-between; padding: 0 2rem; background: white; z-index: 20; }
    .view-section { flex: 1; overflow-y: auto; padding: 2rem; display: none; height: 100%; flex-direction: column; }
    .view-section.active { display: flex; }
    #view-chat { padding: 0; }

    .chat-box { flex: 1; overflow-y: auto; padding: 2rem; background: #f8fafc; }
    .chat-input-area { padding: 1.5rem 2rem; background: white; border-top: 1px solid #e2e8f0; }
    .chat-bubble { max-width: 85%; padding: 1rem 1.25rem; border-radius: 1rem; font-size: 0.9rem; line-height: 1.6; margin-bottom: 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .user-msg { align-self: flex-end; background: #2563eb; color: white; border-bottom-right-radius: 0; margin-left: auto; }
    .bot-msg { align-self: flex-start; background: white; border: 1px solid #e2e8f0; color: #1e293b; border-bottom-left-radius: 0; width: 100%; }
    .bot-header { font-weight: 800; color: #0f172a; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; border-bottom: 2px solid #e2e8f0; padding-bottom: 0.5rem; }

    .card { background: #ffffff; border: 1px solid #e2e8f0; border-radius: 0.75rem; padding: 0.9rem 1rem; }
    .pill { display:inline-block; font-size: 0.65rem; font-weight: 800; text-transform: uppercase; padding: 0.25rem 0.5rem; border-radius: 999px; background:#eef2ff; color:#3730a3; }
    .muted { color:#64748b; }

    .overlay { position: fixed; inset: 0; background: rgba(15,23,42,0.95); backdrop-filter: blur(4px); z-index: 60; display: flex; align-items: center; justify-content: center; }
    .hidden-ui { display: none !important; opacity: 0; pointer-events: none; }
    #toast { position: fixed; top: 2rem; left: 50%; transform: translateX(-50%); z-index: 10001; padding: 0.75rem 1.5rem; border-radius: 999px; font-weight: 800; font-size: 0.85rem; color: white; background: #0f172a; opacity: 0; pointer-events: none; transition: 0.3s; }
    #toast.show { opacity: 1; top: 3rem; }

    @media (max-width: 768px) {
      .sidebar { position: fixed; height: 100%; transform: translateX(-100%); }
      .sidebar.open { transform: translateX(0); }
    }
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, collection, onSnapshot, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Configuraci√≥n con fallback robusto (NO QUITAR)
    let firebaseConfig;
    try {
      firebaseConfig = JSON.parse(window.__firebase_config);
    } catch (e) {
      firebaseConfig = {
        apiKey: "AIzaSyDPi5pcDL6OL2zCJK_0n3A_RdDGt3U3LVQ",
        authDomain: "chatbot-8d0a3.firebaseapp.com",
        projectId: "chatbot-8d0a3",
        storageBucket: "chatbot-8d0a3.firebasestorage.app",
        messagingSenderId: "390359131739",
        appId: "1:390359131739:web:23373d0ba69b4719bb417e",
      };
    }

    const appId = typeof __app_id !== "undefined" ? __app_id : firebaseConfig.projectId;
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    window.fb = { auth, db, appId, doc, setDoc, collection, onSnapshot, deleteDoc, writeBatch, signInAnonymously, signInWithCustomToken, onAuthStateChanged };
  </script>
</head>

<body>
  <div id="toast">Notificaci√≥n</div>

  <!-- CARGA -->
  <div id="loading-screen" class="overlay">
    <div class="text-center">
      <div class="w-16 h-16 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
      <p class="text-xs font-bold uppercase tracking-widest text-slate-400">Iniciando Sistema...</p>
    </div>
  </div>

  <!-- LOGIN -->
  <div id="login-screen" class="overlay hidden-ui">
    <div class="bg-white p-10 rounded-2xl shadow-2xl w-full max-w-sm text-center">
      <div class="w-16 h-16 bg-slate-900 rounded-2xl mx-auto mb-6 flex items-center justify-center text-white text-3xl"><i class="fas fa-fingerprint"></i></div>
      <h1 class="text-2xl font-black text-slate-900 mb-1">SPEI Ops</h1>
      <p class="text-slate-500 text-xs mb-8 font-bold uppercase tracking-widest">Acceso Corporativo</p>
      <div class="space-y-4">
        <input type="text" id="login-id" placeholder="ID de Empleado" class="w-full px-4 py-3 border border-slate-300 rounded-lg text-center text-lg font-bold tracking-widest" />
        <button onclick="handleLogin()" id="btn-login" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3.5 rounded-lg font-bold shadow-lg transition-all active:scale-95 cursor-pointer">INGRESAR</button>
        <p id="login-msg" class="text-red-500 text-xs font-bold mt-2 opacity-0 transition-opacity">Credenciales Incorrectas</p>
      </div>
      <p class="mt-8 text-[10px] text-slate-400 font-bold uppercase tracking-wider">IA PRO ‚Ä¢ Creado por Daniel Anzaldo</p>
    </div>
  </div>

  <!-- APP -->
  <div id="app-layout" class="layout-container hidden-ui">
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <i class="fas fa-cat text-blue-500 text-xl"></i> SPEI Ops
        <button class="ml-auto md:hidden text-slate-400" onclick="toggleSidebar()"><i class="fas fa-times"></i></button>
      </div>

      <div class="nav-scroll">
        <div class="nav-section">Operaci√≥n</div>
        <div onclick="navigate('chat')" class="nav-item active" id="nav-chat"><i class="fas fa-comments w-5"></i> Speikito</div>
      </div>

      <div class="p-4 border-t border-slate-800">
        <button onclick="logout()" class="w-full bg-slate-800 hover:bg-red-900/50 text-slate-300 hover:text-red-200 py-2 rounded text-xs font-bold transition-all">
          <i class="fas fa-sign-out-alt mr-2"></i>Cerrar Sesi√≥n
        </button>
      </div>
    </aside>

    <main class="main-area">
      <div class="top-header">
        <div class="flex items-center gap-3">
          <button class="md:hidden text-slate-500 text-xl" onclick="toggleSidebar()"><i class="fas fa-bars text-xl"></i></button>
          <h2 class="font-black text-slate-800 text-lg" id="page-title">Chat Operativo</h2>
        </div>
        <div class="flex gap-2" id="header-actions"></div>
      </div>

      <div id="view-chat" class="view-section active">
        <div id="chat-box" class="chat-box space-y-4">
          <div class="bot-msg chat-bubble shadow-sm w-full">
            <div class="bot-header"><i class="fas fa-cat text-blue-600"></i> Speikito IA PRO</div>
            <p class="text-sm text-slate-600">
              Hola üê±. Ahora consulto <b>tu base interna</b> primero, y si hace falta, pregunto a la <b>IA</b> con contexto.
            </p>
            <p class="text-xs text-slate-500 mt-2">
              Tip: si quieres que use la IA aunque no haya match exacto, escribe: <b>"explica:"</b> al inicio.
            </p>
          </div>
        </div>

        <div class="chat-input-area">
          <form id="chat-form" class="relative max-w-5xl mx-auto flex gap-2">
            <input type="text" id="chat-input" placeholder="Ej: ¬øQu√© pasa si me regresa por falta de dato mandatorio?" class="flex-1 bg-slate-50 border border-slate-200 rounded-2xl px-6 py-4 text-sm font-bold text-slate-700 outline-none focus:border-blue-500 transition-all" autocomplete="off" />
            <button type="submit" class="w-14 bg-blue-600 text-white rounded-2xl flex items-center justify-center shadow-lg hover:bg-blue-700 active:scale-90 transition-all"><i class="fas fa-paper-plane text-lg"></i></button>
          </form>
        </div>
      </div>
    </main>
  </div>

  <script type="module">
    const { auth, db, appId, doc, setDoc, collection, onSnapshot, signInAnonymously, onAuthStateChanged, signInWithCustomToken } = window.fb;

    let currentUser = null;
    let knowledgeBase = [];
    const memory = []; // memoria conversacional (√∫ltimos turnos)

    // UI helpers
    window.toast = (m, err) => {
      const t = document.getElementById("toast");
      t.innerText = m;
      t.className = `fixed top-6 left-1/2 -translate-x-1/2 px-6 py-3 rounded-full text-xs font-black shadow-2xl z-[10002] transition-all show ${err ? "bg-red-500" : "bg-emerald-500"} text-white`;
      t.classList.add("show");
      setTimeout(() => t.classList.remove("show"), 2800);
    };
    window.toggleSidebar = () => document.getElementById("sidebar").classList.toggle("open");
    window.navigate = () => {}; // placeholder
    window.logout = () => { localStorage.removeItem("spei_session"); location.reload(); };

    window.handleLogin = () => {
      const val = document.getElementById("login-id").value.trim();
      if (!val) return;
      // demo admin
      if (val === "682930") return login({ name: "Daniel Anzaldo", role: "admin", empNumber: "682930" });
      // cualquier otro entra como user
      return login({ name: "Usuario", role: "user", empNumber: val });
    };

    function addMsg(t, isUser) {
      const d = document.createElement("div");
      d.className = `chat-bubble ${isUser ? "user-msg" : "bot-msg"} shadow-sm`;
      d.innerHTML = t;

      const b = document.getElementById("chat-box");
      const r = document.createElement("div");
      r.className = `flex w-full mb-2 ${isUser ? "justify-end" : "justify-start"}`;
      r.appendChild(d);
      b.appendChild(r);
      b.scrollTop = b.scrollHeight;
    }

    function normalizeText(s) {
      return (s || "")
        .toString()
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
        .toLowerCase()
        .trim();
    }

    // 1) Consulta base interna primero: ranking simple por coincidencia
    function searchInternal(query, limit = 6) {
      const q = normalizeText(query);
      if (!q) return [];

      const tokens = q.split(/\s+/).filter(Boolean).slice(0, 10);

      const scored = knowledgeBase.map(item => {
        const hay = normalizeText(
          (item.title || "") + " " +
          (item.content || "") + " " +
          (item.tema || "") + " " +
          (item.keywords || "") + " " +
          (item.regla || "") + " " +
          (item.capitulo || "")
        );
        let score = 0;
        for (const tok of tokens) {
          if (tok.length < 3) continue;
          if (hay.includes(tok)) score += 2;
        }
        if (hay.includes(q)) score += 6;
        return { item, score };
      }).filter(x => x.score > 0);

      scored.sort((a,b) => b.score - a.score);
      return scored.slice(0, limit).map(x => x.item);
    }

    function renderInternalHits(hits) {
      if (!hits.length) return "";
      const rows = hits.map(h => {
        const type = h.contentType || "MANUAL";
        const title = (h.title || "(sin t√≠tulo)").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        const snippet = (h.content || "").toString().slice(0, 220).replace(/</g, "&lt;").replace(/>/g, "&gt;");
        return `
          <div class="card mt-2">
            <div class="flex items-center justify-between gap-2">
              <span class="pill">${type}</span>
              <span class="text-[10px] text-slate-400 font-bold">${h.regla ? ("Regla " + h.regla) : ""}</span>
            </div>
            <div class="font-extrabold text-sm text-slate-900 mt-2">${title}</div>
            <div class="text-xs text-slate-600 mt-1">${snippet}${(h.content||"").length>220?"‚Ä¶":""}</div>
          </div>
        `;
      }).join("");

      return `
        <div class="mt-2">
          <div class="text-xs font-extrabold text-slate-700 uppercase tracking-widest">Coincidencias en tu base interna</div>
          ${rows}
        </div>
      `;
    }

    // 2) Llamada a IA: SIEMPRE por API en Vercel, pasando contexto interno + memoria
    async function askAI(userQuestion, internalHits) {
      const ctx = internalHits.map(h => {
        const type = h.contentType || "MANUAL";
        const title = h.title || "";
        const content = (h.content || "").toString().slice(0, 900);
        const meta = [
          h.regla ? `Regla:${h.regla}` : "",
          h.capitulo ? `Cap:${h.capitulo}` : "",
          h.tema ? `Tema:${h.tema}` : "",
          type ? `Tipo:${type}` : ""
        ].filter(Boolean).join(" | ");
        return `- ${meta}\n  T√≠tulo: ${title}\n  Contenido: ${content}`;
      }).join("\n\n");

      const mem = memory.slice(-8).map(m => `${m.role.toUpperCase()}: ${m.text}`).join("\n");
      const prompt = `
Eres Speikito IA PRO. Responde en espa√±ol, natural y √∫til.
Reglas:
- Si hay informaci√≥n en CONTEXTO_INTERNO, √∫sala primero y cita el tipo (REGLA_SPEI / CERTIFICADO / EXTENSION / MANUAL) en tu respuesta.
- Si no hay suficiente, explica lo que falte de forma general (sin inventar datos espec√≠ficos).
- No devuelvas JSON ni bloques de c√≥digo a menos que el usuario lo pida expl√≠citamente.
- S√© claro, breve, y propon soluciones/acciones.

MEMORIA_CONVERSACIONAL (resumen):
${mem || "(vac√≠o)"}

CONTEXTO_INTERNO:
${ctx || "(no hay coincidencias internas)"}

PREGUNTA_DEL_USUARIO:
${userQuestion}
      `.trim();

      const res = await fetch("/api/gemini", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ prompt })
      });

      const data = await res.json().catch(() => ({}));
      if (!res.ok) {
        const msg = (data && (data.error || data.message)) ? (data.error || data.message) : "No se pudo consultar la IA.";
        return `‚ùå Error IA (${res.status}): ${msg}`;
      }

      const text = data?.candidates?.[0]?.content?.parts?.[0]?.text;
      return (text && text.trim()) ? text.trim() : "Sin respuesta de IA.";
    }

    function login(u) {
      currentUser = u;
      localStorage.setItem("spei_session", JSON.stringify(u));
      document.getElementById("login-screen").classList.add("hidden-ui");
      document.getElementById("loading-screen").classList.add("hidden-ui");
      document.getElementById("app-layout").classList.remove("hidden-ui");
      window.toast(`Bienvenido ${u.empNumber}`);
    }

    async function initAuth() {
      try {
        if (typeof __initial_auth_token !== "undefined" && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (e) {
        console.error(e);
      }
    }

    async function init() {
      await initAuth();

      onAuthStateChanged(auth, async (u) => {
        if (!u) return;

        // Cargar base interna (knowledge)
        onSnapshot(collection(db, "artifacts", appId, "public", "data", "knowledge"), (s) => {
          knowledgeBase = s.docs.map(d => ({ id: d.id, ...d.data() }));
        });

        // sesi√≥n
        const saved = localStorage.getItem("spei_session");
        if (saved) login(JSON.parse(saved));
        else document.getElementById("login-screen").classList.remove("hidden-ui");

        document.getElementById("loading-screen").classList.add("hidden-ui");
      });

      // Chat submit
      document.getElementById("chat-form").onsubmit = async (e) => {
        e.preventDefault();
        const input = document.getElementById("chat-input");
        const v = (input.value || "").trim();
        if (!v) return;

        input.value = "";
        addMsg(v, true);

        // guardar memoria user
        memory.push({ role: "user", text: v });

        const forceAI = normalizeText(v).startsWith("explica:");
        const query = forceAI ? v.replace(/^explica:\s*/i, "") : v;

        // 1) base interna
        const hits = searchInternal(query, 6);
        const internalBlock = renderInternalHits(hits);

        // 2) si hay hits, muestro primero; luego IA con contexto
        if (hits.length) addMsg(internalBlock, false);

        // 3) IA: si hay hits o usuario fuerza IA, llamo a IA; si no hay hits, igual llamo IA (porque ya lo pediste)
        addMsg(`<div class="muted text-xs font-bold">Consultando IA‚Ä¶</div>`, false);

        const aiText = await askAI(query, hits);

        // reemplazo el √∫ltimo "Consultando IA‚Ä¶" por respuesta real (simple: agrego respuesta)
        addMsg(aiText.replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/\n/g, "<br/>"), false);

        // guardar memoria bot
        memory.push({ role: "assistant", text: aiText });
      };
    }

    window.addEventListener("load", init);
  </script>
</body>
</html>
